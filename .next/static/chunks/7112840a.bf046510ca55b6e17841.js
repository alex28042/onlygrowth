(window.webpackJsonp_N_E=window.webpackJsonp_N_E||[]).push([[4],{CCl1:function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return kl})),n.d(t,"b",(function(){return Nc})),n.d(t,"c",(function(){return mc})),n.d(t,"d",(function(){return qu})),n.d(t,"e",(function(){return Ml})),n.d(t,"f",(function(){return Cc})),n.d(t,"g",(function(){return E})),n.d(t,"h",(function(){return Ac})),n.d(t,"i",(function(){return Fl})),n.d(t,"j",(function(){return Ll})),n.d(t,"k",(function(){return q})),n.d(t,"l",(function(){return th})),n.d(t,"m",(function(){return ye})),n.d(t,"n",(function(){return $})),n.d(t,"o",(function(){return G})),n.d(t,"p",(function(){return Ru})),n.d(t,"q",(function(){return I})),n.d(t,"r",(function(){return Se})),n.d(t,"s",(function(){return p})),n.d(t,"t",(function(){return Nu})),n.d(t,"u",(function(){return Hl})),n.d(t,"v",(function(){return uh})),n.d(t,"w",(function(){return ah})),n.d(t,"x",(function(){return bc})),n.d(t,"y",(function(){return Bu})),n.d(t,"z",(function(){return Ku})),n.d(t,"A",(function(){return Ou})),n.d(t,"B",(function(){return Wl})),n.d(t,"C",(function(){return ih})),n.d(t,"D",(function(){return Sc})),n.d(t,"E",(function(){return Gu})),n.d(t,"F",(function(){return wc})),n.d(t,"G",(function(){return vc})),n.d(t,"H",(function(){return Ec})),n.d(t,"I",(function(){return Sl})),n.d(t,"J",(function(){return El})),n.d(t,"K",(function(){return pc})),n.d(t,"L",(function(){return Zl})),n.d(t,"M",(function(){return Pl})),n.d(t,"N",(function(){return Bl})),n.d(t,"O",(function(){return Kl})),n.d(t,"P",(function(){return Gl})),n.d(t,"Q",(function(){return $l})),n.d(t,"R",(function(){return jl})),n.d(t,"S",(function(){return ch})),n.d(t,"T",(function(){return yl})),n.d(t,"U",(function(){return wl})),n.d(t,"V",(function(){return xc})),n.d(t,"W",(function(){return _c})),n.d(t,"X",(function(){return Yl})),n.d(t,"Y",(function(){return Xl})),n.d(t,"Z",(function(){return gl})),n.d(t,"ab",(function(){return ll})),n.d(t,"bb",(function(){return ju})),n.d(t,"cb",(function(){return $u})),n.d(t,"db",(function(){return sh})),n.d(t,"eb",(function(){return oh})),n.d(t,"fb",(function(){return Ql})),n.d(t,"gb",(function(){return f})),n.d(t,"hb",(function(){return ql})),n.d(t,"ib",(function(){return bl})),n.d(t,"jb",(function(){return Il})),n.d(t,"kb",(function(){return zl})),n.d(t,"lb",(function(){return Tc})),n.d(t,"mb",(function(){return dl}));var r=n("WJvL"),s=n("IuUc"),i=n("5pEQ"),o=n("H9WU"),a=n("j2t6");const u="@firebase/firestore";class c{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}c.UNAUTHENTICATED=new c(null),c.GOOGLE_CREDENTIALS=new c("google-credentials-uid"),c.FIRST_PARTY=new c("first-party-uid"),c.MOCK_USER=new c("mock-user");let l="9.17.1";const h=new i.b("@firebase/firestore");function d(){return h.logLevel}function f(e){h.setLogLevel(e)}function m(e,...t){if(h.logLevel<=i.a.DEBUG){const n=t.map(y);h.debug(`Firestore (${l}): ${e}`,...n)}}function g(e,...t){if(h.logLevel<=i.a.ERROR){const n=t.map(y);h.error(`Firestore (${l}): ${e}`,...n)}}function p(e,...t){if(h.logLevel<=i.a.WARN){const n=t.map(y);h.warn(`Firestore (${l}): ${e}`,...n)}}function y(e){if("string"==typeof e)return e;try{return t=e,JSON.stringify(t)}catch(t){return e}var t}function w(e="Unexpected state"){const t=`FIRESTORE (${l}) INTERNAL ASSERTION FAILED: `+e;throw g(t),new Error(t)}function v(e,t){e||w()}function I(e,t){e||w()}function b(e,t){return e}const T={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class E extends o.c{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class S{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class x{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class _{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable((()=>t(c.UNAUTHENTICATED)))}shutdown(){}}class D{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable((()=>t(this.token.user)))}shutdown(){this.changeListener=null}}class N{constructor(e){this.t=e,this.currentUser=c.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){let n=this.i;const r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let s=new S;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new S,e.enqueueRetryable((()=>r(this.currentUser)))};const i=()=>{const t=s;e.enqueueRetryable((async()=>{await t.promise,await r(this.currentUser)}))},o=e=>{m("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((e=>o(e))),setTimeout((()=>{if(!this.auth){const e=this.t.getImmediate({optional:!0});e?o(e):(m("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new S)}}),0),i()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then((t=>this.i!==e?(m("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(v("string"==typeof t.accessToken),new x(t.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const e=this.auth&&this.auth.getUid();return v(null===e||"string"==typeof e),new c(e)}}class C{constructor(e,t,n,r){this.h=e,this.l=t,this.m=n,this.g=r,this.type="FirstParty",this.user=c.FIRST_PARTY,this.p=new Map}I(){return this.g?this.g():(v(!("object"!=typeof this.h||null===this.h||!this.h.auth||!this.h.auth.getAuthHeaderValueForFirstParty)),this.h.auth.getAuthHeaderValueForFirstParty([]))}get headers(){this.p.set("X-Goog-AuthUser",this.l);const e=this.I();return e&&this.p.set("Authorization",e),this.m&&this.p.set("X-Goog-Iam-Authorization-Token",this.m),this.p}}class k{constructor(e,t,n,r){this.h=e,this.l=t,this.m=n,this.g=r}getToken(){return Promise.resolve(new C(this.h,this.l,this.m,this.g))}start(e,t){e.enqueueRetryable((()=>t(c.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class A{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class R{constructor(e){this.T=e,this.forceRefresh=!1,this.appCheck=null,this.A=null}start(e,t){const n=e=>{null!=e.error&&m("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);const n=e.token!==this.A;return this.A=e.token,m("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable((()=>n(t)))};const r=e=>{m("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.T.onInit((e=>r(e))),setTimeout((()=>{if(!this.appCheck){const e=this.T.getImmediate({optional:!0});e?r(e):m("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then((e=>e?(v("string"==typeof e.token),this.A=e.token,new A(e.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}function V(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let r=0;r<e;r++)n[r]=Math.floor(256*Math.random());return n}class M{static R(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Math.floor(256/e.length)*e.length;let n="";for(;n.length<20;){const r=V(40);for(let s=0;s<r.length;++s)n.length<20&&r[s]<t&&(n+=e.charAt(r[s]%e.length))}return n}}function F(e,t){return e<t?-1:e>t?1:0}function L(e,t,n){return e.length===t.length&&e.every(((e,r)=>n(e,t[r])))}function O(e){return e+"\0"}class q{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new E(T.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new E(T.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new E(T.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new E(T.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return q.fromMillis(Date.now())}static fromDate(e){return q.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new q(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?F(this.nanoseconds,e.nanoseconds):F(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class P{constructor(e){this.timestamp=e}static fromTimestamp(e){return new P(e)}static min(){return new P(new q(0,0))}static max(){return new P(new q(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class U{constructor(e,t,n){void 0===t?t=0:t>e.length&&w(),void 0===n?n=e.length-t:n>e.length-t&&w(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===U.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof U?e.forEach((e=>{t.push(e)})):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),s=t.get(r);if(n<s)return-1;if(n>s)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class B extends U{construct(e,t,n){return new B(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new E(T.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter((e=>e.length>0)))}return new B(t)}static emptyPath(){return new B([])}}const K=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class G extends U{construct(e,t,n){return new G(e,t,n)}static isValidIdentifier(e){return K.test(e)}canonicalString(){return this.toArray().map((e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),G.isValidIdentifier(e)||(e="`"+e+"`"),e))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new G(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;const s=()=>{if(0===n.length)throw new E(T.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new E(T.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new E(T.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?(i=!i,r++):"."!==t||i?(n+=t,r++):(s(),r++)}if(s(),i)throw new E(T.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new G(t)}static emptyPath(){return new G([])}}class ${constructor(e){this.path=e}static fromPath(e){return new $(B.fromString(e))}static fromName(e){return new $(B.fromString(e).popFirst(5))}static empty(){return new $(B.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===B.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return B.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new $(new B(e.slice()))}}class j{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function Q(e){return e.fields.find((e=>2===e.kind))}function z(e){return e.fields.filter((e=>2!==e.kind))}j.UNKNOWN_ID=-1;class W{constructor(e,t){this.fieldPath=e,this.kind=t}}class H{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new H(0,Z.min())}}function Y(e,t){const n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,s=P.fromTimestamp(1e9===r?new q(n+1,0):new q(n,r));return new Z(s,$.empty(),t)}function X(e){return new Z(e.readTime,e.key,-1)}class Z{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new Z(P.min(),$.empty(),-1)}static max(){return new Z(P.max(),$.empty(),-1)}}function J(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=$.comparator(e.documentKey,t.documentKey),0!==n?n:F(e.largestBatchId,t.largestBatchId))}const ee="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class te{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((e=>e()))}}async function ne(e){if(e.code!==T.FAILED_PRECONDITION||e.message!==ee)throw e;m("LocalStore","Unexpectedly lost primary lease")}class re{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e((e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)}),(e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)}))}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&w(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new re(((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}}))}toPromise(){return new Promise(((e,t)=>{this.next(e,t)}))}wrapUserFunction(e){try{const t=e();return t instanceof re?t:re.resolve(t)}catch(e){return re.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction((()=>e(t))):re.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction((()=>e(t))):re.reject(t)}static resolve(e){return new re(((t,n)=>{t(e)}))}static reject(e){return new re(((t,n)=>{n(e)}))}static waitFor(e){return new re(((t,n)=>{let r=0,s=0,i=!1;e.forEach((e=>{++r,e.next((()=>{++s,i&&s===r&&t()}),(e=>n(e)))})),i=!0,s===r&&t()}))}static or(e){let t=re.resolve(!1);for(const n of e)t=t.next((e=>e?re.resolve(e):n()));return t}static forEach(e,t){const n=[];return e.forEach(((e,r)=>{n.push(t.call(this,e,r))})),this.waitFor(n)}static mapArray(e,t){return new re(((n,r)=>{const s=e.length,i=new Array(s);let o=0;for(let a=0;a<s;a++){const u=a;t(e[u]).next((e=>{i[u]=e,++o,o===s&&n(i)}),(e=>r(e)))}}))}static doWhile(e,t){return new re(((n,r)=>{const s=()=>{!0===e()?t().next((()=>{s()}),r):n()};s()}))}}class se{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.P=new S,this.transaction.oncomplete=()=>{this.P.resolve()},this.transaction.onabort=()=>{t.error?this.P.reject(new ae(e,t.error)):this.P.resolve()},this.transaction.onerror=t=>{const n=de(t.target.error);this.P.reject(new ae(e,n))}}static open(e,t,n,r){try{return new se(t,e.transaction(r,n))}catch(e){throw new ae(t,e)}}get v(){return this.P.promise}abort(e){e&&this.P.reject(e),this.aborted||(m("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}V(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){const t=this.transaction.objectStore(e);return new ce(t)}}class ie{constructor(e,t,n){this.name=e,this.version=t,this.S=n,12.2===ie.D(Object(o.q)())&&g("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return m("SimpleDb","Removing database:",e),le(window.indexedDB.deleteDatabase(e)).toPromise()}static C(){if(!Object(o.v)())return!1;if(ie.N())return!0;const e=Object(o.q)(),t=ie.D(e),n=0<t&&t<10,r=ie.k(e),s=0<r&&r<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||n||s)}static N(){var t;return"undefined"!=typeof e&&"YES"===(null===(t=e.env)||void 0===t?void 0:t.O)}static M(e,t){return e.store(t)}static D(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static k(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async F(e){return this.db||(m("SimpleDb","Opening database:",this.name),this.db=await new Promise(((t,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{const n=e.target.result;t(n)},r.onblocked=()=>{n(new ae(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{const r=t.target.error;"VersionError"===r.name?n(new E(T.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new E(T.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new ae(e,r))},r.onupgradeneeded=e=>{m("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);const t=e.target.result;this.S.$(t,r.transaction,e.oldVersion,this.version).next((()=>{m("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.B&&(this.db.onversionchange=e=>this.B(e)),this.db}L(e){this.B=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){const s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.F(e);const t=se.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).next((e=>(t.V(),e))).catch((e=>(t.abort(e),re.reject(e)))).toPromise();return i.catch((()=>{})),await t.v,i}catch(e){const t=e,n="FirebaseError"!==t.name&&i<3;if(m("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class oe{constructor(e){this.q=e,this.U=!1,this.K=null}get isDone(){return this.U}get G(){return this.K}set cursor(e){this.q=e}done(){this.U=!0}j(e){this.K=e}delete(){return le(this.q.delete())}}class ae extends E{constructor(e,t){super(T.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function ue(e){return"IndexedDbTransactionError"===e.name}class ce{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(m("SimpleDb","PUT",this.store.name,e,t),n=this.store.put(t,e)):(m("SimpleDb","PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),le(n)}add(e){return m("SimpleDb","ADD",this.store.name,e,e),le(this.store.add(e))}get(e){return le(this.store.get(e)).next((t=>(void 0===t&&(t=null),m("SimpleDb","GET",this.store.name,e,t),t)))}delete(e){return m("SimpleDb","DELETE",this.store.name,e),le(this.store.delete(e))}count(){return m("SimpleDb","COUNT",this.store.name),le(this.store.count())}W(e,t){const n=this.options(e,t);if(n.index||"function"!=typeof this.store.getAll){const e=this.cursor(n),t=[];return this.H(e,((e,n)=>{t.push(n)})).next((()=>t))}{const e=this.store.getAll(n.range);return new re(((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}}))}}J(e,t){const n=this.store.getAll(e,null===t?void 0:t);return new re(((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}}))}Y(e,t){m("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.X=!1;const r=this.cursor(n);return this.H(r,((e,t,n)=>n.delete()))}Z(e,t){let n;t?n=e:(n={},t=e);const r=this.cursor(n);return this.H(r,t)}tt(e){const t=this.cursor({});return new re(((n,r)=>{t.onerror=e=>{const t=de(e.target.error);r(t)},t.onsuccess=t=>{const r=t.target.result;r?e(r.primaryKey,r.value).next((e=>{e?r.continue():n()})):n()}}))}H(e,t){const n=[];return new re(((r,s)=>{e.onerror=e=>{s(e.target.error)},e.onsuccess=e=>{const s=e.target.result;if(!s)return void r();const i=new oe(s),o=t(s.primaryKey,s.value,i);if(o instanceof re){const e=o.catch((e=>(i.done(),re.reject(e))));n.push(e)}i.isDone?r():null===i.G?s.continue():s.continue(i.G)}})).next((()=>re.waitFor(n)))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.X?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function le(e){return new re(((t,n)=>{e.onsuccess=e=>{const n=e.target.result;t(n)},e.onerror=e=>{const t=de(e.target.error);n(t)}}))}let he=!1;function de(e){const t=ie.D(Object(o.q)());if(t>=12.2&&t<13){const t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){const e=new E("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return he||(he=!0,setTimeout((()=>{throw e}),0)),e}}return e}class fe{constructor(e,t){this.asyncQueue=e,this.et=t,this.task=null}start(){this.nt(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}nt(e){m("IndexBackiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,(async()=>{this.task=null;try{m("IndexBackiller",`Documents written: ${await this.et.st()}`)}catch(e){ue(e)?m("IndexBackiller","Ignoring IndexedDB error during index backfill: ",e):await ne(e)}await this.nt(6e4)}))}}class me{constructor(e,t){this.localStore=e,this.persistence=t}async st(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(t=>this.it(t,e)))}it(e,t){const n=new Set;let r=t,s=!0;return re.doWhile((()=>!0===s&&r>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next((t=>{if(null!==t&&!n.has(t))return m("IndexBackiller",`Processing collection: ${t}`),this.rt(e,t,r).next((e=>{r-=e,n.add(t)}));s=!1})))).next((()=>t-r))}rt(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next((r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next((n=>{const s=n.changes;return this.localStore.indexManager.updateIndexEntries(e,s).next((()=>this.ot(r,n))).next((n=>(m("IndexBackiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n)))).next((()=>s.size))}))))}ot(e,t){let n=e;return t.changes.forEach(((e,t)=>{const r=X(t);J(r,n)>0&&(n=r)})),new Z(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class ge{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ut(e),this.ct=e=>t.writeSequenceNumber(e))}ut(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.ct&&this.ct(e),e}}ge.at=-1;class pe{constructor(e,t,n,r,s,i,o,a){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class ye{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new ye("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof ye&&e.projectId===this.projectId&&e.database===this.database}}function we(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function ve(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function Ie(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}function be(e){return null==e}function Te(e){return 0===e&&1/e==-1/0}function Ee(e){return"number"==typeof e&&Number.isInteger(e)&&!Te(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function Se(){return"undefined"!=typeof atob}class xe{constructor(e){this.binaryString=e}static fromBase64String(e){const t=atob(e);return new xe(t)}static fromUint8Array(e){const t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new xe(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return F(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}xe.EMPTY_BYTE_STRING=new xe("");const _e=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function De(e){if(v(!!e),"string"==typeof e){let t=0;const n=_e.exec(e);if(v(!!n),n[1]){let e=n[1];e=(e+"000000000").substr(0,9),t=Number(e)}const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}return{seconds:Ne(e.seconds),nanos:Ne(e.nanos)}}function Ne(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function Ce(e){return"string"==typeof e?xe.fromBase64String(e):xe.fromUint8Array(e)}function ke(e){var t,n;return"server_timestamp"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function Ae(e){const t=e.mapValue.fields.__previous_value__;return ke(t)?Ae(t):t}function Re(e){const t=De(e.mapValue.fields.__local_write_time__.timestampValue);return new q(t.seconds,t.nanos)}const Ve={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Me={nullValue:"NULL_VALUE"};function Fe(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?ke(e)?4:He(e)?9007199254740991:10:w()}function Le(e,t){if(e===t)return!0;const n=Fe(e);if(n!==Fe(t))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return Re(e).isEqual(Re(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;const n=De(e.timestampValue),r=De(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function(e,t){return Ce(e.bytesValue).isEqual(Ce(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function(e,t){return Ne(e.geoPointValue.latitude)===Ne(t.geoPointValue.latitude)&&Ne(e.geoPointValue.longitude)===Ne(t.geoPointValue.longitude)}(e,t);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return Ne(e.integerValue)===Ne(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){const n=Ne(e.doubleValue),r=Ne(t.doubleValue);return n===r?Te(n)===Te(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return L(e.arrayValue.values||[],t.arrayValue.values||[],Le);case 10:return function(e,t){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(we(n)!==we(r))return!1;for(const s in n)if(n.hasOwnProperty(s)&&(void 0===r[s]||!Le(n[s],r[s])))return!1;return!0}(e,t);default:return w()}}function Oe(e,t){return void 0!==(e.values||[]).find((e=>Le(e,t)))}function qe(e,t){if(e===t)return 0;const n=Fe(e),r=Fe(t);if(n!==r)return F(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return F(e.booleanValue,t.booleanValue);case 2:return function(e,t){const n=Ne(e.integerValue||e.doubleValue),r=Ne(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return Pe(e.timestampValue,t.timestampValue);case 4:return Pe(Re(e),Re(t));case 5:return F(e.stringValue,t.stringValue);case 6:return function(e,t){const n=Ce(e),r=Ce(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){const n=e.split("/"),r=t.split("/");for(let s=0;s<n.length&&s<r.length;s++){const e=F(n[s],r[s]);if(0!==e)return e}return F(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){const n=F(Ne(e.latitude),Ne(t.latitude));return 0!==n?n:F(Ne(e.longitude),Ne(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return function(e,t){const n=e.values||[],r=t.values||[];for(let s=0;s<n.length&&s<r.length;++s){const e=qe(n[s],r[s]);if(e)return e}return F(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===Ve.mapValue&&t===Ve.mapValue)return 0;if(e===Ve.mapValue)return 1;if(t===Ve.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),s=t.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let o=0;o<r.length&&o<i.length;++o){const e=F(r[o],i[o]);if(0!==e)return e;const t=qe(n[r[o]],s[i[o]]);if(0!==t)return t}return F(r.length,i.length)}(e.mapValue,t.mapValue);default:throw w()}}function Pe(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return F(e,t);const n=De(e),r=De(t),s=F(n.seconds,r.seconds);return 0!==s?s:F(n.nanos,r.nanos)}function Ue(e){return Be(e)}function Be(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=De(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?Ce(e.bytesValue).toBase64():"referenceValue"in e?(n=e.referenceValue,$.fromName(n).toString()):"geoPointValue"in e?`geo(${(t=e.geoPointValue).latitude},${t.longitude})`:"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=Be(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const s of t)r?r=!1:n+=",",n+=`${s}:${Be(e.fields[s])}`;return n+"}"}(e.mapValue):w();var t,n}function Ke(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function Ge(e){return!!e&&"integerValue"in e}function $e(e){return!!e&&"arrayValue"in e}function je(e){return!!e&&"nullValue"in e}function Qe(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function ze(e){return!!e&&"mapValue"in e}function We(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return ve(e.mapValue.fields,((e,n)=>t.mapValue.fields[e]=We(n))),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=We(e.arrayValue.values[n]);return t}return Object.assign({},e)}function He(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function Ye(e){return"nullValue"in e?Me:"booleanValue"in e?{booleanValue:!1}:"integerValue"in e||"doubleValue"in e?{doubleValue:NaN}:"timestampValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in e?{stringValue:""}:"bytesValue"in e?{bytesValue:""}:"referenceValue"in e?Ke(ye.empty(),$.empty()):"geoPointValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in e?{arrayValue:{}}:"mapValue"in e?{mapValue:{}}:w()}function Xe(e){return"nullValue"in e?{booleanValue:!1}:"booleanValue"in e?{doubleValue:NaN}:"integerValue"in e||"doubleValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in e?{stringValue:""}:"stringValue"in e?{bytesValue:""}:"bytesValue"in e?Ke(ye.empty(),$.empty()):"referenceValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in e?{arrayValue:{}}:"arrayValue"in e?{mapValue:{}}:"mapValue"in e?Ve:w()}function Ze(e,t){const n=qe(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function Je(e,t){const n=qe(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class et{constructor(e,t){this.position=e,this.inclusive=t}}function tt(e,t,n){let r=0;for(let s=0;s<e.position.length;s++){const i=t[s],o=e.position[s];if(r=i.field.isKeyField()?$.comparator($.fromName(o.referenceValue),n.key):qe(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return r}function nt(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!Le(e.position[n],t.position[n]))return!1;return!0}class rt{}class st extends rt{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new mt(e,t,n):"array-contains"===t?new wt(e,n):"in"===t?new vt(e,n):"not-in"===t?new It(e,n):"array-contains-any"===t?new bt(e,n):new st(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new gt(e,n):new pt(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(qe(t,this.value)):null!==t&&Fe(this.value)===Fe(t)&&this.matchesComparison(qe(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return w()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}getFirstInequalityField(){return this.isInequality()?this.field:null}}class it extends rt{constructor(e,t){super(),this.filters=e,this.op=t,this.ht=null}static create(e,t){return new it(e,t)}matches(e){return ot(this)?void 0===this.filters.find((t=>!t.matches(e))):void 0!==this.filters.find((t=>t.matches(e)))}getFlattenedFilters(){return null!==this.ht||(this.ht=this.filters.reduce(((e,t)=>e.concat(t.getFlattenedFilters())),[])),this.ht}getFilters(){return Object.assign([],this.filters)}getFirstInequalityField(){const e=this.lt((e=>e.isInequality()));return null!==e?e.field:null}lt(e){for(const t of this.getFlattenedFilters())if(e(t))return t;return null}}function ot(e){return"and"===e.op}function at(e){return"or"===e.op}function ut(e){return ct(e)&&ot(e)}function ct(e){for(const t of e.filters)if(t instanceof it)return!1;return!0}function lt(e){if(e instanceof st)return e.field.canonicalString()+e.op.toString()+Ue(e.value);if(ut(e))return e.filters.map((e=>lt(e))).join(",");{const t=e.filters.map((e=>lt(e))).join(",");return`${e.op}(${t})`}}function ht(e,t){return e instanceof st?function(e,t){return t instanceof st&&e.op===t.op&&e.field.isEqual(t.field)&&Le(e.value,t.value)}(e,t):e instanceof it?function(e,t){return t instanceof it&&e.op===t.op&&e.filters.length===t.filters.length&&e.filters.reduce(((e,n,r)=>e&&ht(n,t.filters[r])),!0)}(e,t):void w()}function dt(e,t){const n=e.filters.concat(t);return it.create(n,e.op)}function ft(e){return e instanceof st?function(e){return`${e.field.canonicalString()} ${e.op} ${Ue(e.value)}`}(e):e instanceof it?function(e){return e.op.toString()+" {"+e.getFilters().map(ft).join(" ,")+"}"}(e):"Filter"}class mt extends st{constructor(e,t,n){super(e,t,n),this.key=$.fromName(n.referenceValue)}matches(e){const t=$.comparator(e.key,this.key);return this.matchesComparison(t)}}class gt extends st{constructor(e,t){super(e,"in",t),this.keys=yt("in",t)}matches(e){return this.keys.some((t=>t.isEqual(e.key)))}}class pt extends st{constructor(e,t){super(e,"not-in",t),this.keys=yt("not-in",t)}matches(e){return!this.keys.some((t=>t.isEqual(e.key)))}}function yt(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map((e=>$.fromName(e.referenceValue)))}class wt extends st{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return $e(t)&&Oe(t.arrayValue,this.value)}}class vt extends st{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&Oe(this.value.arrayValue,t)}}class It extends st{constructor(e,t){super(e,"not-in",t)}matches(e){if(Oe(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!Oe(this.value.arrayValue,t)}}class bt extends st{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!$e(t)||!t.arrayValue.values)&&t.arrayValue.values.some((e=>Oe(this.value.arrayValue,e)))}}class Tt{constructor(e,t="asc"){this.field=e,this.dir=t}}function Et(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}class St{constructor(e,t){this.comparator=e,this.root=t||_t.EMPTY}insert(e,t){return new St(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,_t.BLACK,null,null))}remove(e){return new St(this.comparator,this.root.remove(e,this.comparator).copy(null,null,_t.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal(((t,n)=>(e(t,n),!1)))}toString(){const e=[];return this.inorderTraversal(((t,n)=>(e.push(`${t}:${n}`),!1))),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new xt(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new xt(this.root,e,this.comparator,!1)}getReverseIterator(){return new xt(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new xt(this.root,e,this.comparator,!0)}}class xt{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,t&&r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class _t{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:_t.RED,this.left=null!=r?r:_t.EMPTY,this.right=null!=s?s:_t.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new _t(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;const s=n(e,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return _t.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return _t.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,_t.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,_t.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw w();if(this.right.isRed())throw w();const e=this.left.check();if(e!==this.right.check())throw w();return e+(this.isRed()?0:1)}}_t.EMPTY=null,_t.RED=!0,_t.BLACK=!1,_t.EMPTY=new class{constructor(){this.size=0}get key(){throw w()}get value(){throw w()}get color(){throw w()}get left(){throw w()}get right(){throw w()}copy(e,t,n,r,s){return this}insert(e,t,n){return new _t(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Dt{constructor(e){this.comparator=e,this.data=new St(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal(((t,n)=>(e(t),!1)))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new Nt(this.data.getIterator())}getIteratorFrom(e){return new Nt(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach((e=>{t=t.add(e)})),t}isEqual(e){if(!(e instanceof Dt))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const e=[];return this.forEach((t=>{e.push(t)})),e}toString(){const e=[];return this.forEach((t=>e.push(t))),"SortedSet("+e.toString()+")"}copy(e){const t=new Dt(this.comparator);return t.data=e,t}}class Nt{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function Ct(e){return e.hasNext()?e.getNext():void 0}class kt{constructor(e){this.fields=e,e.sort(G.comparator)}static empty(){return new kt([])}unionWith(e){let t=new Dt(G.comparator);for(const n of this.fields)t=t.add(n);for(const n of e)t=t.add(n);return new kt(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return L(this.fields,e.fields,((e,t)=>e.isEqual(t)))}}class At{constructor(e){this.value=e}static empty(){return new At({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!ze(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=We(t)}setAll(e){let t=G.emptyPath(),n={},r=[];e.forEach(((e,s)=>{if(!t.isImmediateParentOf(s)){const e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=s.popLast()}e?n[s.lastSegment()]=We(e):r.push(s.lastSegment())}));const s=this.getFieldsMap(t);this.applyChanges(s,n,r)}delete(e){const t=this.field(e.popLast());ze(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return Le(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];ze(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){ve(t,((t,n)=>e[t]=n));for(const r of n)delete e[r]}clone(){return new At(We(this.value))}}function Rt(e){const t=[];return ve(e.fields,((e,n)=>{const r=new G([e]);if(ze(n)){const e=Rt(n.mapValue).fields;if(0===e.length)t.push(r);else for(const n of e)t.push(r.child(n))}else t.push(r)})),new kt(t)}class Vt{constructor(e,t,n,r,s,i,o){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=s,this.data=i,this.documentState=o}static newInvalidDocument(e){return new Vt(e,0,P.min(),P.min(),P.min(),At.empty(),0)}static newFoundDocument(e,t,n,r){return new Vt(e,1,t,P.min(),n,r,0)}static newNoDocument(e,t){return new Vt(e,2,t,P.min(),P.min(),At.empty(),0)}static newUnknownDocument(e,t){return new Vt(e,3,t,P.min(),P.min(),At.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(P.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=At.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=At.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=P.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof Vt&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new Vt(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Mt{constructor(e,t=null,n=[],r=[],s=null,i=null,o=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.ft=null}}function Ft(e,t=null,n=[],r=[],s=null,i=null,o=null){return new Mt(e,t,n,r,s,i,o)}function Lt(e){const t=b(e);if(null===t.ft){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map((e=>lt(e))).join(","),e+="|ob:",e+=t.orderBy.map((e=>function(e){return e.field.canonicalString()+e.dir}(e))).join(","),be(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((e=>Ue(e))).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((e=>Ue(e))).join(",")),t.ft=e}return t.ft}function Ot(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let n=0;n<e.orderBy.length;n++)if(!Et(e.orderBy[n],t.orderBy[n]))return!1;if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!ht(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!nt(e.startAt,t.startAt)&&nt(e.endAt,t.endAt)}function qt(e){return $.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function Pt(e,t){return e.filters.filter((e=>e instanceof st&&e.field.isEqual(t)))}function Ut(e,t,n){let r=Me,s=!0;for(const i of Pt(e,t)){let e=Me,t=!0;switch(i.op){case"<":case"<=":e=Ye(i.value);break;case"==":case"in":case">=":e=i.value;break;case">":e=i.value,t=!1;break;case"!=":case"not-in":e=Me}Ze({value:r,inclusive:s},{value:e,inclusive:t})<0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];Ze({value:r,inclusive:s},{value:e,inclusive:n.inclusive})<0&&(r=e,s=n.inclusive);break}return{value:r,inclusive:s}}function Bt(e,t,n){let r=Ve,s=!0;for(const i of Pt(e,t)){let e=Ve,t=!0;switch(i.op){case">=":case">":e=Xe(i.value),t=!1;break;case"==":case"in":case"<=":e=i.value;break;case"<":e=i.value,t=!1;break;case"!=":case"not-in":e=Ve}Je({value:r,inclusive:s},{value:e,inclusive:t})>0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];Je({value:r,inclusive:s},{value:e,inclusive:n.inclusive})>0&&(r=e,s=n.inclusive);break}return{value:r,inclusive:s}}class Kt{constructor(e,t=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.dt=null,this._t=null,this.startAt,this.endAt}}function Gt(e,t,n,r,s,i,o,a){return new Kt(e,t,n,r,s,i,o,a)}function $t(e){return new Kt(e)}function jt(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Qt(e){return e.explicitOrderBy.length>0?e.explicitOrderBy[0].field:null}function zt(e){for(const t of e.filters){const e=t.getFirstInequalityField();if(null!==e)return e}return null}function Wt(e){return null!==e.collectionGroup}function Ht(e){const t=b(e);if(null===t.dt){t.dt=[];const e=zt(t),n=Qt(t);if(null!==e&&null===n)e.isKeyField()||t.dt.push(new Tt(e)),t.dt.push(new Tt(G.keyField(),"asc"));else{let e=!1;for(const n of t.explicitOrderBy)t.dt.push(n),n.field.isKeyField()&&(e=!0);if(!e){const e=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";t.dt.push(new Tt(G.keyField(),e))}}}return t.dt}function Yt(e){const t=b(e);if(!t._t)if("F"===t.limitType)t._t=Ft(t.path,t.collectionGroup,Ht(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const s of Ht(t)){const t="desc"===s.dir?"asc":"desc";e.push(new Tt(s.field,t))}const n=t.endAt?new et(t.endAt.position,t.endAt.inclusive):null,r=t.startAt?new et(t.startAt.position,t.startAt.inclusive):null;t._t=Ft(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}return t._t}function Xt(e,t){t.getFirstInequalityField(),zt(e);const n=e.filters.concat([t]);return new Kt(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function Zt(e,t,n){return new Kt(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function Jt(e,t){return Ot(Yt(e),Yt(t))&&e.limitType===t.limitType}function en(e){return`${Lt(Yt(e))}|lt:${e.limitType}`}function tn(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=`, filters: [${e.filters.map((e=>ft(e))).join(", ")}]`),be(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=`, orderBy: [${e.orderBy.map((e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e))).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((e=>Ue(e))).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((e=>Ue(e))).join(",")),`Target(${t})`}(Yt(e))}; limitType=${e.limitType})`}function nn(e,t){return t.isFoundDocument()&&function(e,t){const n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):$.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(const n of Ht(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&function(e,t){return!(e.startAt&&!function(e,t,n){const r=tt(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,Ht(e),t))&&!(e.endAt&&!function(e,t,n){const r=tt(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,Ht(e),t))}(e,t)}function rn(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function sn(e){return(t,n)=>{let r=!1;for(const s of Ht(e)){const e=on(s,t,n);if(0!==e)return e;r=r||s.field.isKeyField()}return 0}}function on(e,t,n){const r=e.field.isKeyField()?$.comparator(t.key,n.key):function(e,t,n){const r=t.data.field(e),s=n.data.field(e);return null!==r&&null!==s?qe(r,s):w()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return w()}}function an(e,t){if(e.wt){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Te(t)?"-0":t}}function un(e){return{integerValue:""+e}}function cn(e,t){return Ee(t)?un(t):an(e,t)}class ln{constructor(){this._=void 0}}function hn(e,t,n){return e instanceof mn?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&(n.fields.__previous_value__=t),{mapValue:n}}(n,t):e instanceof gn?pn(e,t):e instanceof yn?wn(e,t):function(e,t){const n=fn(e,t),r=In(n)+In(e.gt);return Ge(n)&&Ge(e.gt)?un(r):an(e.yt,r)}(e,t)}function dn(e,t,n){return e instanceof gn?pn(e,t):e instanceof yn?wn(e,t):n}function fn(e,t){return e instanceof vn?Ge(n=t)||function(e){return!!e&&"doubleValue"in e}(n)?t:{integerValue:0}:null;var n}class mn extends ln{}class gn extends ln{constructor(e){super(),this.elements=e}}function pn(e,t){const n=bn(t);for(const r of e.elements)n.some((e=>Le(e,r)))||n.push(r);return{arrayValue:{values:n}}}class yn extends ln{constructor(e){super(),this.elements=e}}function wn(e,t){let n=bn(t);for(const r of e.elements)n=n.filter((e=>!Le(e,r)));return{arrayValue:{values:n}}}class vn extends ln{constructor(e,t){super(),this.yt=e,this.gt=t}}function In(e){return Ne(e.integerValue||e.doubleValue)}function bn(e){return $e(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class Tn{constructor(e,t){this.field=e,this.transform=t}}class En{constructor(e,t){this.version=e,this.transformResults=t}}class Sn{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new Sn}static exists(e){return new Sn(void 0,e)}static updateTime(e){return new Sn(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function xn(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class _n{}function Dn(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new On(e.key,Sn.none()):new Rn(e.key,e.data,Sn.none());{const n=e.data,r=At.empty();let s=new Dt(G.comparator);for(let e of t.fields)if(!s.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),s=s.add(e)}return new Vn(e.key,r,new kt(s.toArray()),Sn.none())}}function Nn(e,t,n){e instanceof Rn?function(e,t,n){const r=e.value.clone(),s=Fn(e.fieldTransforms,t,n.transformResults);r.setAll(s),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof Vn?function(e,t,n){if(!xn(e.precondition,t))return void t.convertToUnknownDocument(n.version);const r=Fn(e.fieldTransforms,t,n.transformResults),s=t.data;s.setAll(Mn(e)),s.setAll(r),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function Cn(e,t,n,r){return e instanceof Rn?function(e,t,n,r){if(!xn(e.precondition,t))return n;const s=e.value.clone(),i=Ln(e.fieldTransforms,r,t);return s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null}(e,t,n,r):e instanceof Vn?function(e,t,n,r){if(!xn(e.precondition,t))return n;const s=Ln(e.fieldTransforms,r,t),i=t.data;return i.setAll(Mn(e)),i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map((e=>e.field)))}(e,t,n,r):function(e,t,n){return xn(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}(e,t,n)}function kn(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=fn(r.transform,e||null);null!=s&&(null===n&&(n=At.empty()),n.set(r.field,s))}return n||null}function An(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function(e,t){return void 0===e&&void 0===t||!(!e||!t)&&L(e,t,((e,t)=>function(e,t){return e.field.isEqual(t.field)&&function(e,t){return e instanceof gn&&t instanceof gn||e instanceof yn&&t instanceof yn?L(e.elements,t.elements,Le):e instanceof vn&&t instanceof vn?Le(e.gt,t.gt):e instanceof mn&&t instanceof mn}(e.transform,t.transform)}(e,t)))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class Rn extends _n{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class Vn extends _n{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function Mn(e){const t=new Map;return e.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=e.data.field(n);t.set(n,r)}})),t}function Fn(e,t,n){const r=new Map;v(e.length===n.length);for(let s=0;s<n.length;s++){const i=e[s],o=i.transform,a=t.data.field(i.field);r.set(i.field,dn(o,a,n[s]))}return r}function Ln(e,t,n){const r=new Map;for(const s of e){const e=s.transform,i=n.data.field(s.field);r.set(s.field,hn(e,i,t))}return r}class On extends _n{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class qn extends _n{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Pn{constructor(e){this.count=e}}var Un,Bn;function Kn(e){switch(e){default:return w();case T.CANCELLED:case T.UNKNOWN:case T.DEADLINE_EXCEEDED:case T.RESOURCE_EXHAUSTED:case T.INTERNAL:case T.UNAVAILABLE:case T.UNAUTHENTICATED:return!1;case T.INVALID_ARGUMENT:case T.NOT_FOUND:case T.ALREADY_EXISTS:case T.PERMISSION_DENIED:case T.FAILED_PRECONDITION:case T.ABORTED:case T.OUT_OF_RANGE:case T.UNIMPLEMENTED:case T.DATA_LOSS:return!0}}function Gn(e){if(void 0===e)return g("GRPC error has no .code"),T.UNKNOWN;switch(e){case Un.OK:return T.OK;case Un.CANCELLED:return T.CANCELLED;case Un.UNKNOWN:return T.UNKNOWN;case Un.DEADLINE_EXCEEDED:return T.DEADLINE_EXCEEDED;case Un.RESOURCE_EXHAUSTED:return T.RESOURCE_EXHAUSTED;case Un.INTERNAL:return T.INTERNAL;case Un.UNAVAILABLE:return T.UNAVAILABLE;case Un.UNAUTHENTICATED:return T.UNAUTHENTICATED;case Un.INVALID_ARGUMENT:return T.INVALID_ARGUMENT;case Un.NOT_FOUND:return T.NOT_FOUND;case Un.ALREADY_EXISTS:return T.ALREADY_EXISTS;case Un.PERMISSION_DENIED:return T.PERMISSION_DENIED;case Un.FAILED_PRECONDITION:return T.FAILED_PRECONDITION;case Un.ABORTED:return T.ABORTED;case Un.OUT_OF_RANGE:return T.OUT_OF_RANGE;case Un.UNIMPLEMENTED:return T.UNIMPLEMENTED;case Un.DATA_LOSS:return T.DATA_LOSS;default:return w()}}(Bn=Un||(Un={}))[Bn.OK=0]="OK",Bn[Bn.CANCELLED=1]="CANCELLED",Bn[Bn.UNKNOWN=2]="UNKNOWN",Bn[Bn.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Bn[Bn.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Bn[Bn.NOT_FOUND=5]="NOT_FOUND",Bn[Bn.ALREADY_EXISTS=6]="ALREADY_EXISTS",Bn[Bn.PERMISSION_DENIED=7]="PERMISSION_DENIED",Bn[Bn.UNAUTHENTICATED=16]="UNAUTHENTICATED",Bn[Bn.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Bn[Bn.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Bn[Bn.ABORTED=10]="ABORTED",Bn[Bn.OUT_OF_RANGE=11]="OUT_OF_RANGE",Bn[Bn.UNIMPLEMENTED=12]="UNIMPLEMENTED",Bn[Bn.INTERNAL=13]="INTERNAL",Bn[Bn.UNAVAILABLE=14]="UNAVAILABLE",Bn[Bn.DATA_LOSS=15]="DATA_LOSS";class $n{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[r,s]of n)if(this.equalsFn(r,e))return s}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let s=0;s<r.length;s++)if(this.equalsFn(r[s][0],e))return void(r[s]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){ve(this.inner,((t,n)=>{for(const[r,s]of n)e(r,s)}))}isEmpty(){return Ie(this.inner)}size(){return this.innerSize}}const jn=new St($.comparator);function Qn(){return jn}const zn=new St($.comparator);function Wn(...e){let t=zn;for(const n of e)t=t.insert(n.key,n);return t}function Hn(e){let t=zn;return e.forEach(((e,n)=>t=t.insert(e,n.overlayedDocument))),t}function Yn(){return Zn()}function Xn(){return Zn()}function Zn(){return new $n((e=>e.toString()),((e,t)=>e.isEqual(t)))}const Jn=new St($.comparator),er=new Dt($.comparator);function tr(...e){let t=er;for(const n of e)t=t.add(n);return t}const nr=new Dt(F);function rr(){return nr}class sr{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,ir.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new sr(P.min(),r,rr(),Qn(),tr())}}class ir{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new ir(n,t,tr(),tr(),tr())}}class or{constructor(e,t,n,r){this.It=e,this.removedTargetIds=t,this.key=n,this.Tt=r}}class ar{constructor(e,t){this.targetId=e,this.Et=t}}class ur{constructor(e,t,n=xe.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class cr{constructor(){this.At=0,this.Rt=dr(),this.bt=xe.EMPTY_BYTE_STRING,this.Pt=!1,this.vt=!0}get current(){return this.Pt}get resumeToken(){return this.bt}get Vt(){return 0!==this.At}get St(){return this.vt}Dt(e){e.approximateByteSize()>0&&(this.vt=!0,this.bt=e)}Ct(){let e=tr(),t=tr(),n=tr();return this.Rt.forEach(((r,s)=>{switch(s){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:w()}})),new ir(this.bt,this.Pt,e,t,n)}xt(){this.vt=!1,this.Rt=dr()}Nt(e,t){this.vt=!0,this.Rt=this.Rt.insert(e,t)}kt(e){this.vt=!0,this.Rt=this.Rt.remove(e)}Ot(){this.At+=1}Mt(){this.At-=1}Ft(){this.vt=!0,this.Pt=!0}}class lr{constructor(e){this.$t=e,this.Bt=new Map,this.Lt=Qn(),this.qt=hr(),this.Ut=new Dt(F)}Kt(e){for(const t of e.It)e.Tt&&e.Tt.isFoundDocument()?this.Gt(t,e.Tt):this.Qt(t,e.key,e.Tt);for(const t of e.removedTargetIds)this.Qt(t,e.key,e.Tt)}jt(e){this.forEachTarget(e,(t=>{const n=this.Wt(t);switch(e.state){case 0:this.zt(t)&&n.Dt(e.resumeToken);break;case 1:n.Mt(),n.Vt||n.xt(),n.Dt(e.resumeToken);break;case 2:n.Mt(),n.Vt||this.removeTarget(t);break;case 3:this.zt(t)&&(n.Ft(),n.Dt(e.resumeToken));break;case 4:this.zt(t)&&(this.Ht(t),n.Dt(e.resumeToken));break;default:w()}}))}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Bt.forEach(((e,n)=>{this.zt(n)&&t(n)}))}Jt(e){const t=e.targetId,n=e.Et.count,r=this.Yt(t);if(r){const e=r.target;if(qt(e))if(0===n){const n=new $(e.path);this.Qt(t,n,Vt.newNoDocument(n,P.min()))}else v(1===n);else this.Xt(t)!==n&&(this.Ht(t),this.Ut=this.Ut.add(t))}}Zt(e){const t=new Map;this.Bt.forEach(((n,r)=>{const s=this.Yt(r);if(s){if(n.current&&qt(s.target)){const t=new $(s.target.path);null!==this.Lt.get(t)||this.te(r,t)||this.Qt(r,t,Vt.newNoDocument(t,e))}n.St&&(t.set(r,n.Ct()),n.xt())}}));let n=tr();this.qt.forEach(((e,t)=>{let r=!0;t.forEachWhile((e=>{const t=this.Yt(e);return!t||2===t.purpose||(r=!1,!1)})),r&&(n=n.add(e))})),this.Lt.forEach(((t,n)=>n.setReadTime(e)));const r=new sr(e,t,this.Ut,this.Lt,n);return this.Lt=Qn(),this.qt=hr(),this.Ut=new Dt(F),r}Gt(e,t){if(!this.zt(e))return;const n=this.te(e,t.key)?2:0;this.Wt(e).Nt(t.key,n),this.Lt=this.Lt.insert(t.key,t),this.qt=this.qt.insert(t.key,this.ee(t.key).add(e))}Qt(e,t,n){if(!this.zt(e))return;const r=this.Wt(e);this.te(e,t)?r.Nt(t,1):r.kt(t),this.qt=this.qt.insert(t,this.ee(t).delete(e)),n&&(this.Lt=this.Lt.insert(t,n))}removeTarget(e){this.Bt.delete(e)}Xt(e){const t=this.Wt(e).Ct();return this.$t.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Ot(e){this.Wt(e).Ot()}Wt(e){let t=this.Bt.get(e);return t||(t=new cr,this.Bt.set(e,t)),t}ee(e){let t=this.qt.get(e);return t||(t=new Dt(F),this.qt=this.qt.insert(e,t)),t}zt(e){const t=null!==this.Yt(e);return t||m("WatchChangeAggregator","Detected inactive target",e),t}Yt(e){const t=this.Bt.get(e);return t&&t.Vt?null:this.$t.ne(e)}Ht(e){this.Bt.set(e,new cr),this.$t.getRemoteKeysForTarget(e).forEach((t=>{this.Qt(e,t,null)}))}te(e,t){return this.$t.getRemoteKeysForTarget(e).has(t)}}function hr(){return new St($.comparator)}function dr(){return new St($.comparator)}const fr={asc:"ASCENDING",desc:"DESCENDING"},mr={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},gr={and:"AND",or:"OR"};class pr{constructor(e,t){this.databaseId=e,this.wt=t}}function yr(e,t){return e.wt?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function wr(e,t){return e.wt?t.toBase64():t.toUint8Array()}function vr(e,t){return yr(e,t.toTimestamp())}function Ir(e){return v(!!e),P.fromTimestamp(function(e){const t=De(e);return new q(t.seconds,t.nanos)}(e))}function br(e,t){return function(e){return new B(["projects",e.projectId,"databases",e.database])}(e).child("documents").child(t).canonicalString()}function Tr(e){const t=B.fromString(e);return v($r(t)),t}function Er(e,t){return br(e.databaseId,t.path)}function Sr(e,t){const n=Tr(t);if(n.get(1)!==e.databaseId.projectId)throw new E(T.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new E(T.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new $(Nr(n))}function xr(e,t){return br(e.databaseId,t)}function _r(e){const t=Tr(e);return 4===t.length?B.emptyPath():Nr(t)}function Dr(e){return new B(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function Nr(e){return v(e.length>4&&"documents"===e.get(4)),e.popFirst(5)}function Cr(e,t,n){return{name:Er(e,t),fields:n.value.mapValue.fields}}function kr(e,t,n){const r=Sr(e,t.name),s=Ir(t.updateTime),i=t.createTime?Ir(t.createTime):P.min(),o=new At({mapValue:{fields:t.fields}}),a=Vt.newFoundDocument(r,s,i,o);return n&&a.setHasCommittedMutations(),n?a.setHasCommittedMutations():a}function Ar(e,t){let n;if(t instanceof Rn)n={update:Cr(e,t.key,t.value)};else if(t instanceof On)n={delete:Er(e,t.key)};else if(t instanceof Vn)n={update:Cr(e,t.key,t.data),updateMask:Gr(t.fieldMask)};else{if(!(t instanceof qn))return w();n={verify:Er(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map((e=>function(e,t){const n=t.transform;if(n instanceof mn)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof gn)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof yn)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof vn)return{fieldPath:t.field.canonicalString(),increment:n.gt};throw w()}(0,e)))),t.precondition.isNone||(n.currentDocument=function(e,t){return void 0!==t.updateTime?{updateTime:vr(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:w()}(e,t.precondition)),n}function Rr(e,t){const n=t.currentDocument?function(e){return void 0!==e.updateTime?Sn.updateTime(Ir(e.updateTime)):void 0!==e.exists?Sn.exists(e.exists):Sn.none()}(t.currentDocument):Sn.none(),r=t.updateTransforms?t.updateTransforms.map((t=>function(e,t){let n=null;if("setToServerValue"in t)v("REQUEST_TIME"===t.setToServerValue),n=new mn;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new gn(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new yn(e)}else"increment"in t?n=new vn(e,t.increment):w();const r=G.fromServerFormat(t.fieldPath);return new Tn(r,n)}(e,t))):[];if(t.update){t.update.name;const s=Sr(e,t.update.name),i=new At({mapValue:{fields:t.update.fields}});if(t.updateMask){const e=function(e){const t=e.fieldPaths||[];return new kt(t.map((e=>G.fromServerFormat(e))))}(t.updateMask);return new Vn(s,i,e,n,r)}return new Rn(s,i,n,r)}if(t.delete){const r=Sr(e,t.delete);return new On(r,n)}if(t.verify){const r=Sr(e,t.verify);return new qn(r,n)}return w()}function Vr(e,t){return{documents:[xr(e,t.path)]}}function Mr(e,t){const n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=xr(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=xr(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);const s=function(e){if(0!==e.length)return Kr(it.create(e,"and"))}(t.filters);s&&(n.structuredQuery.where=s);const i=function(e){if(0!==e.length)return e.map((e=>function(e){return{field:Ur(e.field),direction:Or(e.dir)}}(e)))}(t.orderBy);i&&(n.structuredQuery.orderBy=i);const o=function(e,t){return e.wt||be(t)?t:{value:t}}(e,t.limit);var a;return null!==o&&(n.structuredQuery.limit=o),t.startAt&&(n.structuredQuery.startAt={before:(a=t.startAt).inclusive,values:a.position}),t.endAt&&(n.structuredQuery.endAt=function(e){return{before:!e.inclusive,values:e.position}}(t.endAt)),n}function Fr(e){let t=_r(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let s=null;if(r>0){v(1===r);const e=n.from[0];e.allDescendants?s=e.collectionId:t=t.child(e.collectionId)}let i=[];n.where&&(i=function(e){const t=Lr(e);return t instanceof it&&ut(t)?t.getFilters():[t]}(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((e=>function(e){return new Tt(Br(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e))));let a=null;n.limit&&(a=function(e){let t;return t="object"==typeof e?e.value:e,be(t)?null:t}(n.limit));let u=null;n.startAt&&(u=function(e){const t=!!e.before,n=e.values||[];return new et(n,t)}(n.startAt));let c=null;return n.endAt&&(c=function(e){const t=!e.before,n=e.values||[];return new et(n,t)}(n.endAt)),Gt(t,s,o,i,a,"F",u,c)}function Lr(e){return void 0!==e.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":const t=Br(e.unaryFilter.field);return st.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=Br(e.unaryFilter.field);return st.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Br(e.unaryFilter.field);return st.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=Br(e.unaryFilter.field);return st.create(s,"!=",{nullValue:"NULL_VALUE"});default:return w()}}(e):void 0!==e.fieldFilter?function(e){return st.create(Br(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return w()}}(e.fieldFilter.op),e.fieldFilter.value)}(e):void 0!==e.compositeFilter?function(e){return it.create(e.compositeFilter.filters.map((e=>Lr(e))),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return w()}}(e.compositeFilter.op))}(e):w()}function Or(e){return fr[e]}function qr(e){return mr[e]}function Pr(e){return gr[e]}function Ur(e){return{fieldPath:e.canonicalString()}}function Br(e){return G.fromServerFormat(e.fieldPath)}function Kr(e){return e instanceof st?function(e){if("=="===e.op){if(Qe(e.value))return{unaryFilter:{field:Ur(e.field),op:"IS_NAN"}};if(je(e.value))return{unaryFilter:{field:Ur(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(Qe(e.value))return{unaryFilter:{field:Ur(e.field),op:"IS_NOT_NAN"}};if(je(e.value))return{unaryFilter:{field:Ur(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Ur(e.field),op:qr(e.op),value:e.value}}}(e):e instanceof it?function(e){const t=e.getFilters().map((e=>Kr(e)));return 1===t.length?t[0]:{compositeFilter:{op:Pr(e.op),filters:t}}}(e):w()}function Gr(e){const t=[];return e.fields.forEach((e=>t.push(e.canonicalString()))),{fieldPaths:t}}function $r(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}function jr(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t=zr(t)),t=Qr(e.get(n),t);return zr(t)}function Qr(e,t){let n=t;const r=e.length;for(let s=0;s<r;s++){const t=e.charAt(s);switch(t){case"\0":n+="\x01\x10";break;case"\x01":n+="\x01\x11";break;default:n+=t}}return n}function zr(e){return e+"\x01\x01"}function Wr(e){const t=e.length;if(v(t>=2),2===t)return v("\x01"===e.charAt(0)&&"\x01"===e.charAt(1)),B.emptyPath();const n=t-2,r=[];let s="";for(let i=0;i<t;){const t=e.indexOf("\x01",i);switch((t<0||t>n)&&w(),e.charAt(t+1)){case"\x01":const n=e.substring(i,t);let o;0===s.length?o=n:(s+=n,o=s,s=""),r.push(o);break;case"\x10":s+=e.substring(i,t),s+="\0";break;case"\x11":s+=e.substring(i,t+1);break;default:w()}i=t+2}return new B(r)}const Hr=["userId","batchId"];function Yr(e,t){return[e,jr(t)]}function Xr(e,t,n){return[e,jr(t),n]}const Zr={},Jr=["prefixPath","collectionGroup","readTime","documentId"],es=["prefixPath","collectionGroup","documentId"],ts=["collectionGroup","readTime","prefixPath","documentId"],ns=["canonicalId","targetId"],rs=["targetId","path"],ss=["path","targetId"],is=["collectionId","parent"],os=["indexId","uid"],as=["uid","sequenceNumber"],us=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],cs=["indexId","uid","orderedDocumentKey"],ls=["userId","collectionPath","documentId"],hs=["userId","collectionPath","largestBatchId"],ds=["userId","collectionGroup","largestBatchId"],fs=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],ms=[...fs,"documentOverlays"],gs=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],ps=gs,ys=[...ps,"indexConfiguration","indexState","indexEntries"];class ws extends te{constructor(e,t){super(),this.se=e,this.currentSequenceNumber=t}}function vs(e,t){const n=b(e);return ie.M(n.se,t)}class Is{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let r=0;r<this.mutations.length;r++){const t=this.mutations[r];t.key.isEqual(e.key)&&Nn(t,e,n[r])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=Cn(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=Cn(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=Xn();return this.mutations.forEach((r=>{const s=e.get(r.key),i=s.overlayedDocument;let o=this.applyToLocalView(i,s.mutatedFields);o=t.has(r.key)?null:o;const a=Dn(i,o);null!==a&&n.set(r.key,a),i.isValidDocument()||i.convertToNoDocument(P.min())})),n}keys(){return this.mutations.reduce(((e,t)=>e.add(t.key)),tr())}isEqual(e){return this.batchId===e.batchId&&L(this.mutations,e.mutations,((e,t)=>An(e,t)))&&L(this.baseMutations,e.baseMutations,((e,t)=>An(e,t)))}}class bs{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){v(e.mutations.length===n.length);let r=Jn;const s=e.mutations;for(let i=0;i<s.length;i++)r=r.insert(s[i].key,n[i].version);return new bs(e,t,n,r)}}class Ts{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Es{constructor(e,t,n,r,s=P.min(),i=P.min(),o=xe.EMPTY_BYTE_STRING){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(e){return new Es(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(e,t){return new Es(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e)}withLastLimboFreeSnapshotVersion(e){return new Es(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken)}}class Ss{constructor(e){this.ie=e}}function xs(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:_s(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document=function(e,t){return{name:Er(e,t.key),fields:t.data.value.mapValue.fields,updateTime:yr(e,t.version.toTimestamp()),createTime:yr(e,t.createTime.toTimestamp())}}(e.ie,t);else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:Ds(t.version)};else{if(!t.isUnknownDocument())return w();r.unknownDocument={path:n.path.toArray(),version:Ds(t.version)}}return r}function _s(e){const t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function Ds(e){const t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function Ns(e){const t=new q(e.seconds,e.nanoseconds);return P.fromTimestamp(t)}function Cs(e,t){const n=(t.baseMutations||[]).map((t=>Rr(e.ie,t)));for(let i=0;i<t.mutations.length-1;++i){const e=t.mutations[i];if(i+1<t.mutations.length&&void 0!==t.mutations[i+1].transform){const n=t.mutations[i+1];e.updateTransforms=n.transform.fieldTransforms,t.mutations.splice(i+1,1),++i}}const r=t.mutations.map((t=>Rr(e.ie,t))),s=q.fromMillis(t.localWriteTimeMs);return new Is(t.batchId,s,n,r)}function ks(e){const t=Ns(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?Ns(e.lastLimboFreeSnapshotVersion):P.min();let r;var s;return void 0!==e.query.documents?(v(1===(s=e.query).documents.length),r=Yt($t(_r(s.documents[0])))):r=function(e){return Yt(Fr(e))}(e.query),new Es(r,e.targetId,0,e.lastListenSequenceNumber,t,n,xe.fromBase64String(e.resumeToken))}function As(e,t){const n=Ds(t.snapshotVersion),r=Ds(t.lastLimboFreeSnapshotVersion);let s;s=qt(t.target)?Vr(e.ie,t.target):Mr(e.ie,t.target);const i=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:Lt(t.target),readTime:n,resumeToken:i,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:s}}function Rs(e){const t=Fr({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Zt(t,t.limit,"L"):t}function Vs(e,t){return new Ts(t.largestBatchId,Rr(e.ie,t.overlayMutation))}function Ms(e,t){const n=t.path.lastSegment();return[e,jr(t.path.popLast()),n]}function Fs(e,t,n,r){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:Ds(r.readTime),documentKey:jr(r.documentKey.path),largestBatchId:r.largestBatchId}}class Ls{getBundleMetadata(e,t){return Os(e).get(t).next((e=>{if(e)return{id:(t=e).bundleId,createTime:Ns(t.createTime),version:t.version};var t}))}saveBundleMetadata(e,t){return Os(e).put({bundleId:(n=t).id,createTime:Ds(Ir(n.createTime)),version:n.version});var n}getNamedQuery(e,t){return qs(e).get(t).next((e=>{if(e)return{name:(t=e).name,query:Rs(t.bundledQuery),readTime:Ns(t.readTime)};var t}))}saveNamedQuery(e,t){return qs(e).put(function(e){return{name:e.name,readTime:Ds(Ir(e.readTime)),bundledQuery:e.bundledQuery}}(t))}}function Os(e){return vs(e,"bundles")}function qs(e){return vs(e,"namedQueries")}class Ps{constructor(e,t){this.yt=e,this.userId=t}static re(e,t){const n=t.uid||"";return new Ps(e,n)}getOverlay(e,t){return Us(e).get(Ms(this.userId,t)).next((e=>e?Vs(this.yt,e):null))}getOverlays(e,t){const n=Yn();return re.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){const r=[];return n.forEach(((n,s)=>{const i=new Ts(t,s);r.push(this.oe(e,i))})),re.waitFor(r)}removeOverlaysForBatchId(e,t,n){const r=new Set;t.forEach((e=>r.add(jr(e.getCollectionPath()))));const s=[];return r.forEach((t=>{const r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);s.push(Us(e).Y("collectionPathOverlayIndex",r))})),re.waitFor(s)}getOverlaysForCollection(e,t,n){const r=Yn(),s=jr(t),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return Us(e).W("collectionPathOverlayIndex",i).next((e=>{for(const t of e){const e=Vs(this.yt,t);r.set(e.getKey(),e)}return r}))}getOverlaysForCollectionGroup(e,t,n,r){const s=Yn();let i;const o=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return Us(e).Z({index:"collectionGroupOverlayIndex",range:o},((e,t,n)=>{const o=Vs(this.yt,t);s.size()<r||o.largestBatchId===i?(s.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>s))}oe(e,t){return Us(e).put(function(e,t,n){const[r,s,i]=Ms(t,n.mutation.key);return{userId:t,collectionPath:s,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:Ar(e.ie,n.mutation)}}(this.yt,this.userId,t))}}function Us(e){return vs(e,"documentOverlays")}class Bs{constructor(){}ue(e,t){this.ce(e,t),t.ae()}ce(e,t){if("nullValue"in e)this.he(t,5);else if("booleanValue"in e)this.he(t,10),t.le(e.booleanValue?1:0);else if("integerValue"in e)this.he(t,15),t.le(Ne(e.integerValue));else if("doubleValue"in e){const n=Ne(e.doubleValue);isNaN(n)?this.he(t,13):(this.he(t,15),Te(n)?t.le(0):t.le(n))}else if("timestampValue"in e){const n=e.timestampValue;this.he(t,20),"string"==typeof n?t.fe(n):(t.fe(`${n.seconds||""}`),t.le(n.nanos||0))}else if("stringValue"in e)this.de(e.stringValue,t),this._e(t);else if("bytesValue"in e)this.he(t,30),t.we(Ce(e.bytesValue)),this._e(t);else if("referenceValue"in e)this.me(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.he(t,45),t.le(n.latitude||0),t.le(n.longitude||0)}else"mapValue"in e?He(e)?this.he(t,Number.MAX_SAFE_INTEGER):(this.ge(e.mapValue,t),this._e(t)):"arrayValue"in e?(this.ye(e.arrayValue,t),this._e(t)):w()}de(e,t){this.he(t,25),this.pe(e,t)}pe(e,t){t.fe(e)}ge(e,t){const n=e.fields||{};this.he(t,55);for(const r of Object.keys(n))this.de(r,t),this.ce(n[r],t)}ye(e,t){const n=e.values||[];this.he(t,50);for(const r of n)this.ce(r,t)}me(e,t){this.he(t,37),$.fromName(e).path.forEach((e=>{this.he(t,60),this.pe(e,t)}))}he(e,t){e.le(t)}_e(e){e.le(2)}}function Ks(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}function Gs(e){const t=64-function(e){let t=0;for(let n=0;n<8;++n){const r=Ks(255&e[n]);if(t+=r,8!==r)break}return t}(e);return Math.ceil(t/8)}Bs.Ie=new Bs;class $s{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Te(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ee(n.value),n=t.next();this.Ae()}Re(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.be(n.value),n=t.next();this.Pe()}ve(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ee(e);else if(e<2048)this.Ee(960|e>>>6),this.Ee(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ee(480|e>>>12),this.Ee(128|63&e>>>6),this.Ee(128|63&e);else{const e=t.codePointAt(0);this.Ee(240|e>>>18),this.Ee(128|63&e>>>12),this.Ee(128|63&e>>>6),this.Ee(128|63&e)}}this.Ae()}Ve(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.be(e);else if(e<2048)this.be(960|e>>>6),this.be(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.be(480|e>>>12),this.be(128|63&e>>>6),this.be(128|63&e);else{const e=t.codePointAt(0);this.be(240|e>>>18),this.be(128|63&e>>>12),this.be(128|63&e>>>6),this.be(128|63&e)}}this.Pe()}Se(e){const t=this.De(e),n=Gs(t);this.Ce(1+n),this.buffer[this.position++]=255&n;for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=255&t[r]}xe(e){const t=this.De(e),n=Gs(t);this.Ce(1+n),this.buffer[this.position++]=~(255&n);for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=~(255&t[r])}Ne(){this.ke(255),this.ke(255)}Oe(){this.Me(255),this.Me(255)}reset(){this.position=0}seed(e){this.Ce(e.length),this.buffer.set(e,this.position),this.position+=e.length}Fe(){return this.buffer.slice(0,this.position)}De(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let r=1;r<t.length;++r)t[r]^=n?255:0;return t}Ee(e){const t=255&e;0===t?(this.ke(0),this.ke(255)):255===t?(this.ke(255),this.ke(0)):this.ke(t)}be(e){const t=255&e;0===t?(this.Me(0),this.Me(255)):255===t?(this.Me(255),this.Me(0)):this.Me(e)}Ae(){this.ke(0),this.ke(1)}Pe(){this.Me(0),this.Me(1)}ke(e){this.Ce(1),this.buffer[this.position++]=e}Me(e){this.Ce(1),this.buffer[this.position++]=~e}Ce(e){const t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);const r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class js{constructor(e){this.$e=e}we(e){this.$e.Te(e)}fe(e){this.$e.ve(e)}le(e){this.$e.Se(e)}ae(){this.$e.Ne()}}class Qs{constructor(e){this.$e=e}we(e){this.$e.Re(e)}fe(e){this.$e.Ve(e)}le(e){this.$e.xe(e)}ae(){this.$e.Oe()}}class zs{constructor(){this.$e=new $s,this.Be=new js(this.$e),this.Le=new Qs(this.$e)}seed(e){this.$e.seed(e)}qe(e){return 0===e?this.Be:this.Le}Fe(){return this.$e.Fe()}reset(){this.$e.reset()}}class Ws{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Ue(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new Ws(this.indexId,this.documentKey,this.arrayValue,n)}}function Hs(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=Ys(e.arrayValue,t.arrayValue),0!==n?n:(n=Ys(e.directionalValue,t.directionalValue),0!==n?n:$.comparator(e.documentKey,t.documentKey)))}function Ys(e,t){for(let n=0;n<e.length&&n<t.length;++n){const r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}class Xs{constructor(e){this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Ke=e.orderBy,this.Ge=[];for(const t of e.filters){const e=t;e.isInequality()?this.Qe=e:this.Ge.push(e)}}je(e){v(e.collectionGroup===this.collectionId);const t=Q(e);if(void 0!==t&&!this.We(t))return!1;const n=z(e);let r=0,s=0;for(;r<n.length&&this.We(n[r]);++r);if(r===n.length)return!0;if(void 0!==this.Qe){const e=n[r];if(!this.ze(this.Qe,e)||!this.He(this.Ke[s++],e))return!1;++r}for(;r<n.length;++r){const e=n[r];if(s>=this.Ke.length||!this.He(this.Ke[s++],e))return!1}return!0}We(e){for(const t of this.Ge)if(this.ze(t,e))return!0;return!1}ze(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;const n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}He(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function Zs(e){var t,n;if(v(e instanceof st||e instanceof it),e instanceof st){if(e instanceof vt){const r=(null===(n=null===(t=e.value.arrayValue)||void 0===t?void 0:t.values)||void 0===n?void 0:n.map((t=>st.create(e.field,"==",t))))||[];return it.create(r,"or")}return e}const r=e.filters.map((e=>Zs(e)));return it.create(r,e.op)}function Js(e){if(0===e.getFilters().length)return[];const t=ri(Zs(e));return v(ni(t)),ei(t)||ti(t)?[t]:t.getFilters()}function ei(e){return e instanceof st}function ti(e){return e instanceof it&&ut(e)}function ni(e){return ei(e)||ti(e)||function(e){if(e instanceof it&&at(e)){for(const t of e.getFilters())if(!ei(t)&&!ti(t))return!1;return!0}return!1}(e)}function ri(e){if(v(e instanceof st||e instanceof it),e instanceof st)return e;if(1===e.filters.length)return ri(e.filters[0]);const t=e.filters.map((e=>ri(e)));let n=it.create(t,e.op);return n=oi(n),ni(n)?n:(v(n instanceof it),v(ot(n)),v(n.filters.length>1),n.filters.reduce(((e,t)=>si(e,t))))}function si(e,t){let n;return v(e instanceof st||e instanceof it),v(t instanceof st||t instanceof it),n=e instanceof st?t instanceof st?function(e,t){return it.create([e,t],"and")}(e,t):ii(e,t):t instanceof st?ii(t,e):function(e,t){if(v(e.filters.length>0&&t.filters.length>0),ot(e)&&ot(t))return dt(e,t.getFilters());const n=at(e)?e:t,r=at(e)?t:e,s=n.filters.map((e=>si(e,r)));return it.create(s,"or")}(e,t),oi(n)}function ii(e,t){if(ot(t))return dt(t,e.getFilters());{const n=t.filters.map((t=>si(e,t)));return it.create(n,"or")}}function oi(e){if(v(e instanceof st||e instanceof it),e instanceof st)return e;const t=e.getFilters();if(1===t.length)return oi(t[0]);if(ct(e))return e;const n=t.map((e=>oi(e))),r=[];return n.forEach((t=>{t instanceof st?r.push(t):t instanceof it&&(t.op===e.op?r.push(...t.filters):r.push(t))})),1===r.length?r[0]:it.create(r,e.op)}class ai{constructor(){this.Je=new ui}addToCollectionParentIndex(e,t){return this.Je.add(t),re.resolve()}getCollectionParents(e,t){return re.resolve(this.Je.getEntries(t))}addFieldIndex(e,t){return re.resolve()}deleteFieldIndex(e,t){return re.resolve()}getDocumentsMatchingTarget(e,t){return re.resolve(null)}getIndexType(e,t){return re.resolve(0)}getFieldIndexes(e,t){return re.resolve([])}getNextCollectionGroupToUpdate(e){return re.resolve(null)}getMinOffset(e,t){return re.resolve(Z.min())}getMinOffsetFromCollectionGroup(e,t){return re.resolve(Z.min())}updateCollectionGroup(e,t,n){return re.resolve()}updateIndexEntries(e,t){return re.resolve()}}class ui{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new Dt(B.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new Dt(B.comparator)).toArray()}}const ci=new Uint8Array(0);class li{constructor(e,t){this.user=e,this.databaseId=t,this.Ye=new ui,this.Xe=new $n((e=>Lt(e)),((e,t)=>Ot(e,t))),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.Ye.has(t)){const n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener((()=>{this.Ye.add(t)}));const s={collectionId:n,parent:jr(r)};return hi(e).put(s)}return re.resolve()}getCollectionParents(e,t){const n=[],r=IDBKeyRange.bound([t,""],[O(t),""],!1,!0);return hi(e).W(r).next((e=>{for(const r of e){if(r.collectionId!==t)break;n.push(Wr(r.parent))}return n}))}addFieldIndex(e,t){const n=fi(e),r=function(e){return{indexId:e.indexId,collectionGroup:e.collectionGroup,fields:e.fields.map((e=>[e.fieldPath.canonicalString(),e.kind]))}}(t);delete r.indexId;const s=n.add(r);if(t.indexState){const n=mi(e);return s.next((e=>{n.put(Fs(e,this.user,t.indexState.sequenceNumber,t.indexState.offset))}))}return s.next()}deleteFieldIndex(e,t){const n=fi(e),r=mi(e),s=di(e);return n.delete(t.indexId).next((()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))).next((()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))))}getDocumentsMatchingTarget(e,t){const n=di(e);let r=!0;const s=new Map;return re.forEach(this.Ze(t),(t=>this.tn(e,t).next((e=>{r&&(r=!!e),s.set(t,e)})))).next((()=>{if(r){let e=tr();const r=[];return re.forEach(s,((s,i)=>{var o;m("IndexedDbIndexManager",`Using index ${o=s,`id=${o.indexId}|cg=${o.collectionGroup}|f=${o.fields.map((e=>`${e.fieldPath}:${e.kind}`)).join(",")}`} to execute ${Lt(t)}`);const a=function(e,t){const n=Q(t);if(void 0===n)return null;for(const r of Pt(e,n.fieldPath))switch(r.op){case"array-contains-any":return r.value.arrayValue.values||[];case"array-contains":return[r.value]}return null}(i,s),u=function(e,t){const n=new Map;for(const r of z(t))for(const t of Pt(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(i,s),c=function(e,t){const n=[];let r=!0;for(const s of z(t)){const t=0===s.kind?Ut(e,s.fieldPath,e.startAt):Bt(e,s.fieldPath,e.startAt);n.push(t.value),r&&(r=t.inclusive)}return new et(n,r)}(i,s),l=function(e,t){const n=[];let r=!0;for(const s of z(t)){const t=0===s.kind?Bt(e,s.fieldPath,e.endAt):Ut(e,s.fieldPath,e.endAt);n.push(t.value),r&&(r=t.inclusive)}return new et(n,r)}(i,s),h=this.en(s,i,c),d=this.en(s,i,l),f=this.nn(s,i,u),g=this.sn(s.indexId,a,h,c.inclusive,d,l.inclusive,f);return re.forEach(g,(s=>n.J(s,t.limit).next((t=>{t.forEach((t=>{const n=$.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))}))}))))})).next((()=>r))}return re.resolve(null)}))}Ze(e){let t=this.Xe.get(e);return t||(t=0===e.filters.length?[e]:Js(it.create(e.filters,"and")).map((t=>Ft(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt))),this.Xe.set(e,t),t)}sn(e,t,n,r,s,i,o){const a=(null!=t?t.length:1)*Math.max(n.length,s.length),u=a/(null!=t?t.length:1),c=[];for(let l=0;l<a;++l){const a=t?this.rn(t[l/u]):ci,h=this.on(e,a,n[l%u],r),d=this.un(e,a,s[l%u],i),f=o.map((t=>this.on(e,a,t,!0)));c.push(...this.createRange(h,d,f))}return c}on(e,t,n,r){const s=new Ws(e,$.empty(),t,n);return r?s:s.Ue()}un(e,t,n,r){const s=new Ws(e,$.empty(),t,n);return r?s.Ue():s}tn(e,t){const n=new Xs(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next((e=>{let t=null;for(const r of e)n.je(r)&&(!t||r.fields.length>t.fields.length)&&(t=r);return t}))}getIndexType(e,t){let n=2;const r=this.Ze(t);return re.forEach(r,(t=>this.tn(e,t).next((e=>{e?0!==n&&e.fields.length<function(e){let t=new Dt(G.comparator),n=!1;for(const r of e.filters)for(const e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const r of e.orderBy)r.field.isKeyField()||(t=t.add(r.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})))).next((()=>function(e){return null!==e.limit}(t)&&r.length>1&&2===n?1:n))}cn(e,t){const n=new zs;for(const r of z(e)){const e=t.data.field(r.fieldPath);if(null==e)return null;const s=n.qe(r.kind);Bs.Ie.ue(e,s)}return n.Fe()}rn(e){const t=new zs;return Bs.Ie.ue(e,t.qe(0)),t.Fe()}an(e,t){const n=new zs;return Bs.Ie.ue(Ke(this.databaseId,t),n.qe(function(e){const t=z(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.Fe()}nn(e,t,n){if(null===n)return[];let r=[];r.push(new zs);let s=0;for(const i of z(e)){const e=n[s++];for(const n of r)if(this.hn(t,i.fieldPath)&&$e(e))r=this.ln(r,i,e);else{const t=n.qe(i.kind);Bs.Ie.ue(e,t)}}return this.fn(r)}en(e,t,n){return this.nn(e,t,n.position)}fn(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].Fe();return t}ln(e,t,n){const r=[...e],s=[];for(const i of n.arrayValue.values||[])for(const e of r){const n=new zs;n.seed(e.Fe()),Bs.Ie.ue(i,n.qe(t.kind)),s.push(n)}return s}hn(e,t){return!!e.filters.find((e=>e instanceof st&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op)))}getFieldIndexes(e,t){const n=fi(e),r=mi(e);return(t?n.W("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.W()).next((e=>{const t=[];return re.forEach(e,(e=>r.get([e.indexId,this.uid]).next((n=>{t.push(function(e,t){const n=t?new H(t.sequenceNumber,new Z(Ns(t.readTime),new $(Wr(t.documentKey)),t.largestBatchId)):H.empty(),r=e.fields.map((([e,t])=>new W(G.fromServerFormat(e),t)));return new j(e.indexId,e.collectionGroup,r,n)}(e,n))})))).next((()=>t))}))}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next((e=>0===e.length?null:(e.sort(((e,t)=>{const n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:F(e.collectionGroup,t.collectionGroup)})),e[0].collectionGroup)))}updateCollectionGroup(e,t,n){const r=fi(e),s=mi(e);return this.dn(e).next((e=>r.W("collectionGroupIndex",IDBKeyRange.bound(t,t)).next((t=>re.forEach(t,(t=>s.put(Fs(t.indexId,this.user,e,n))))))))}updateIndexEntries(e,t){const n=new Map;return re.forEach(t,((t,r)=>{const s=n.get(t.collectionGroup);return(s?re.resolve(s):this.getFieldIndexes(e,t.collectionGroup)).next((s=>(n.set(t.collectionGroup,s),re.forEach(s,(n=>this._n(e,t,n).next((t=>{const s=this.wn(r,n);return t.isEqual(s)?re.resolve():this.mn(e,r,n,t,s)})))))))}))}gn(e,t,n,r){return di(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.an(n,t.key),documentKey:t.key.path.toArray()})}yn(e,t,n,r){return di(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.an(n,t.key),t.key.path.toArray()])}_n(e,t,n){const r=di(e);let s=new Dt(Hs);return r.Z({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.an(n,t)])},((e,r)=>{s=s.add(new Ws(n.indexId,t,r.arrayValue,r.directionalValue))})).next((()=>s))}wn(e,t){let n=new Dt(Hs);const r=this.cn(t,e);if(null==r)return n;const s=Q(t);if(null!=s){const i=e.data.field(s.fieldPath);if($e(i))for(const s of i.arrayValue.values||[])n=n.add(new Ws(t.indexId,e.key,this.rn(s),r))}else n=n.add(new Ws(t.indexId,e.key,ci,r));return n}mn(e,t,n,r,s){m("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);const i=[];return function(e,t,n,r,s){const i=e.getIterator(),o=t.getIterator();let a=Ct(i),u=Ct(o);for(;a||u;){let e=!1,t=!1;if(a&&u){const r=n(a,u);r<0?t=!0:r>0&&(e=!0)}else null!=a?t=!0:e=!0;e?(r(u),u=Ct(o)):t?(s(a),a=Ct(i)):(a=Ct(i),u=Ct(o))}}(r,s,Hs,(r=>{i.push(this.gn(e,t,n,r))}),(r=>{i.push(this.yn(e,t,n,r))})),re.waitFor(i)}dn(e){let t=1;return mi(e).Z({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((e,n,r)=>{r.done(),t=n.sequenceNumber+1})).next((()=>t))}createRange(e,t,n){n=n.sort(((e,t)=>Hs(e,t))).filter(((e,t,n)=>!t||0!==Hs(e,n[t-1])));const r=[];r.push(e);for(const i of n){const n=Hs(i,e),s=Hs(i,t);if(0===n)r[0]=e.Ue();else if(n>0&&s<0)r.push(i),r.push(i.Ue());else if(s>0)break}r.push(t);const s=[];for(let i=0;i<r.length;i+=2){if(this.pn(r[i],r[i+1]))return[];const e=[r[i].indexId,this.uid,r[i].arrayValue,r[i].directionalValue,ci,[]],t=[r[i+1].indexId,this.uid,r[i+1].arrayValue,r[i+1].directionalValue,ci,[]];s.push(IDBKeyRange.bound(e,t))}return s}pn(e,t){return Hs(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(gi)}getMinOffset(e,t){return re.mapArray(this.Ze(t),(t=>this.tn(e,t).next((e=>e||w())))).next(gi)}}function hi(e){return vs(e,"collectionParents")}function di(e){return vs(e,"indexEntries")}function fi(e){return vs(e,"indexConfiguration")}function mi(e){return vs(e,"indexState")}function gi(e){v(0!==e.length);let t=e[0].indexState.offset,n=t.largestBatchId;for(let r=1;r<e.length;r++){const s=e[r].indexState.offset;J(s,t)<0&&(t=s),n<s.largestBatchId&&(n=s.largestBatchId)}return new Z(t.readTime,t.documentKey,n)}const pi={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class yi{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new yi(e,yi.DEFAULT_COLLECTION_PERCENTILE,yi.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function wi(e,t,n){const r=e.store("mutations"),s=e.store("documentMutations"),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const u=r.Z({range:o},((e,t,n)=>(a++,n.delete())));i.push(u.next((()=>{v(1===a)})));const c=[];for(const l of n.mutations){const e=Xr(t,l.key.path,n.batchId);i.push(s.delete(e)),c.push(l.key)}return re.waitFor(i).next((()=>c))}function vi(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw w();t=e.noDocument}return JSON.stringify(t).length}yi.DEFAULT_COLLECTION_PERCENTILE=10,yi.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,yi.DEFAULT=new yi(41943040,yi.DEFAULT_COLLECTION_PERCENTILE,yi.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),yi.DISABLED=new yi(-1,0,0);class Ii{constructor(e,t,n,r){this.userId=e,this.yt=t,this.indexManager=n,this.referenceDelegate=r,this.In={}}static re(e,t,n,r){v(""!==e.uid);const s=e.isAuthenticated()?e.uid:"";return new Ii(s,t,n,r)}checkEmpty(e){let t=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Ti(e).Z({index:"userMutationsIndex",range:n},((e,n,r)=>{t=!1,r.done()})).next((()=>t))}addMutationBatch(e,t,n,r){const s=Ei(e),i=Ti(e);return i.add({}).next((o=>{v("number"==typeof o);const a=new Is(o,t,n,r),u=function(e,t,n){const r=n.baseMutations.map((t=>Ar(e.ie,t))),s=n.mutations.map((t=>Ar(e.ie,t)));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:s}}(this.yt,this.userId,a),c=[];let l=new Dt(((e,t)=>F(e.canonicalString(),t.canonicalString())));for(const e of r){const t=Xr(this.userId,e.key.path,o);l=l.add(e.key.path.popLast()),c.push(i.put(u)),c.push(s.put(t,Zr))}return l.forEach((t=>{c.push(this.indexManager.addToCollectionParentIndex(e,t))})),e.addOnCommittedListener((()=>{this.In[o]=a.keys()})),re.waitFor(c).next((()=>a))}))}lookupMutationBatch(e,t){return Ti(e).get(t).next((e=>e?(v(e.userId===this.userId),Cs(this.yt,e)):null))}Tn(e,t){return this.In[t]?re.resolve(this.In[t]):this.lookupMutationBatch(e,t).next((e=>{if(e){const n=e.keys();return this.In[t]=n,n}return null}))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return Ti(e).Z({index:"userMutationsIndex",range:r},((e,t,r)=>{t.userId===this.userId&&(v(t.batchId>=n),s=Cs(this.yt,t)),r.done()})).next((()=>s))}getHighestUnacknowledgedBatchId(e){const t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return Ti(e).Z({index:"userMutationsIndex",range:t,reverse:!0},((e,t,r)=>{n=t.batchId,r.done()})).next((()=>n))}getAllMutationBatches(e){const t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Ti(e).W("userMutationsIndex",t).next((e=>e.map((e=>Cs(this.yt,e)))))}getAllMutationBatchesAffectingDocumentKey(e,t){const n=Yr(this.userId,t.path),r=IDBKeyRange.lowerBound(n),s=[];return Ei(e).Z({range:r},((n,r,i)=>{const[o,a,u]=n,c=Wr(a);if(o===this.userId&&t.path.isEqual(c))return Ti(e).get(u).next((e=>{if(!e)throw w();v(e.userId===this.userId),s.push(Cs(this.yt,e))}));i.done()})).next((()=>s))}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new Dt(F);const r=[];return t.forEach((t=>{const s=Yr(this.userId,t.path),i=IDBKeyRange.lowerBound(s),o=Ei(e).Z({range:i},((e,r,s)=>{const[i,o,a]=e,u=Wr(o);i===this.userId&&t.path.isEqual(u)?n=n.add(a):s.done()}));r.push(o)})),re.waitFor(r).next((()=>this.En(e,n)))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1,s=Yr(this.userId,n),i=IDBKeyRange.lowerBound(s);let o=new Dt(F);return Ei(e).Z({range:i},((e,t,s)=>{const[i,a,u]=e,c=Wr(a);i===this.userId&&n.isPrefixOf(c)?c.length===r&&(o=o.add(u)):s.done()})).next((()=>this.En(e,o)))}En(e,t){const n=[],r=[];return t.forEach((t=>{r.push(Ti(e).get(t).next((e=>{if(null===e)throw w();v(e.userId===this.userId),n.push(Cs(this.yt,e))})))})),re.waitFor(r).next((()=>n))}removeMutationBatch(e,t){return wi(e.se,this.userId,t).next((n=>(e.addOnCommittedListener((()=>{this.An(t.batchId)})),re.forEach(n,(t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))))}An(e){delete this.In[e]}performConsistencyCheck(e){return this.checkEmpty(e).next((t=>{if(!t)return re.resolve();const n=IDBKeyRange.lowerBound([this.userId]),r=[];return Ei(e).Z({range:n},((e,t,n)=>{if(e[0]===this.userId){const t=Wr(e[1]);r.push(t)}else n.done()})).next((()=>{v(0===r.length)}))}))}containsKey(e,t){return bi(e,this.userId,t)}Rn(e){return Si(e).get(this.userId).next((e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function bi(e,t,n){const r=Yr(t,n.path),s=r[1],i=IDBKeyRange.lowerBound(r);let o=!1;return Ei(e).Z({range:i,X:!0},((e,n,r)=>{const[i,a,u]=e;i===t&&a===s&&(o=!0),r.done()})).next((()=>o))}function Ti(e){return vs(e,"mutations")}function Ei(e){return vs(e,"documentMutations")}function Si(e){return vs(e,"mutationQueues")}class xi{constructor(e){this.bn=e}next(){return this.bn+=2,this.bn}static Pn(){return new xi(0)}static vn(){return new xi(-1)}}class _i{constructor(e,t){this.referenceDelegate=e,this.yt=t}allocateTargetId(e){return this.Vn(e).next((t=>{const n=new xi(t.highestTargetId);return t.highestTargetId=n.next(),this.Sn(e,t).next((()=>t.highestTargetId))}))}getLastRemoteSnapshotVersion(e){return this.Vn(e).next((e=>P.fromTimestamp(new q(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(e){return this.Vn(e).next((e=>e.highestListenSequenceNumber))}setTargetsMetadata(e,t,n){return this.Vn(e).next((r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.Sn(e,r))))}addTargetData(e,t){return this.Dn(e,t).next((()=>this.Vn(e).next((n=>(n.targetCount+=1,this.Cn(t,n),this.Sn(e,n))))))}updateTargetData(e,t){return this.Dn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next((()=>Di(e).delete(t.targetId))).next((()=>this.Vn(e))).next((t=>(v(t.targetCount>0),t.targetCount-=1,this.Sn(e,t))))}removeTargets(e,t,n){let r=0;const s=[];return Di(e).Z(((i,o)=>{const a=ks(o);a.sequenceNumber<=t&&null===n.get(a.targetId)&&(r++,s.push(this.removeTargetData(e,a)))})).next((()=>re.waitFor(s))).next((()=>r))}forEachTarget(e,t){return Di(e).Z(((e,n)=>{const r=ks(n);t(r)}))}Vn(e){return Ni(e).get("targetGlobalKey").next((e=>(v(null!==e),e)))}Sn(e,t){return Ni(e).put("targetGlobalKey",t)}Dn(e,t){return Di(e).put(As(this.yt,t))}Cn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.Vn(e).next((e=>e.targetCount))}getTargetData(e,t){const n=Lt(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return Di(e).Z({range:r,index:"queryTargetsIndex"},((e,n,r)=>{const i=ks(n);Ot(t,i.target)&&(s=i,r.done())})).next((()=>s))}addMatchingKeys(e,t,n){const r=[],s=Ci(e);return t.forEach((t=>{const i=jr(t.path);r.push(s.put({targetId:n,path:i})),r.push(this.referenceDelegate.addReference(e,n,t))})),re.waitFor(r)}removeMatchingKeys(e,t,n){const r=Ci(e);return re.forEach(t,(t=>{const s=jr(t.path);return re.waitFor([r.delete([n,s]),this.referenceDelegate.removeReference(e,n,t)])}))}removeMatchingKeysForTargetId(e,t){const n=Ci(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=Ci(e);let s=tr();return r.Z({range:n,X:!0},((e,t,n)=>{const r=Wr(e[1]),i=new $(r);s=s.add(i)})).next((()=>s))}containsKey(e,t){const n=jr(t.path),r=IDBKeyRange.bound([n],[O(n)],!1,!0);let s=0;return Ci(e).Z({index:"documentTargetsIndex",X:!0,range:r},(([e,t],n,r)=>{0!==e&&(s++,r.done())})).next((()=>s>0))}ne(e,t){return Di(e).get(t).next((e=>e?ks(e):null))}}function Di(e){return vs(e,"targets")}function Ni(e){return vs(e,"targetGlobal")}function Ci(e){return vs(e,"targetDocuments")}function ki([e,t],[n,r]){const s=F(e,n);return 0===s?F(t,r):s}class Ai{constructor(e){this.xn=e,this.buffer=new Dt(ki),this.Nn=0}kn(){return++this.Nn}On(e){const t=[e,this.kn()];if(this.buffer.size<this.xn)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();ki(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class Ri{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Mn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Fn(6e4)}stop(){this.Mn&&(this.Mn.cancel(),this.Mn=null)}get started(){return null!==this.Mn}Fn(e){m("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Mn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,(async()=>{this.Mn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){ue(e)?m("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await ne(e)}await this.Fn(3e5)}))}}class Vi{constructor(e,t){this.$n=e,this.params=t}calculateTargetCount(e,t){return this.$n.Bn(e).next((e=>Math.floor(t/100*e)))}nthSequenceNumber(e,t){if(0===t)return re.resolve(ge.at);const n=new Ai(t);return this.$n.forEachTarget(e,(e=>n.On(e.sequenceNumber))).next((()=>this.$n.Ln(e,(e=>n.On(e))))).next((()=>n.maxValue))}removeTargets(e,t,n){return this.$n.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.$n.removeOrphanedDocuments(e,t)}collect(e,t){return-1===this.params.cacheSizeCollectionThreshold?(m("LruGarbageCollector","Garbage collection skipped; disabled"),re.resolve(pi)):this.getCacheSize(e).next((n=>n<this.params.cacheSizeCollectionThreshold?(m("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),pi):this.qn(e,t)))}getCacheSize(e){return this.$n.getCacheSize(e)}qn(e,t){let n,r,s,o,a,u,c;const l=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next((t=>(t>this.params.maximumSequenceNumbersToCollect?(m("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,o=Date.now(),this.nthSequenceNumber(e,r)))).next((r=>(n=r,a=Date.now(),this.removeTargets(e,n,t)))).next((t=>(s=t,u=Date.now(),this.removeOrphanedDocuments(e,n)))).next((e=>(c=Date.now(),d()<=i.a.DEBUG&&m("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-l}ms\n\tDetermined least recently used ${r} in `+(a-o)+"ms\n"+`\tRemoved ${s} targets in `+(u-a)+"ms\n"+`\tRemoved ${e} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-l}ms`),re.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:s,documentsRemoved:e}))))}}class Mi{constructor(e,t){this.db=e,this.garbageCollector=function(e,t){return new Vi(e,t)}(this,t)}Bn(e){const t=this.Un(e);return this.db.getTargetCache().getTargetCount(e).next((e=>t.next((t=>e+t))))}Un(e){let t=0;return this.Ln(e,(e=>{t++})).next((()=>t))}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Ln(e,t){return this.Kn(e,((e,n)=>t(n)))}addReference(e,t,n){return Fi(e,n)}removeReference(e,t,n){return Fi(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return Fi(e,t)}Gn(e,t){return function(e,t){let n=!1;return Si(e).tt((r=>bi(e,r,t).next((e=>(e&&(n=!0),re.resolve(!e)))))).next((()=>n))}(e,t)}removeOrphanedDocuments(e,t){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let s=0;return this.Kn(e,((i,o)=>{if(o<=t){const t=this.Gn(e,i).next((t=>{if(!t)return s++,n.getEntry(e,i).next((()=>(n.removeEntry(i,P.min()),Ci(e).delete([0,jr(i.path)]))))}));r.push(t)}})).next((()=>re.waitFor(r))).next((()=>n.apply(e))).next((()=>s))}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return Fi(e,t)}Kn(e,t){const n=Ci(e);let r,s=ge.at;return n.Z({index:"documentTargetsIndex"},(([e,n],{path:i,sequenceNumber:o})=>{0===e?(s!==ge.at&&t(new $(Wr(r)),s),s=o,r=i):s=ge.at})).next((()=>{s!==ge.at&&t(new $(Wr(r)),s)}))}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function Fi(e,t){return Ci(e).put(function(e,t){return{targetId:0,path:jr(e.path),sequenceNumber:t}}(t,e.currentSequenceNumber))}class Li{constructor(){this.changes=new $n((e=>e.toString()),((e,t)=>e.isEqual(t))),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Vt.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?re.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Oi{constructor(e){this.yt=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return Bi(e).put(n)}removeEntry(e,t,n){return Bi(e).delete(function(e,t){const n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],_s(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next((n=>(n.byteSize+=t,this.Qn(e,n))))}getEntry(e,t){let n=Vt.newInvalidDocument(t);return Bi(e).Z({index:"documentKeyIndex",range:IDBKeyRange.only(Ki(t))},((e,r)=>{n=this.jn(t,r)})).next((()=>n))}Wn(e,t){let n={size:0,document:Vt.newInvalidDocument(t)};return Bi(e).Z({index:"documentKeyIndex",range:IDBKeyRange.only(Ki(t))},((e,r)=>{n={document:this.jn(t,r),size:vi(r)}})).next((()=>n))}getEntries(e,t){let n=Qn();return this.zn(e,t,((e,t)=>{const r=this.jn(e,t);n=n.insert(e,r)})).next((()=>n))}Hn(e,t){let n=Qn(),r=new St($.comparator);return this.zn(e,t,((e,t)=>{const s=this.jn(e,t);n=n.insert(e,s),r=r.insert(e,vi(t))})).next((()=>({documents:n,Jn:r})))}zn(e,t,n){if(t.isEmpty())return re.resolve();let r=new Dt($i);t.forEach((e=>r=r.add(e)));const s=IDBKeyRange.bound(Ki(r.first()),Ki(r.last())),i=r.getIterator();let o=i.getNext();return Bi(e).Z({index:"documentKeyIndex",range:s},((e,t,r)=>{const s=$.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;o&&$i(o,s)<0;)n(o,null),o=i.getNext();o&&o.isEqual(s)&&(n(o,t),o=i.hasNext()?i.getNext():null),o?r.j(Ki(o)):r.done()})).next((()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))}getDocumentsMatchingQuery(e,t,n,r){const s=t.path,i=[s.popLast().toArray(),s.lastSegment(),_s(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],o=[s.popLast().toArray(),s.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Bi(e).W(IDBKeyRange.bound(i,o,!0)).next((e=>{let n=Qn();for(const s of e){const e=this.jn($.fromSegments(s.prefixPath.concat(s.collectionGroup,s.documentId)),s);e.isFoundDocument()&&(nn(t,e)||r.has(e.key))&&(n=n.insert(e.key,e))}return n}))}getAllFromCollectionGroup(e,t,n,r){let s=Qn();const i=Gi(t,n),o=Gi(t,Z.max());return Bi(e).Z({index:"collectionGroupIndex",range:IDBKeyRange.bound(i,o,!0)},((e,t,n)=>{const i=this.jn($.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);s=s.insert(i.key,i),s.size===r&&n.done()})).next((()=>s))}newChangeBuffer(e){return new Pi(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next((e=>e.byteSize))}getMetadata(e){return Ui(e).get("remoteDocumentGlobalKey").next((e=>(v(!!e),e)))}Qn(e,t){return Ui(e).put("remoteDocumentGlobalKey",t)}jn(e,t){if(t){const e=function(e,t){let n;if(t.document)n=kr(e.ie,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=$.fromSegments(t.noDocument.path),r=Ns(t.noDocument.readTime);n=Vt.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return w();{const e=$.fromSegments(t.unknownDocument.path),r=Ns(t.unknownDocument.version);n=Vt.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime(function(e){const t=new q(e[0],e[1]);return P.fromTimestamp(t)}(t.readTime)),n}(this.yt,t);if(!e.isNoDocument()||!e.version.isEqual(P.min()))return e}return Vt.newInvalidDocument(e)}}function qi(e){return new Oi(e)}class Pi extends Li{constructor(e,t){super(),this.Yn=e,this.trackRemovals=t,this.Xn=new $n((e=>e.toString()),((e,t)=>e.isEqual(t)))}applyChanges(e){const t=[];let n=0,r=new Dt(((e,t)=>F(e.canonicalString(),t.canonicalString())));return this.changes.forEach(((s,i)=>{const o=this.Xn.get(s);if(t.push(this.Yn.removeEntry(e,s,o.readTime)),i.isValidDocument()){const a=xs(this.Yn.yt,i);r=r.add(s.path.popLast());const u=vi(a);n+=u-o.size,t.push(this.Yn.addEntry(e,s,a))}else if(n-=o.size,this.trackRemovals){const n=xs(this.Yn.yt,i.convertToNoDocument(P.min()));t.push(this.Yn.addEntry(e,s,n))}})),r.forEach((n=>{t.push(this.Yn.indexManager.addToCollectionParentIndex(e,n))})),t.push(this.Yn.updateMetadata(e,n)),re.waitFor(t)}getFromCache(e,t){return this.Yn.Wn(e,t).next((e=>(this.Xn.set(t,{size:e.size,readTime:e.document.readTime}),e.document)))}getAllFromCache(e,t){return this.Yn.Hn(e,t).next((({documents:e,Jn:t})=>(t.forEach(((t,n)=>{this.Xn.set(t,{size:n,readTime:e.get(t).readTime})})),e)))}}function Ui(e){return vs(e,"remoteDocumentGlobal")}function Bi(e){return vs(e,"remoteDocumentsV14")}function Ki(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function Gi(e,t){const n=t.documentKey.path.toArray();return[e,_s(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function $i(e,t){const n=e.path.toArray(),r=t.path.toArray();let s=0;for(let i=0;i<n.length-2&&i<r.length-2;++i)if(s=F(n[i],r[i]),s)return s;return s=F(n.length,r.length),s||(s=F(n[n.length-2],r[r.length-2]),s||F(n[n.length-1],r[r.length-1]))}class ji{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class Qi{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next((r=>(n=r,this.remoteDocumentCache.getEntry(e,t)))).next((e=>(null!==n&&Cn(n.mutation,e,kt.empty(),q.now()),e)))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.getLocalViewOfDocuments(e,t,tr()).next((()=>t))))}getLocalViewOfDocuments(e,t,n=tr()){const r=Yn();return this.populateOverlays(e,r,t).next((()=>this.computeViews(e,t,r,n).next((e=>{let t=Wn();return e.forEach(((e,n)=>{t=t.insert(e,n.overlayedDocument)})),t}))))}getOverlayedDocuments(e,t){const n=Yn();return this.populateOverlays(e,n,t).next((()=>this.computeViews(e,t,n,tr())))}populateOverlays(e,t,n){const r=[];return n.forEach((e=>{t.has(e)||r.push(e)})),this.documentOverlayCache.getOverlays(e,r).next((e=>{e.forEach(((e,n)=>{t.set(e,n)}))}))}computeViews(e,t,n,r){let s=Qn();const i=Zn(),o=Zn();return t.forEach(((e,t)=>{const o=n.get(t.key);r.has(t.key)&&(void 0===o||o.mutation instanceof Vn)?s=s.insert(t.key,t):void 0!==o?(i.set(t.key,o.mutation.getFieldMask()),Cn(o.mutation,t,o.mutation.getFieldMask(),q.now())):i.set(t.key,kt.empty())})),this.recalculateAndSaveOverlays(e,s).next((e=>(e.forEach(((e,t)=>i.set(e,t))),t.forEach(((e,t)=>{var n;return o.set(e,new ji(t,null!==(n=i.get(e))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(e,t){const n=Zn();let r=new St(((e,t)=>e-t)),s=tr();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next((e=>{for(const s of e)s.keys().forEach((e=>{const i=t.get(e);if(null===i)return;let o=n.get(e)||kt.empty();o=s.applyToLocalView(i,o),n.set(e,o);const a=(r.get(s.batchId)||tr()).add(e);r=r.insert(s.batchId,a)}))})).next((()=>{const i=[],o=r.getReverseIterator();for(;o.hasNext();){const r=o.getNext(),a=r.key,u=r.value,c=Xn();u.forEach((e=>{if(!s.has(e)){const r=Dn(t.get(e),n.get(e));null!==r&&c.set(e,r),s=s.add(e)}})),i.push(this.documentOverlayCache.saveOverlays(e,a,c))}return re.waitFor(i)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.recalculateAndSaveOverlays(e,t)))}getDocumentsMatchingQuery(e,t,n){return function(e){return $.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):Wt(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n):this.getDocumentsMatchingCollectionQuery(e,t,n)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next((s=>{const i=r-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-s.size):re.resolve(Yn());let o=-1,a=s;return i.next((t=>re.forEach(t,((t,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),s.get(t)?re.resolve():this.remoteDocumentCache.getEntry(e,t).next((e=>{a=a.insert(t,e)}))))).next((()=>this.populateOverlays(e,t,s))).next((()=>this.computeViews(e,a,t,tr()))).next((e=>({batchId:o,changes:Hn(e)})))))}))}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new $(t)).next((e=>{let t=Wn();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t}))}getDocumentsMatchingCollectionGroupQuery(e,t,n){const r=t.collectionGroup;let s=Wn();return this.indexManager.getCollectionParents(e,r).next((i=>re.forEach(i,(i=>{const o=function(e,t){return new Kt(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,i.child(r));return this.getDocumentsMatchingCollectionQuery(e,o,n).next((e=>{e.forEach(((e,t)=>{s=s.insert(e,t)}))}))})).next((()=>s))))}getDocumentsMatchingCollectionQuery(e,t,n){let r;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next((s=>(r=s,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,r)))).next((e=>{r.forEach(((t,n)=>{const r=n.getKey();null===e.get(r)&&(e=e.insert(r,Vt.newInvalidDocument(r)))}));let n=Wn();return e.forEach(((e,s)=>{const i=r.get(e);void 0!==i&&Cn(i.mutation,s,kt.empty(),q.now()),nn(t,s)&&(n=n.insert(e,s))})),n}))}}class zi{constructor(e){this.yt=e,this.Zn=new Map,this.ts=new Map}getBundleMetadata(e,t){return re.resolve(this.Zn.get(t))}saveBundleMetadata(e,t){var n;return this.Zn.set(t.id,{id:(n=t).id,version:n.version,createTime:Ir(n.createTime)}),re.resolve()}getNamedQuery(e,t){return re.resolve(this.ts.get(t))}saveNamedQuery(e,t){return this.ts.set(t.name,function(e){return{name:e.name,query:Rs(e.bundledQuery),readTime:Ir(e.readTime)}}(t)),re.resolve()}}class Wi{constructor(){this.overlays=new St($.comparator),this.es=new Map}getOverlay(e,t){return re.resolve(this.overlays.get(t))}getOverlays(e,t){const n=Yn();return re.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){return n.forEach(((n,r)=>{this.oe(e,t,r)})),re.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.es.get(n);return void 0!==r&&(r.forEach((e=>this.overlays=this.overlays.remove(e))),this.es.delete(n)),re.resolve()}getOverlaysForCollection(e,t,n){const r=Yn(),s=t.length+1,i=new $(t.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const e=o.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===s&&e.largestBatchId>n&&r.set(e.getKey(),e)}return re.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let s=new St(((e,t)=>e-t));const i=this.overlays.getIterator();for(;i.hasNext();){const e=i.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=s.get(e.largestBatchId);null===t&&(t=Yn(),s=s.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const o=Yn(),a=s.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((e,t)=>o.set(e,t))),!(o.size()>=r)););return re.resolve(o)}oe(e,t,n){const r=this.overlays.get(n.key);if(null!==r){const e=this.es.get(r.largestBatchId).delete(n.key);this.es.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new Ts(t,n));let s=this.es.get(t);void 0===s&&(s=tr(),this.es.set(t,s)),this.es.set(t,s.add(n.key))}}class Hi{constructor(){this.ns=new Dt(Yi.ss),this.rs=new Dt(Yi.os)}isEmpty(){return this.ns.isEmpty()}addReference(e,t){const n=new Yi(e,t);this.ns=this.ns.add(n),this.rs=this.rs.add(n)}us(e,t){e.forEach((e=>this.addReference(e,t)))}removeReference(e,t){this.cs(new Yi(e,t))}hs(e,t){e.forEach((e=>this.removeReference(e,t)))}ls(e){const t=new $(new B([])),n=new Yi(t,e),r=new Yi(t,e+1),s=[];return this.rs.forEachInRange([n,r],(e=>{this.cs(e),s.push(e.key)})),s}fs(){this.ns.forEach((e=>this.cs(e)))}cs(e){this.ns=this.ns.delete(e),this.rs=this.rs.delete(e)}ds(e){const t=new $(new B([])),n=new Yi(t,e),r=new Yi(t,e+1);let s=tr();return this.rs.forEachInRange([n,r],(e=>{s=s.add(e.key)})),s}containsKey(e){const t=new Yi(e,0),n=this.ns.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class Yi{constructor(e,t){this.key=e,this._s=t}static ss(e,t){return $.comparator(e.key,t.key)||F(e._s,t._s)}static os(e,t){return F(e._s,t._s)||$.comparator(e.key,t.key)}}class Xi{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.ws=1,this.gs=new Dt(Yi.ss)}checkEmpty(e){return re.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){const s=this.ws;this.ws++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const i=new Is(s,t,n,r);this.mutationQueue.push(i);for(const o of r)this.gs=this.gs.add(new Yi(o.key,s)),this.indexManager.addToCollectionParentIndex(e,o.key.path.popLast());return re.resolve(i)}lookupMutationBatch(e,t){return re.resolve(this.ys(t))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=this.ps(n),s=r<0?0:r;return re.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return re.resolve(0===this.mutationQueue.length?-1:this.ws-1)}getAllMutationBatches(e){return re.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Yi(t,0),r=new Yi(t,Number.POSITIVE_INFINITY),s=[];return this.gs.forEachInRange([n,r],(e=>{const t=this.ys(e._s);s.push(t)})),re.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new Dt(F);return t.forEach((e=>{const t=new Yi(e,0),r=new Yi(e,Number.POSITIVE_INFINITY);this.gs.forEachInRange([t,r],(e=>{n=n.add(e._s)}))})),re.resolve(this.Is(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;$.isDocumentKey(s)||(s=s.child(""));const i=new Yi(new $(s),0);let o=new Dt(F);return this.gs.forEachWhile((e=>{const t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(o=o.add(e._s)),!0)}),i),re.resolve(this.Is(o))}Is(e){const t=[];return e.forEach((e=>{const n=this.ys(e);null!==n&&t.push(n)})),t}removeMutationBatch(e,t){v(0===this.Ts(t.batchId,"removed")),this.mutationQueue.shift();let n=this.gs;return re.forEach(t.mutations,(r=>{const s=new Yi(r.key,t.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)})).next((()=>{this.gs=n}))}An(e){}containsKey(e,t){const n=new Yi(t,0),r=this.gs.firstAfterOrEqual(n);return re.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,re.resolve()}Ts(e,t){return this.ps(e)}ps(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}ys(e){const t=this.ps(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class Zi{constructor(e){this.Es=e,this.docs=new St($.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),s=r?r.size:0,i=this.Es(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return re.resolve(n?n.document.mutableCopy():Vt.newInvalidDocument(t))}getEntries(e,t){let n=Qn();return t.forEach((e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():Vt.newInvalidDocument(e))})),re.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let s=Qn();const i=t.path,o=new $(i.child("")),a=this.docs.getIteratorFrom(o);for(;a.hasNext();){const{key:e,value:{document:o}}=a.getNext();if(!i.isPrefixOf(e.path))break;e.path.length>i.length+1||J(X(o),n)<=0||(r.has(o.key)||nn(t,o))&&(s=s.insert(o.key,o.mutableCopy()))}return re.resolve(s)}getAllFromCollectionGroup(e,t,n,r){w()}As(e,t){return re.forEach(this.docs,(e=>t(e)))}newChangeBuffer(e){return new Ji(this)}getSize(e){return re.resolve(this.size)}}class Ji extends Li{constructor(e){super(),this.Yn=e}applyChanges(e){const t=[];return this.changes.forEach(((n,r)=>{r.isValidDocument()?t.push(this.Yn.addEntry(e,r)):this.Yn.removeEntry(n)})),re.waitFor(t)}getFromCache(e,t){return this.Yn.getEntry(e,t)}getAllFromCache(e,t){return this.Yn.getEntries(e,t)}}class eo{constructor(e){this.persistence=e,this.Rs=new $n((e=>Lt(e)),Ot),this.lastRemoteSnapshotVersion=P.min(),this.highestTargetId=0,this.bs=0,this.Ps=new Hi,this.targetCount=0,this.vs=xi.Pn()}forEachTarget(e,t){return this.Rs.forEach(((e,n)=>t(n))),re.resolve()}getLastRemoteSnapshotVersion(e){return re.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return re.resolve(this.bs)}allocateTargetId(e){return this.highestTargetId=this.vs.next(),re.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.bs&&(this.bs=t),re.resolve()}Dn(e){this.Rs.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.vs=new xi(t),this.highestTargetId=t),e.sequenceNumber>this.bs&&(this.bs=e.sequenceNumber)}addTargetData(e,t){return this.Dn(t),this.targetCount+=1,re.resolve()}updateTargetData(e,t){return this.Dn(t),re.resolve()}removeTargetData(e,t){return this.Rs.delete(t.target),this.Ps.ls(t.targetId),this.targetCount-=1,re.resolve()}removeTargets(e,t,n){let r=0;const s=[];return this.Rs.forEach(((i,o)=>{o.sequenceNumber<=t&&null===n.get(o.targetId)&&(this.Rs.delete(i),s.push(this.removeMatchingKeysForTargetId(e,o.targetId)),r++)})),re.waitFor(s).next((()=>r))}getTargetCount(e){return re.resolve(this.targetCount)}getTargetData(e,t){const n=this.Rs.get(t)||null;return re.resolve(n)}addMatchingKeys(e,t,n){return this.Ps.us(t,n),re.resolve()}removeMatchingKeys(e,t,n){this.Ps.hs(t,n);const r=this.persistence.referenceDelegate,s=[];return r&&t.forEach((t=>{s.push(r.markPotentiallyOrphaned(e,t))})),re.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Ps.ls(t),re.resolve()}getMatchingKeysForTargetId(e,t){const n=this.Ps.ds(t);return re.resolve(n)}containsKey(e,t){return re.resolve(this.Ps.containsKey(t))}}class to{constructor(e,t){this.Vs={},this.overlays={},this.Ss=new ge(0),this.Ds=!1,this.Ds=!0,this.referenceDelegate=e(this),this.Cs=new eo(this),this.indexManager=new ai,this.remoteDocumentCache=function(e){return new Zi(e)}((e=>this.referenceDelegate.xs(e))),this.yt=new Ss(t),this.Ns=new zi(this.yt)}start(){return Promise.resolve()}shutdown(){return this.Ds=!1,Promise.resolve()}get started(){return this.Ds}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Wi,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Vs[e.toKey()];return n||(n=new Xi(t,this.referenceDelegate),this.Vs[e.toKey()]=n),n}getTargetCache(){return this.Cs}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ns}runTransaction(e,t,n){m("MemoryPersistence","Starting transaction:",e);const r=new no(this.Ss.next());return this.referenceDelegate.ks(),n(r).next((e=>this.referenceDelegate.Os(r).next((()=>e)))).toPromise().then((e=>(r.raiseOnCommittedEvent(),e)))}Ms(e,t){return re.or(Object.values(this.Vs).map((n=>()=>n.containsKey(e,t))))}}class no extends te{constructor(e){super(),this.currentSequenceNumber=e}}class ro{constructor(e){this.persistence=e,this.Fs=new Hi,this.$s=null}static Bs(e){return new ro(e)}get Ls(){if(this.$s)return this.$s;throw w()}addReference(e,t,n){return this.Fs.addReference(n,t),this.Ls.delete(n.toString()),re.resolve()}removeReference(e,t,n){return this.Fs.removeReference(n,t),this.Ls.add(n.toString()),re.resolve()}markPotentiallyOrphaned(e,t){return this.Ls.add(t.toString()),re.resolve()}removeTarget(e,t){this.Fs.ls(t.targetId).forEach((e=>this.Ls.add(e.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next((e=>{e.forEach((e=>this.Ls.add(e.toString())))})).next((()=>n.removeTargetData(e,t)))}ks(){this.$s=new Set}Os(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return re.forEach(this.Ls,(n=>{const r=$.fromPath(n);return this.qs(e,r).next((e=>{e||t.removeEntry(r,P.min())}))})).next((()=>(this.$s=null,t.apply(e))))}updateLimboDocument(e,t){return this.qs(e,t).next((e=>{e?this.Ls.delete(t.toString()):this.Ls.add(t.toString())}))}xs(e){return 0}qs(e,t){return re.or([()=>re.resolve(this.Fs.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ms(e,t)])}}class so{constructor(e){this.yt=e}$(e,t,n,r){const s=new se("createOrUpgrade",t);n<1&&r>=1&&(function(e){e.createObjectStore("owner")}(e),function(e){e.createObjectStore("mutationQueues",{keyPath:"userId"}),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Hr,{unique:!0}),e.createObjectStore("documentMutations")}(e),io(e),function(e){e.createObjectStore("remoteDocuments")}(e));let i=re.resolve();return n<3&&r>=3&&(0!==n&&(function(e){e.deleteObjectStore("targetDocuments"),e.deleteObjectStore("targets"),e.deleteObjectStore("targetGlobal")}(e),io(e)),i=i.next((()=>function(e){const t=e.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:P.min().toTimestamp(),targetCount:0};return t.put("targetGlobalKey",n)}(s)))),n<4&&r>=4&&(0!==n&&(i=i.next((()=>function(e,t){return t.store("mutations").W().next((n=>{e.deleteObjectStore("mutations"),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Hr,{unique:!0});const r=t.store("mutations"),s=n.map((e=>r.put(e)));return re.waitFor(s)}))}(e,s)))),i=i.next((()=>{!function(e){e.createObjectStore("clientMetadata",{keyPath:"clientId"})}(e)}))),n<5&&r>=5&&(i=i.next((()=>this.Us(s)))),n<6&&r>=6&&(i=i.next((()=>(function(e){e.createObjectStore("remoteDocumentGlobal")}(e),this.Ks(s))))),n<7&&r>=7&&(i=i.next((()=>this.Gs(s)))),n<8&&r>=8&&(i=i.next((()=>this.Qs(e,s)))),n<9&&r>=9&&(i=i.next((()=>{!function(e){e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")}(e)}))),n<10&&r>=10&&(i=i.next((()=>this.js(s)))),n<11&&r>=11&&(i=i.next((()=>{!function(e){e.createObjectStore("bundles",{keyPath:"bundleId"})}(e),function(e){e.createObjectStore("namedQueries",{keyPath:"name"})}(e)}))),n<12&&r>=12&&(i=i.next((()=>{!function(e){const t=e.createObjectStore("documentOverlays",{keyPath:ls});t.createIndex("collectionPathOverlayIndex",hs,{unique:!1}),t.createIndex("collectionGroupOverlayIndex",ds,{unique:!1})}(e)}))),n<13&&r>=13&&(i=i.next((()=>function(e){const t=e.createObjectStore("remoteDocumentsV14",{keyPath:Jr});t.createIndex("documentKeyIndex",es),t.createIndex("collectionGroupIndex",ts)}(e))).next((()=>this.Ws(e,s))).next((()=>e.deleteObjectStore("remoteDocuments")))),n<14&&r>=14&&(i=i.next((()=>this.zs(e,s)))),n<15&&r>=15&&(i=i.next((()=>function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:os}).createIndex("sequenceNumberIndex",as,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:us}).createIndex("documentKeyIndex",cs,{unique:!1})}(e)))),i}Ks(e){let t=0;return e.store("remoteDocuments").Z(((e,n)=>{t+=vi(n)})).next((()=>{const n={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}Us(e){const t=e.store("mutationQueues"),n=e.store("mutations");return t.W().next((t=>re.forEach(t,(t=>{const r=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.W("userMutationsIndex",r).next((n=>re.forEach(n,(n=>{v(n.userId===t.userId);const r=Cs(this.yt,n);return wi(e,t.userId,r).next((()=>{}))}))))}))))}Gs(e){const t=e.store("targetDocuments"),n=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next((e=>{const r=[];return n.Z(((n,s)=>{const i=new B(n),o=function(e){return[0,jr(e)]}(i);r.push(t.get(o).next((n=>n?re.resolve():(n=>t.put({targetId:0,path:jr(n),sequenceNumber:e.highestListenSequenceNumber}))(i))))})).next((()=>re.waitFor(r)))}))}Qs(e,t){e.createObjectStore("collectionParents",{keyPath:is});const n=t.store("collectionParents"),r=new ui,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:jr(r)})}};return t.store("remoteDocuments").Z({X:!0},((e,t)=>{const n=new B(e);return s(n.popLast())})).next((()=>t.store("documentMutations").Z({X:!0},(([e,t,n],r)=>{const i=Wr(t);return s(i.popLast())}))))}js(e){const t=e.store("targets");return t.Z(((e,n)=>{const r=ks(n),s=As(this.yt,r);return t.put(s)}))}Ws(e,t){const n=t.store("remoteDocuments"),r=[];return n.Z(((e,n)=>{const s=t.store("remoteDocumentsV14"),i=(o=n,o.document?new $(B.fromString(o.document.name).popFirst(5)):o.noDocument?$.fromSegments(o.noDocument.path):o.unknownDocument?$.fromSegments(o.unknownDocument.path):w()).path.toArray();var o;const a={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(s.put(a))})).next((()=>re.waitFor(r)))}zs(e,t){const n=t.store("mutations"),r=qi(this.yt),s=new to(ro.Bs,this.yt.ie);return n.W().next((e=>{const n=new Map;return e.forEach((e=>{var t;let r=null!==(t=n.get(e.userId))&&void 0!==t?t:tr();Cs(this.yt,e).keys().forEach((e=>r=r.add(e))),n.set(e.userId,r)})),re.forEach(n,((e,n)=>{const i=new c(n),o=Ps.re(this.yt,i),a=s.getIndexManager(i),u=Ii.re(i,this.yt,a,s.referenceDelegate);return new Qi(r,u,o,a).recalculateAndSaveOverlaysForDocumentKeys(new ws(t,ge.at),e).next()}))}))}}function io(e){e.createObjectStore("targetDocuments",{keyPath:rs}).createIndex("documentTargetsIndex",ss,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",ns,{unique:!0}),e.createObjectStore("targetGlobal")}const oo="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class ao{constructor(e,t,n,r,s,i,o,a,u,c,l=15){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.Hs=s,this.window=i,this.document=o,this.Js=u,this.Ys=c,this.Xs=l,this.Ss=null,this.Ds=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Zs=null,this.inForeground=!1,this.ti=null,this.ei=null,this.ni=Number.NEGATIVE_INFINITY,this.si=e=>Promise.resolve(),!ao.C())throw new E(T.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Mi(this,r),this.ii=t+"main",this.yt=new Ss(a),this.ri=new ie(this.ii,this.Xs,new so(this.yt)),this.Cs=new _i(this.referenceDelegate,this.yt),this.remoteDocumentCache=qi(this.yt),this.Ns=new Ls,this.window&&this.window.localStorage?this.oi=this.window.localStorage:(this.oi=null,!1===c&&g("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.ui().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new E(T.FAILED_PRECONDITION,oo);return this.ci(),this.ai(),this.hi(),this.runTransaction("getHighestListenSequenceNumber","readonly",(e=>this.Cs.getHighestSequenceNumber(e)))})).then((e=>{this.Ss=new ge(e,this.Js)})).then((()=>{this.Ds=!0})).catch((e=>(this.ri&&this.ri.close(),Promise.reject(e))))}li(e){return this.si=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.ri.L((async t=>{null===t.newVersion&&await e()}))}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Hs.enqueueAndForget((async()=>{this.started&&await this.ui()})))}ui(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(e=>co(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.fi(e).next((e=>{e||(this.isPrimary=!1,this.Hs.enqueueRetryable((()=>this.si(!1))))}))})).next((()=>this.di(e))).next((t=>this.isPrimary&&!t?this._i(e).next((()=>!1)):!!t&&this.wi(e).next((()=>!0)))))).catch((e=>{if(ue(e))return m("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return m("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1})).then((e=>{this.isPrimary!==e&&this.Hs.enqueueRetryable((()=>this.si(e))),this.isPrimary=e}))}fi(e){return uo(e).get("owner").next((e=>re.resolve(this.mi(e))))}gi(e){return co(e).delete(this.clientId)}async yi(){if(this.isPrimary&&!this.pi(this.ni,18e5)){this.ni=Date.now();const e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(e=>{const t=vs(e,"clientMetadata");return t.W().next((e=>{const n=this.Ii(e,18e5),r=e.filter((e=>-1===n.indexOf(e)));return re.forEach(r,(e=>t.delete(e.clientId))).next((()=>r))}))})).catch((()=>[]));if(this.oi)for(const t of e)this.oi.removeItem(this.Ti(t.clientId))}}hi(){this.ei=this.Hs.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.ui().then((()=>this.yi())).then((()=>this.hi()))))}mi(e){return!!e&&e.ownerId===this.clientId}di(e){return this.Ys?re.resolve(!0):uo(e).get("owner").next((t=>{if(null!==t&&this.pi(t.leaseTimestampMs,5e3)&&!this.Ei(t.ownerId)){if(this.mi(t)&&this.networkEnabled)return!0;if(!this.mi(t)){if(!t.allowTabSynchronization)throw new E(T.FAILED_PRECONDITION,oo);return!1}}return!(!this.networkEnabled||!this.inForeground)||co(e).W().next((e=>void 0===this.Ii(e,5e3).find((e=>{if(this.clientId!==e.clientId){const t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))))})).next((e=>(this.isPrimary!==e&&m("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e)))}async shutdown(){this.Ds=!1,this.Ai(),this.ei&&(this.ei.cancel(),this.ei=null),this.Ri(),this.bi(),await this.ri.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(e=>{const t=new ws(e,ge.at);return this._i(t).next((()=>this.gi(t)))})),this.ri.close(),this.Pi()}Ii(e,t){return e.filter((e=>this.pi(e.updateTimeMs,t)&&!this.Ei(e.clientId)))}vi(){return this.runTransaction("getActiveClients","readonly",(e=>co(e).W().next((e=>this.Ii(e,18e5).map((e=>e.clientId))))))}get started(){return this.Ds}getMutationQueue(e,t){return Ii.re(e,this.yt,t,this.referenceDelegate)}getTargetCache(){return this.Cs}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new li(e,this.yt.ie.databaseId)}getDocumentOverlayCache(e){return Ps.re(this.yt,e)}getBundleCache(){return this.Ns}runTransaction(e,t,n){m("IndexedDbPersistence","Starting transaction:",e);const r="readonly"===t?"readonly":"readwrite",s=15===(i=this.Xs)?ys:14===i?ps:13===i?gs:12===i?ms:11===i?fs:void w();var i;let o;return this.ri.runTransaction(e,r,s,(r=>(o=new ws(r,this.Ss?this.Ss.next():ge.at),"readwrite-primary"===t?this.fi(o).next((e=>!!e||this.di(o))).next((t=>{if(!t)throw g(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.Hs.enqueueRetryable((()=>this.si(!1))),new E(T.FAILED_PRECONDITION,ee);return n(o)})).next((e=>this.wi(o).next((()=>e)))):this.Vi(o).next((()=>n(o)))))).then((e=>(o.raiseOnCommittedEvent(),e)))}Vi(e){return uo(e).get("owner").next((e=>{if(null!==e&&this.pi(e.leaseTimestampMs,5e3)&&!this.Ei(e.ownerId)&&!this.mi(e)&&!(this.Ys||this.allowTabSynchronization&&e.allowTabSynchronization))throw new E(T.FAILED_PRECONDITION,oo)}))}wi(e){const t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return uo(e).put("owner",t)}static C(){return ie.C()}_i(e){const t=uo(e);return t.get("owner").next((e=>this.mi(e)?(m("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):re.resolve()))}pi(e,t){const n=Date.now();return!(e<n-t)&&(!(e>n)||(g(`Detected an update time that is in the future: ${e} > ${n}`),!1))}ci(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ti=()=>{this.Hs.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.ui())))},this.document.addEventListener("visibilitychange",this.ti),this.inForeground="visible"===this.document.visibilityState)}Ri(){this.ti&&(this.document.removeEventListener("visibilitychange",this.ti),this.ti=null)}ai(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.Zs=()=>{this.Ai(),Object(o.z)()&&navigator.appVersion.match(/Version\/1[45]/)&&this.Hs.enterRestrictedMode(!0),this.Hs.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.Zs))}bi(){this.Zs&&(this.window.removeEventListener("pagehide",this.Zs),this.Zs=null)}Ei(e){var t;try{const n=null!==(null===(t=this.oi)||void 0===t?void 0:t.getItem(this.Ti(e)));return m("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return g("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}Ai(){if(this.oi)try{this.oi.setItem(this.Ti(this.clientId),String(Date.now()))}catch(e){g("Failed to set zombie client id.",e)}}Pi(){if(this.oi)try{this.oi.removeItem(this.Ti(this.clientId))}catch(e){}}Ti(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function uo(e){return vs(e,"owner")}function co(e){return vs(e,"clientMetadata")}function lo(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class ho{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Si=n,this.Di=r}static Ci(e,t){let n=tr(),r=tr();for(const s of t.docChanges)switch(s.type){case 0:n=n.add(s.doc.key);break;case 1:r=r.add(s.doc.key)}return new ho(e,t.fromCache,n,r)}}class fo{constructor(){this.xi=!1}initialize(e,t){this.Ni=e,this.indexManager=t,this.xi=!0}getDocumentsMatchingQuery(e,t,n,r){return this.ki(e,t).next((s=>s||this.Oi(e,t,r,n))).next((n=>n||this.Mi(e,t)))}ki(e,t){if(jt(t))return re.resolve(null);let n=Yt(t);return this.indexManager.getIndexType(e,n).next((r=>0===r?null:(null!==t.limit&&1===r&&(t=Zt(t,null,"F"),n=Yt(t)),this.indexManager.getDocumentsMatchingTarget(e,n).next((r=>{const s=tr(...r);return this.Ni.getDocuments(e,s).next((r=>this.indexManager.getMinOffset(e,n).next((n=>{const i=this.Fi(t,r);return this.$i(t,i,s,n.readTime)?this.ki(e,Zt(t,null,"F")):this.Bi(e,i,t,n)}))))})))))}Oi(e,t,n,r){return jt(t)||r.isEqual(P.min())?this.Mi(e,t):this.Ni.getDocuments(e,n).next((s=>{const o=this.Fi(t,s);return this.$i(t,o,n,r)?this.Mi(e,t):(d()<=i.a.DEBUG&&m("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),tn(t)),this.Bi(e,o,t,Y(r,-1)))}))}Fi(e,t){let n=new Dt(sn(e));return t.forEach(((t,r)=>{nn(e,r)&&(n=n.add(r))})),n}$i(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const s="F"===e.limitType?t.last():t.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(r)>0)}Mi(e,t){return d()<=i.a.DEBUG&&m("QueryEngine","Using full collection scan to execute query:",tn(t)),this.Ni.getDocumentsMatchingQuery(e,t,Z.min())}Bi(e,t,n,r){return this.Ni.getDocumentsMatchingQuery(e,n,r).next((e=>(t.forEach((t=>{e=e.insert(t.key,t)})),e)))}}class mo{constructor(e,t,n,r){this.persistence=e,this.Li=t,this.yt=r,this.qi=new St(F),this.Ui=new $n((e=>Lt(e)),Ot),this.Ki=new Map,this.Gi=e.getRemoteDocumentCache(),this.Cs=e.getTargetCache(),this.Ns=e.getBundleCache(),this.Qi(n)}Qi(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new Qi(this.Gi,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Gi.setIndexManager(this.indexManager),this.Li.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(t=>e.collect(t,this.qi)))}}function go(e,t,n,r){return new mo(e,t,n,r)}async function po(e,t){const n=b(e);return await n.persistence.runTransaction("Handle user change","readonly",(e=>{let r;return n.mutationQueue.getAllMutationBatches(e).next((s=>(r=s,n.Qi(t),n.mutationQueue.getAllMutationBatches(e)))).next((t=>{const s=[],i=[];let o=tr();for(const e of r){s.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}for(const e of t){i.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}return n.localDocuments.getDocuments(e,o).next((e=>({ji:e,removedBatchIds:s,addedBatchIds:i})))}))}))}function yo(e){const t=b(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",(e=>t.Cs.getLastRemoteSnapshotVersion(e)))}function wo(e,t,n){let r=tr(),s=tr();return n.forEach((e=>r=r.add(e))),t.getEntries(e,r).next((e=>{let r=Qn();return n.forEach(((n,i)=>{const o=e.get(n);i.isFoundDocument()!==o.isFoundDocument()&&(s=s.add(n)),i.isNoDocument()&&i.version.isEqual(P.min())?(t.removeEntry(n,i.readTime),r=r.insert(n,i)):!o.isValidDocument()||i.version.compareTo(o.version)>0||0===i.version.compareTo(o.version)&&o.hasPendingWrites?(t.addEntry(i),r=r.insert(n,i)):m("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",i.version)})),{Wi:r,zi:s}}))}function vo(e,t){const n=b(e);return n.persistence.runTransaction("Get next mutation batch","readonly",(e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t))))}function Io(e,t){const n=b(e);return n.persistence.runTransaction("Allocate target","readwrite",(e=>{let r;return n.Cs.getTargetData(e,t).next((s=>s?(r=s,re.resolve(r)):n.Cs.allocateTargetId(e).next((s=>(r=new Es(t,s,0,e.currentSequenceNumber),n.Cs.addTargetData(e,r).next((()=>r)))))))})).then((e=>{const r=n.qi.get(e.targetId);return(null===r||e.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.qi=n.qi.insert(e.targetId,e),n.Ui.set(t,e.targetId)),e}))}async function bo(e,t,n){const r=b(e),s=r.qi.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,(e=>r.persistence.referenceDelegate.removeTarget(e,s)))}catch(e){if(!ue(e))throw e;m("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.qi=r.qi.remove(t),r.Ui.delete(s.target)}function To(e,t,n){const r=b(e);let s=P.min(),i=tr();return r.persistence.runTransaction("Execute query","readonly",(e=>function(e,t,n){const r=b(e),s=r.Ui.get(n);return void 0!==s?re.resolve(r.qi.get(s)):r.Cs.getTargetData(t,n)}(r,e,Yt(t)).next((t=>{if(t)return s=t.lastLimboFreeSnapshotVersion,r.Cs.getMatchingKeysForTargetId(e,t.targetId).next((e=>{i=e}))})).next((()=>r.Li.getDocumentsMatchingQuery(e,t,n?s:P.min(),n?i:tr()))).next((e=>(xo(r,rn(t),e),{documents:e,Hi:i})))))}function Eo(e,t){const n=b(e),r=b(n.Cs),s=n.qi.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",(e=>r.ne(e,t).next((e=>e?e.target:null))))}function So(e,t){const n=b(e),r=n.Ki.get(t)||P.min();return n.persistence.runTransaction("Get new document changes","readonly",(e=>n.Gi.getAllFromCollectionGroup(e,t,Y(r,-1),Number.MAX_SAFE_INTEGER))).then((e=>(xo(n,t,e),e)))}function xo(e,t,n){let r=e.Ki.get(t)||P.min();n.forEach(((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)})),e.Ki.set(t,r)}async function _o(e,t,n=tr()){const r=await Io(e,Yt(Rs(t.bundledQuery))),s=b(e);return s.persistence.runTransaction("Save named query","readwrite",(e=>{const i=Ir(t.readTime);if(r.snapshotVersion.compareTo(i)>=0)return s.Ns.saveNamedQuery(e,t);const o=r.withResumeToken(xe.EMPTY_BYTE_STRING,i);return s.qi=s.qi.insert(o.targetId,o),s.Cs.updateTargetData(e,o).next((()=>s.Cs.removeMatchingKeysForTargetId(e,r.targetId))).next((()=>s.Cs.addMatchingKeys(e,n,r.targetId))).next((()=>s.Ns.saveNamedQuery(e,t)))}))}function Do(e,t){return`firestore_clients_${e}_${t}`}function No(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function Co(e,t){return`firestore_targets_${e}_${t}`}class ko{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Zi(e,t,n){const r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new E(r.error.code,r.error.message))),i?new ko(e,t,r.state,s):(g("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}tr(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Ao{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Zi(e,t){const n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new E(n.error.code,n.error.message))),s?new Ao(e,n.state,r):(g("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}tr(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Ro{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Zi(e,t){const n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=rr();for(let i=0;r&&i<n.activeTargetIds.length;++i)r=Ee(n.activeTargetIds[i]),s=s.add(n.activeTargetIds[i]);return r?new Ro(e,s):(g("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class Vo{constructor(e,t){this.clientId=e,this.onlineState=t}static Zi(e){const t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new Vo(t.clientId,t.onlineState):(g("SharedClientState",`Failed to parse online state: ${e}`),null)}}class Mo{constructor(){this.activeTargetIds=rr()}er(e){this.activeTargetIds=this.activeTargetIds.add(e)}nr(e){this.activeTargetIds=this.activeTargetIds.delete(e)}tr(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class Fo{constructor(e,t,n,r,s){this.window=e,this.Hs=t,this.persistenceKey=n,this.sr=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ir=this.rr.bind(this),this.ur=new St(F),this.started=!1,this.cr=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.ar=Do(this.persistenceKey,this.sr),this.hr=function(e){return`firestore_sequence_number_${e}`}(this.persistenceKey),this.ur=this.ur.insert(this.sr,new Mo),this.lr=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.dr=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this._r=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.wr=function(e){return`firestore_online_state_${e}`}(this.persistenceKey),this.mr=function(e){return`firestore_bundle_loaded_v2_${e}`}(this.persistenceKey),this.window.addEventListener("storage",this.ir)}static C(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.vi();for(const n of e){if(n===this.sr)continue;const e=this.getItem(Do(this.persistenceKey,n));if(e){const t=Ro.Zi(n,e);t&&(this.ur=this.ur.insert(t.clientId,t))}}this.gr();const t=this.storage.getItem(this.wr);if(t){const e=this.yr(t);e&&this.pr(e)}for(const n of this.cr)this.rr(n);this.cr=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(e){this.setItem(this.hr,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Ir(this.ur)}isActiveQueryTarget(e){let t=!1;return this.ur.forEach(((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)})),t}addPendingMutation(e){this.Tr(e,"pending")}updateMutationState(e,t,n){this.Tr(e,t,n),this.Er(e)}addLocalQueryTarget(e){let t="not-current";if(this.isActiveQueryTarget(e)){const n=this.storage.getItem(Co(this.persistenceKey,e));if(n){const r=Ao.Zi(e,n);r&&(t=r.state)}}return this.Ar.er(e),this.gr(),t}removeLocalQueryTarget(e){this.Ar.nr(e),this.gr()}isLocalQueryTarget(e){return this.Ar.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(Co(this.persistenceKey,e))}updateQueryState(e,t,n){this.Rr(e,t,n)}handleUserChange(e,t,n){t.forEach((e=>{this.Er(e)})),this.currentUser=e,n.forEach((e=>{this.addPendingMutation(e)}))}setOnlineState(e){this.br(e)}notifyBundleLoaded(e){this.Pr(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ir),this.removeItem(this.ar),this.started=!1)}getItem(e){const t=this.storage.getItem(e);return m("SharedClientState","READ",e,t),t}setItem(e,t){m("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){m("SharedClientState","REMOVE",e),this.storage.removeItem(e)}rr(e){const t=e;if(t.storageArea===this.storage){if(m("SharedClientState","EVENT",t.key,t.newValue),t.key===this.ar)return void g("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Hs.enqueueRetryable((async()=>{if(this.started){if(null!==t.key)if(this.lr.test(t.key)){if(null==t.newValue){const e=this.vr(t.key);return this.Vr(e,null)}{const e=this.Sr(t.key,t.newValue);if(e)return this.Vr(e.clientId,e)}}else if(this.dr.test(t.key)){if(null!==t.newValue){const e=this.Dr(t.key,t.newValue);if(e)return this.Cr(e)}}else if(this._r.test(t.key)){if(null!==t.newValue){const e=this.Nr(t.key,t.newValue);if(e)return this.kr(e)}}else if(t.key===this.wr){if(null!==t.newValue){const e=this.yr(t.newValue);if(e)return this.pr(e)}}else if(t.key===this.hr){const e=function(e){let t=ge.at;if(null!=e)try{const n=JSON.parse(e);v("number"==typeof n),t=n}catch(e){g("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(t.newValue);e!==ge.at&&this.sequenceNumberHandler(e)}else if(t.key===this.mr){const e=this.Or(t.newValue);await Promise.all(e.map((e=>this.syncEngine.Mr(e))))}}else this.cr.push(t)}))}}get Ar(){return this.ur.get(this.sr)}gr(){this.setItem(this.ar,this.Ar.tr())}Tr(e,t,n){const r=new ko(this.currentUser,e,t,n),s=No(this.persistenceKey,this.currentUser,e);this.setItem(s,r.tr())}Er(e){const t=No(this.persistenceKey,this.currentUser,e);this.removeItem(t)}br(e){const t={clientId:this.sr,onlineState:e};this.storage.setItem(this.wr,JSON.stringify(t))}Rr(e,t,n){const r=Co(this.persistenceKey,e),s=new Ao(e,t,n);this.setItem(r,s.tr())}Pr(e){const t=JSON.stringify(Array.from(e));this.setItem(this.mr,t)}vr(e){const t=this.lr.exec(e);return t?t[1]:null}Sr(e,t){const n=this.vr(e);return Ro.Zi(n,t)}Dr(e,t){const n=this.dr.exec(e),r=Number(n[1]),s=void 0!==n[2]?n[2]:null;return ko.Zi(new c(s),r,t)}Nr(e,t){const n=this._r.exec(e),r=Number(n[1]);return Ao.Zi(r,t)}yr(e){return Vo.Zi(e)}Or(e){return JSON.parse(e)}async Cr(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Fr(e.batchId,e.state,e.error);m("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}kr(e){return this.syncEngine.$r(e.targetId,e.state,e.error)}Vr(e,t){const n=t?this.ur.insert(e,t):this.ur.remove(e),r=this.Ir(this.ur),s=this.Ir(n),i=[],o=[];return s.forEach((e=>{r.has(e)||i.push(e)})),r.forEach((e=>{s.has(e)||o.push(e)})),this.syncEngine.Br(i,o).then((()=>{this.ur=n}))}pr(e){this.ur.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Ir(e){let t=rr();return e.forEach(((e,n)=>{t=t.unionWith(n.activeTargetIds)})),t}}class Lo{constructor(){this.Lr=new Mo,this.qr={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.Lr.er(e),this.qr[e]||"not-current"}updateQueryState(e,t,n){this.qr[e]=t}removeLocalQueryTarget(e){this.Lr.nr(e)}isLocalQueryTarget(e){return this.Lr.activeTargetIds.has(e)}clearQueryState(e){delete this.qr[e]}getAllActiveQueryTargets(){return this.Lr.activeTargetIds}isActiveQueryTarget(e){return this.Lr.activeTargetIds.has(e)}start(){return this.Lr=new Mo,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class Oo{Ur(e){}shutdown(){}}class qo{constructor(){this.Kr=()=>this.Gr(),this.Qr=()=>this.jr(),this.Wr=[],this.zr()}Ur(e){this.Wr.push(e)}shutdown(){window.removeEventListener("online",this.Kr),window.removeEventListener("offline",this.Qr)}zr(){window.addEventListener("online",this.Kr),window.addEventListener("offline",this.Qr)}Gr(){m("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.Wr)e(0)}jr(){m("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.Wr)e(1)}static C(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const Po={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class Uo{constructor(e){this.Hr=e.Hr,this.Jr=e.Jr}Yr(e){this.Xr=e}Zr(e){this.eo=e}onMessage(e){this.no=e}close(){this.Jr()}send(e){this.Hr(e)}so(){this.Xr()}io(e){this.eo(e)}ro(e){this.no(e)}}class Bo extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http";this.oo=t+"://"+e.host,this.uo="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}get co(){return!1}ao(e,t,n,r,s){const i=this.ho(e,t);m("RestConnection","Sending: ",i,n);const o={};return this.lo(o,r,s),this.fo(e,i,o,n).then((e=>(m("RestConnection","Received: ",e),e)),(t=>{throw p("RestConnection",`${e} failed with error: `,t,"url: ",i,"request:",n),t}))}_o(e,t,n,r,s,i){return this.ao(e,t,n,r,s)}lo(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+l,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach(((t,n)=>e[n]=t)),n&&n.headers.forEach(((t,n)=>e[n]=t))}ho(e,t){const n=Po[e];return`${this.oo}/v1/${t}:${n}`}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams}fo(e,t,n,r){return new Promise(((s,i)=>{const o=new a.g;o.setWithCredentials(!0),o.listenOnce(a.c.COMPLETE,(()=>{try{switch(o.getLastErrorCode()){case a.a.NO_ERROR:const t=o.getResponseJson();m("Connection","XHR received:",JSON.stringify(t)),s(t);break;case a.a.TIMEOUT:m("Connection",'RPC "'+e+'" timed out'),i(new E(T.DEADLINE_EXCEEDED,"Request time out"));break;case a.a.HTTP_ERROR:const n=o.getStatus();if(m("Connection",'RPC "'+e+'" failed with status:',n,"response text:",o.getResponseText()),n>0){let e=o.getResponseJson();Array.isArray(e)&&(e=e[0]);const t=null==e?void 0:e.error;if(t&&t.status&&t.message){const e=function(e){const t=e.toLowerCase().replace(/_/g,"-");return Object.values(T).indexOf(t)>=0?t:T.UNKNOWN}(t.status);i(new E(e,t.message))}else i(new E(T.UNKNOWN,"Server responded with status "+o.getStatus()))}else i(new E(T.UNAVAILABLE,"Connection failed."));break;default:w()}}finally{m("Connection",'RPC "'+e+'" completed.')}}));const u=JSON.stringify(r);o.send(t,"POST",u,n,15)}))}wo(e,t,n){const r=[this.oo,"/","google.firestore.v1.Firestore","/",e,"/channel"],s=Object(a.h)(),i=Object(a.i)(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(o.xmlHttpFactory=new a.d({})),this.lo(o.initMessageHeaders,t,n),o.encodeInitMessageHeaders=!0;const u=r.join("");m("Connection","Creating WebChannel: "+u,o);const c=s.createWebChannel(u,o);let l=!1,h=!1;const d=new Uo({Hr:e=>{h?m("Connection","Not sending because WebChannel is closed:",e):(l||(m("Connection","Opening WebChannel transport."),c.open(),l=!0),m("Connection","WebChannel sending:",e),c.send(e))},Jr:()=>c.close()}),f=(e,t,n)=>{e.listen(t,(e=>{try{n(e)}catch(e){setTimeout((()=>{throw e}),0)}}))};return f(c,a.f.EventType.OPEN,(()=>{h||m("Connection","WebChannel transport opened.")})),f(c,a.f.EventType.CLOSE,(()=>{h||(h=!0,m("Connection","WebChannel transport closed"),d.io())})),f(c,a.f.EventType.ERROR,(e=>{h||(h=!0,p("Connection","WebChannel transport errored:",e),d.io(new E(T.UNAVAILABLE,"The operation could not be completed")))})),f(c,a.f.EventType.MESSAGE,(e=>{var t;if(!h){const n=e.data[0];v(!!n);const r=n,s=r.error||(null===(t=r[0])||void 0===t?void 0:t.error);if(s){m("Connection","WebChannel received error:",s);const e=s.status;let t=function(e){const t=Un[e];if(void 0!==t)return Gn(t)}(e),n=s.message;void 0===t&&(t=T.INTERNAL,n="Unknown error status: "+e+" with message "+s.message),h=!0,d.io(new E(t,n)),c.close()}else m("Connection","WebChannel received:",n),d.ro(n)}})),f(i,a.b.STAT_EVENT,(e=>{e.stat===a.e.PROXY?m("Connection","Detected buffering proxy"):e.stat===a.e.NOPROXY&&m("Connection","Detected no buffering proxy")})),setTimeout((()=>{d.so()}),0),d}}function Ko(){return"undefined"!=typeof window?window:null}function Go(){return"undefined"!=typeof document?document:null}function $o(e){return new pr(e,!0)}class jo{constructor(e,t,n=1e3,r=1.5,s=6e4){this.Hs=e,this.timerId=t,this.mo=n,this.yo=r,this.po=s,this.Io=0,this.To=null,this.Eo=Date.now(),this.reset()}reset(){this.Io=0}Ao(){this.Io=this.po}Ro(e){this.cancel();const t=Math.floor(this.Io+this.bo()),n=Math.max(0,Date.now()-this.Eo),r=Math.max(0,t-n);r>0&&m("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Io} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.To=this.Hs.enqueueAfterDelay(this.timerId,r,(()=>(this.Eo=Date.now(),e()))),this.Io*=this.yo,this.Io<this.mo&&(this.Io=this.mo),this.Io>this.po&&(this.Io=this.po)}Po(){null!==this.To&&(this.To.skipDelay(),this.To=null)}cancel(){null!==this.To&&(this.To.cancel(),this.To=null)}bo(){return(Math.random()-.5)*this.Io}}class Qo{constructor(e,t,n,r,s,i,o,a){this.Hs=e,this.vo=n,this.Vo=r,this.connection=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.So=0,this.Do=null,this.Co=null,this.stream=null,this.xo=new jo(e,t)}No(){return 1===this.state||5===this.state||this.ko()}ko(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Oo()}async stop(){this.No()&&await this.close(0)}Mo(){this.state=0,this.xo.reset()}Fo(){this.ko()&&null===this.Do&&(this.Do=this.Hs.enqueueAfterDelay(this.vo,6e4,(()=>this.$o())))}Bo(e){this.Lo(),this.stream.send(e)}async $o(){if(this.ko())return this.close(0)}Lo(){this.Do&&(this.Do.cancel(),this.Do=null)}qo(){this.Co&&(this.Co.cancel(),this.Co=null)}async close(e,t){this.Lo(),this.qo(),this.xo.cancel(),this.So++,4!==e?this.xo.reset():t&&t.code===T.RESOURCE_EXHAUSTED?(g(t.toString()),g("Using maximum backoff delay to prevent overloading the backend."),this.xo.Ao()):t&&t.code===T.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Uo(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Zr(t)}Uo(){}auth(){this.state=1;const e=this.Ko(this.So),t=this.So;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([e,n])=>{this.So===t&&this.Go(e,n)}),(t=>{e((()=>{const e=new E(T.UNKNOWN,"Fetching auth token failed: "+t.message);return this.Qo(e)}))}))}Go(e,t){const n=this.Ko(this.So);this.stream=this.jo(e,t),this.stream.Yr((()=>{n((()=>(this.state=2,this.Co=this.Hs.enqueueAfterDelay(this.Vo,1e4,(()=>(this.ko()&&(this.state=3),Promise.resolve()))),this.listener.Yr())))})),this.stream.Zr((e=>{n((()=>this.Qo(e)))})),this.stream.onMessage((e=>{n((()=>this.onMessage(e)))}))}Oo(){this.state=5,this.xo.Ro((async()=>{this.state=0,this.start()}))}Qo(e){return m("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}Ko(e){return t=>{this.Hs.enqueueAndForget((()=>this.So===e?t():(m("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class zo extends Qo{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.yt=s}jo(e,t){return this.connection.wo("Listen",e,t)}onMessage(e){this.xo.reset();const t=function(e,t){let n;if("targetChange"in t){t.targetChange;const r=function(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:w()}(t.targetChange.targetChangeType||"NO_CHANGE"),s=t.targetChange.targetIds||[],i=function(e,t){return e.wt?(v(void 0===t||"string"==typeof t),xe.fromBase64String(t||"")):(v(void 0===t||t instanceof Uint8Array),xe.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(e){const t=void 0===e.code?T.UNKNOWN:Gn(e.code);return new E(t,e.message||"")}(o);n=new ur(r,s,i,a||null)}else if("documentChange"in t){t.documentChange;const r=t.documentChange;r.document,r.document.name,r.document.updateTime;const s=Sr(e,r.document.name),i=Ir(r.document.updateTime),o=r.document.createTime?Ir(r.document.createTime):P.min(),a=new At({mapValue:{fields:r.document.fields}}),u=Vt.newFoundDocument(s,i,o,a),c=r.targetIds||[],l=r.removedTargetIds||[];n=new or(c,l,u.key,u)}else if("documentDelete"in t){t.documentDelete;const r=t.documentDelete;r.document;const s=Sr(e,r.document),i=r.readTime?Ir(r.readTime):P.min(),o=Vt.newNoDocument(s,i),a=r.removedTargetIds||[];n=new or([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const r=t.documentRemove;r.document;const s=Sr(e,r.document),i=r.removedTargetIds||[];n=new or([],i,s,null)}else{if(!("filter"in t))return w();{t.filter;const e=t.filter;e.targetId;const r=e.count||0,s=new Pn(r),i=e.targetId;n=new ar(i,s)}}return n}(this.yt,e),n=function(e){if(!("targetChange"in e))return P.min();const t=e.targetChange;return t.targetIds&&t.targetIds.length?P.min():t.readTime?Ir(t.readTime):P.min()}(e);return this.listener.Wo(t,n)}zo(e){const t={};t.database=Dr(this.yt),t.addTarget=function(e,t){let n;const r=t.target;return n=qt(r)?{documents:Vr(e,r)}:{query:Mr(e,r)},n.targetId=t.targetId,t.resumeToken.approximateByteSize()>0?n.resumeToken=wr(e,t.resumeToken):t.snapshotVersion.compareTo(P.min())>0&&(n.readTime=yr(e,t.snapshotVersion.toTimestamp())),n}(this.yt,e);const n=function(e,t){const n=function(e,t){switch(t){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return w()}}(0,t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.yt,e);n&&(t.labels=n),this.Bo(t)}Ho(e){const t={};t.database=Dr(this.yt),t.removeTarget=e,this.Bo(t)}}class Wo extends Qo{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.yt=s,this.Jo=!1}get Yo(){return this.Jo}start(){this.Jo=!1,this.lastStreamToken=void 0,super.start()}Uo(){this.Jo&&this.Xo([])}jo(e,t){return this.connection.wo("Write",e,t)}onMessage(e){if(v(!!e.streamToken),this.lastStreamToken=e.streamToken,this.Jo){this.xo.reset();const t=function(e,t){return e&&e.length>0?(v(void 0!==t),e.map((e=>function(e,t){let n=e.updateTime?Ir(e.updateTime):Ir(t);return n.isEqual(P.min())&&(n=Ir(t)),new En(n,e.transformResults||[])}(e,t)))):[]}(e.writeResults,e.commitTime),n=Ir(e.commitTime);return this.listener.Zo(n,t)}return v(!e.writeResults||0===e.writeResults.length),this.Jo=!0,this.listener.tu()}eu(){const e={};e.database=Dr(this.yt),this.Bo(e)}Xo(e){const t={streamToken:this.lastStreamToken,writes:e.map((e=>Ar(this.yt,e)))};this.Bo(t)}}class Ho extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.yt=r,this.nu=!1}su(){if(this.nu)throw new E(T.FAILED_PRECONDITION,"The client has already been terminated.")}ao(e,t,n){return this.su(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([r,s])=>this.connection.ao(e,t,n,r,s))).catch((e=>{throw"FirebaseError"===e.name?(e.code===T.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new E(T.UNKNOWN,e.toString())}))}_o(e,t,n,r){return this.su(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,i])=>this.connection._o(e,t,n,s,i,r))).catch((e=>{throw"FirebaseError"===e.name?(e.code===T.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new E(T.UNKNOWN,e.toString())}))}terminate(){this.nu=!0}}class Yo{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.iu=0,this.ru=null,this.ou=!0}uu(){0===this.iu&&(this.cu("Unknown"),this.ru=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.ru=null,this.au("Backend didn't respond within 10 seconds."),this.cu("Offline"),Promise.resolve()))))}hu(e){"Online"===this.state?this.cu("Unknown"):(this.iu++,this.iu>=1&&(this.lu(),this.au(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.cu("Offline")))}set(e){this.lu(),this.iu=0,"Online"===e&&(this.ou=!1),this.cu(e)}cu(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}au(e){const t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.ou?(g(t),this.ou=!1):m("OnlineStateTracker",t)}lu(){null!==this.ru&&(this.ru.cancel(),this.ru=null)}}class Xo{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.fu=[],this.du=new Map,this._u=new Set,this.wu=[],this.mu=s,this.mu.Ur((e=>{n.enqueueAndForget((async()=>{oa(this)&&(m("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=b(e);t._u.add(4),await Jo(t),t.gu.set("Unknown"),t._u.delete(4),await Zo(t)}(this))}))})),this.gu=new Yo(n,r)}}async function Zo(e){if(oa(e))for(const t of e.wu)await t(!0)}async function Jo(e){for(const t of e.wu)await t(!1)}function ea(e,t){const n=b(e);n.du.has(t.targetId)||(n.du.set(t.targetId,t),ia(n)?sa(n):Sa(n).ko()&&na(n,t))}function ta(e,t){const n=b(e),r=Sa(n);n.du.delete(t),r.ko()&&ra(n,t),0===n.du.size&&(r.ko()?r.Fo():oa(n)&&n.gu.set("Unknown"))}function na(e,t){e.yu.Ot(t.targetId),Sa(e).zo(t)}function ra(e,t){e.yu.Ot(t),Sa(e).Ho(t)}function sa(e){e.yu=new lr({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),ne:t=>e.du.get(t)||null}),Sa(e).start(),e.gu.uu()}function ia(e){return oa(e)&&!Sa(e).No()&&e.du.size>0}function oa(e){return 0===b(e)._u.size}function aa(e){e.yu=void 0}async function ua(e){e.du.forEach(((t,n)=>{na(e,t)}))}async function ca(e,t){aa(e),ia(e)?(e.gu.hu(t),sa(e)):e.gu.set("Unknown")}async function la(e,t,n){if(e.gu.set("Online"),t instanceof ur&&2===t.state&&t.cause)try{await async function(e,t){const n=t.cause;for(const r of t.targetIds)e.du.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.du.delete(r),e.yu.removeTarget(r))}(e,t)}catch(n){m("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await ha(e,n)}else if(t instanceof or?e.yu.Kt(t):t instanceof ar?e.yu.Jt(t):e.yu.jt(t),!n.isEqual(P.min()))try{const t=await yo(e.localStore);n.compareTo(t)>=0&&await function(e,t){const n=e.yu.Zt(t);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const s=e.du.get(r);s&&e.du.set(r,s.withResumeToken(n.resumeToken,t))}})),n.targetMismatches.forEach((t=>{const n=e.du.get(t);if(!n)return;e.du.set(t,n.withResumeToken(xe.EMPTY_BYTE_STRING,n.snapshotVersion)),ra(e,t);const r=new Es(n.target,t,1,n.sequenceNumber);na(e,r)})),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){m("RemoteStore","Failed to raise snapshot:",t),await ha(e,t)}}async function ha(e,t,n){if(!ue(t))throw t;e._u.add(1),await Jo(e),e.gu.set("Offline"),n||(n=()=>yo(e.localStore)),e.asyncQueue.enqueueRetryable((async()=>{m("RemoteStore","Retrying IndexedDB access"),await n(),e._u.delete(1),await Zo(e)}))}function da(e,t){return t().catch((n=>ha(e,n,t)))}async function fa(e){const t=b(e),n=xa(t);let r=t.fu.length>0?t.fu[t.fu.length-1].batchId:-1;for(;ma(t);)try{const e=await vo(t.localStore,r);if(null===e){0===t.fu.length&&n.Fo();break}r=e.batchId,ga(t,e)}catch(e){await ha(t,e)}pa(t)&&ya(t)}function ma(e){return oa(e)&&e.fu.length<10}function ga(e,t){e.fu.push(t);const n=xa(e);n.ko()&&n.Yo&&n.Xo(t.mutations)}function pa(e){return oa(e)&&!xa(e).No()&&e.fu.length>0}function ya(e){xa(e).start()}async function wa(e){xa(e).eu()}async function va(e){const t=xa(e);for(const n of e.fu)t.Xo(n.mutations)}async function Ia(e,t,n){const r=e.fu.shift(),s=bs.from(r,t,n);await da(e,(()=>e.remoteSyncer.applySuccessfulWrite(s))),await fa(e)}async function ba(e,t){t&&xa(e).Yo&&await async function(e,t){if(Kn(n=t.code)&&n!==T.ABORTED){const n=e.fu.shift();xa(e).Mo(),await da(e,(()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t))),await fa(e)}var n}(e,t),pa(e)&&ya(e)}async function Ta(e,t){const n=b(e);n.asyncQueue.verifyOperationInProgress(),m("RemoteStore","RemoteStore received new credentials");const r=oa(n);n._u.add(3),await Jo(n),r&&n.gu.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n._u.delete(3),await Zo(n)}async function Ea(e,t){const n=b(e);t?(n._u.delete(2),await Zo(n)):t||(n._u.add(2),await Jo(n),n.gu.set("Unknown"))}function Sa(e){return e.pu||(e.pu=function(e,t,n){const r=b(e);return r.su(),new zo(t,r.connection,r.authCredentials,r.appCheckCredentials,r.yt,n)}(e.datastore,e.asyncQueue,{Yr:ua.bind(null,e),Zr:ca.bind(null,e),Wo:la.bind(null,e)}),e.wu.push((async t=>{t?(e.pu.Mo(),ia(e)?sa(e):e.gu.set("Unknown")):(await e.pu.stop(),aa(e))}))),e.pu}function xa(e){return e.Iu||(e.Iu=function(e,t,n){const r=b(e);return r.su(),new Wo(t,r.connection,r.authCredentials,r.appCheckCredentials,r.yt,n)}(e.datastore,e.asyncQueue,{Yr:wa.bind(null,e),Zr:ba.bind(null,e),tu:va.bind(null,e),Zo:Ia.bind(null,e)}),e.wu.push((async t=>{t?(e.Iu.Mo(),await fa(e)):(await e.Iu.stop(),e.fu.length>0&&(m("RemoteStore",`Stopping write stream with ${e.fu.length} pending writes`),e.fu=[]))}))),e.Iu}class _a{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new S,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((e=>{}))}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,o=new _a(e,t,i,r,s);return o.start(n),o}start(e){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new E(T.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((e=>this.deferred.resolve(e)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Da(e,t){if(g("AsyncQueue",`${t}: ${e}`),ue(e))return new E(T.UNAVAILABLE,`${t}: ${e}`);throw e}class Na{constructor(e){this.comparator=e?(t,n)=>e(t,n)||$.comparator(t.key,n.key):(e,t)=>$.comparator(e.key,t.key),this.keyedMap=Wn(),this.sortedSet=new St(this.comparator)}static emptySet(e){return new Na(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal(((t,n)=>(e(t),!1)))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof Na))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach((t=>{e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new Na;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class Ca{constructor(){this.Tu=new St($.comparator)}track(e){const t=e.doc.key,n=this.Tu.get(t);n?0!==e.type&&3===n.type?this.Tu=this.Tu.insert(t,e):3===e.type&&1!==n.type?this.Tu=this.Tu.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.Tu=this.Tu.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.Tu=this.Tu.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.Tu=this.Tu.remove(t):1===e.type&&2===n.type?this.Tu=this.Tu.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.Tu=this.Tu.insert(t,{type:2,doc:e.doc}):w():this.Tu=this.Tu.insert(t,e)}Eu(){const e=[];return this.Tu.inorderTraversal(((t,n)=>{e.push(n)})),e}}class ka{constructor(e,t,n,r,s,i,o,a,u){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a,this.hasCachedResults=u}static fromInitialDocuments(e,t,n,r,s){const i=[];return t.forEach((e=>{i.push({type:0,doc:e})})),new ka(e,t,Na.emptySet(t),i,n,r,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Jt(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(t[r].type!==n[r].type||!t[r].doc.isEqual(n[r].doc))return!1;return!0}}class Aa{constructor(){this.Au=void 0,this.listeners=[]}}class Ra{constructor(){this.queries=new $n((e=>en(e)),Jt),this.onlineState="Unknown",this.Ru=new Set}}async function Va(e,t){const n=b(e),r=t.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new Aa),s)try{i.Au=await n.onListen(r)}catch(e){const n=Da(e,`Initialization of query '${tn(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,i),i.listeners.push(t),t.bu(n.onlineState),i.Au&&t.Pu(i.Au)&&Oa(n)}async function Ma(e,t){const n=b(e),r=t.query;let s=!1;const i=n.queries.get(r);if(i){const e=i.listeners.indexOf(t);e>=0&&(i.listeners.splice(e,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function Fa(e,t){const n=b(e);let r=!1;for(const s of t){const e=s.query,t=n.queries.get(e);if(t){for(const e of t.listeners)e.Pu(s)&&(r=!0);t.Au=s}}r&&Oa(n)}function La(e,t,n){const r=b(e),s=r.queries.get(t);if(s)for(const i of s.listeners)i.onError(n);r.queries.delete(t)}function Oa(e){e.Ru.forEach((e=>{e.next()}))}class qa{constructor(e,t,n){this.query=e,this.vu=t,this.Vu=!1,this.Su=null,this.onlineState="Unknown",this.options=n||{}}Pu(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new ka(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Vu?this.Du(e)&&(this.vu.next(e),t=!0):this.Cu(e,this.onlineState)&&(this.xu(e),t=!0),this.Su=e,t}onError(e){this.vu.error(e)}bu(e){this.onlineState=e;let t=!1;return this.Su&&!this.Vu&&this.Cu(this.Su,e)&&(this.xu(this.Su),t=!0),t}Cu(e,t){if(!e.fromCache)return!0;const n="Offline"!==t;return(!this.options.Nu||!n)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}Du(e){if(e.docChanges.length>0)return!0;const t=this.Su&&this.Su.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}xu(e){e=ka.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Vu=!0,this.vu.next(e)}}class Pa{constructor(e,t){this.ku=e,this.byteLength=t}Ou(){return"metadata"in this.ku}}class Ua{constructor(e){this.yt=e}Ji(e){return Sr(this.yt,e)}Yi(e){return e.metadata.exists?kr(this.yt,e.document,!1):Vt.newNoDocument(this.Ji(e.metadata.name),this.Xi(e.metadata.readTime))}Xi(e){return Ir(e)}}class Ba{constructor(e,t,n){this.Mu=e,this.localStore=t,this.yt=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Ka(e)}Fu(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.ku.namedQuery)this.queries.push(e.ku.namedQuery);else if(e.ku.documentMetadata){this.documents.push({metadata:e.ku.documentMetadata}),e.ku.documentMetadata.exists||++t;const n=B.fromString(e.ku.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.ku.document&&(this.documents[this.documents.length-1].document=e.ku.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}$u(e){const t=new Map,n=new Ua(this.yt);for(const r of e)if(r.metadata.queries){const e=n.Ji(r.metadata.name);for(const n of r.metadata.queries){const r=(t.get(n)||tr()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const s=b(e);let i=tr(),o=Qn();for(const c of n){const e=t.Ji(c.metadata.name);c.document&&(i=i.add(e));const n=t.Yi(c);n.setReadTime(t.Xi(c.metadata.readTime)),o=o.insert(e,n)}const a=s.Gi.newChangeBuffer({trackRemovals:!0}),u=await Io(s,function(e){return Yt($t(B.fromString(`__bundle__/docs/${e}`)))}(r));return s.persistence.runTransaction("Apply bundle documents","readwrite",(e=>wo(e,a,o).next((t=>(a.apply(e),t))).next((t=>s.Cs.removeMatchingKeysForTargetId(e,u.targetId).next((()=>s.Cs.addMatchingKeys(e,i,u.targetId))).next((()=>s.localDocuments.getLocalViewOfDocuments(e,t.Wi,t.zi))).next((()=>t.Wi))))))}(this.localStore,new Ua(this.yt),this.documents,this.Mu.id),t=this.$u(this.documents);for(const n of this.queries)await _o(this.localStore,n,t.get(n.name));return this.progress.taskState="Success",{progress:this.progress,Bu:this.collectionGroups,Lu:e}}}function Ka(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class Ga{constructor(e){this.key=e}}class $a{constructor(e){this.key=e}}class ja{constructor(e,t){this.query=e,this.qu=t,this.Uu=null,this.hasCachedResults=!1,this.current=!1,this.Ku=tr(),this.mutatedKeys=tr(),this.Gu=sn(e),this.Qu=new Na(this.Gu)}get ju(){return this.qu}Wu(e,t){const n=t?t.zu:new Ca,r=t?t.Qu:this.Qu;let s=t?t.mutatedKeys:this.mutatedKeys,i=r,o=!1;const a="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,u="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal(((e,t)=>{const c=r.get(e),l=nn(this.query,t)?t:null,h=!!c&&this.mutatedKeys.has(c.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;c&&l?c.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.Hu(c,l)||(n.track({type:2,doc:l}),f=!0,(a&&this.Gu(l,a)>0||u&&this.Gu(l,u)<0)&&(o=!0)):!c&&l?(n.track({type:0,doc:l}),f=!0):c&&!l&&(n.track({type:1,doc:c}),f=!0,(a||u)&&(o=!0)),f&&(l?(i=i.add(l),s=d?s.add(e):s.delete(e)):(i=i.delete(e),s=s.delete(e)))})),null!==this.query.limit)for(;i.size>this.query.limit;){const e="F"===this.query.limitType?i.last():i.first();i=i.delete(e.key),s=s.delete(e.key),n.track({type:1,doc:e})}return{Qu:i,zu:n,$i:o,mutatedKeys:s}}Hu(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){const r=this.Qu;this.Qu=e.Qu,this.mutatedKeys=e.mutatedKeys;const s=e.zu.Eu();s.sort(((e,t)=>function(e,t){const n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return w()}};return n(e)-n(t)}(e.type,t.type)||this.Gu(e.doc,t.doc))),this.Ju(n);const i=t?this.Yu():[],o=0===this.Ku.size&&this.current?1:0,a=o!==this.Uu;return this.Uu=o,0!==s.length||a?{snapshot:new ka(this.query,e.Qu,r,s,e.mutatedKeys,0===o,a,!1,!!n&&n.resumeToken.approximateByteSize()>0),Xu:i}:{Xu:i}}bu(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Qu:this.Qu,zu:new Ca,mutatedKeys:this.mutatedKeys,$i:!1},!1)):{Xu:[]}}Zu(e){return!this.qu.has(e)&&!!this.Qu.has(e)&&!this.Qu.get(e).hasLocalMutations}Ju(e){e&&(e.addedDocuments.forEach((e=>this.qu=this.qu.add(e))),e.modifiedDocuments.forEach((e=>{})),e.removedDocuments.forEach((e=>this.qu=this.qu.delete(e))),this.current=e.current)}Yu(){if(!this.current)return[];const e=this.Ku;this.Ku=tr(),this.Qu.forEach((e=>{this.Zu(e.key)&&(this.Ku=this.Ku.add(e.key))}));const t=[];return e.forEach((e=>{this.Ku.has(e)||t.push(new $a(e))})),this.Ku.forEach((n=>{e.has(n)||t.push(new Ga(n))})),t}tc(e){this.qu=e.Hi,this.Ku=tr();const t=this.Wu(e.documents);return this.applyChanges(t,!0)}ec(){return ka.fromInitialDocuments(this.query,this.Qu,this.mutatedKeys,0===this.Uu,this.hasCachedResults)}}class Qa{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class za{constructor(e){this.key=e,this.nc=!1}}class Wa{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.sc={},this.ic=new $n((e=>en(e)),Jt),this.rc=new Map,this.oc=new Set,this.uc=new St($.comparator),this.cc=new Map,this.ac=new Hi,this.hc={},this.lc=new Map,this.fc=xi.vn(),this.onlineState="Unknown",this.dc=void 0}get isPrimaryClient(){return!0===this.dc}}async function Ha(e,t){const n=bu(e);let r,s;const i=n.ic.get(t);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.ec();else{const e=await Io(n.localStore,Yt(t));n.isPrimaryClient&&ea(n.remoteStore,e);const i=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,s=await Ya(n,t,r,"current"===i,e.resumeToken)}return s}async function Ya(e,t,n,r,s){e._c=(t,n,r)=>async function(e,t,n,r){let s=t.view.Wu(n);s.$i&&(s=await To(e.localStore,t.query,!1).then((({documents:e})=>t.view.Wu(e,s))));const i=r&&r.targetChanges.get(t.targetId),o=t.view.applyChanges(s,e.isPrimaryClient,i);return au(e,t.targetId,o.Xu),o.snapshot}(e,t,n,r);const i=await To(e.localStore,t,!0),o=new ja(t,i.Hi),a=o.Wu(i.documents),u=ir.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,s),c=o.applyChanges(a,e.isPrimaryClient,u);au(e,n,c.Xu);const l=new Qa(t,n,o);return e.ic.set(t,l),e.rc.has(n)?e.rc.get(n).push(t):e.rc.set(n,[t]),c.snapshot}async function Xa(e,t){const n=b(e),r=n.ic.get(t),s=n.rc.get(r.targetId);if(s.length>1)return n.rc.set(r.targetId,s.filter((e=>!Jt(e,t)))),void n.ic.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await bo(n.localStore,r.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(r.targetId),ta(n.remoteStore,r.targetId),iu(n,r.targetId)})).catch(ne)):(iu(n,r.targetId),await bo(n.localStore,r.targetId,!0))}async function Za(e,t){const n=b(e);try{const e=await function(e,t){const n=b(e),r=t.snapshotVersion;let s=n.qi;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(e=>{const i=n.Gi.newChangeBuffer({trackRemovals:!0});s=n.qi;const o=[];t.targetChanges.forEach(((i,a)=>{const u=s.get(a);if(!u)return;o.push(n.Cs.removeMatchingKeys(e,i.removedDocuments,a).next((()=>n.Cs.addMatchingKeys(e,i.addedDocuments,a))));let c=u.withSequenceNumber(e.currentSequenceNumber);t.targetMismatches.has(a)?c=c.withResumeToken(xe.EMPTY_BYTE_STRING,P.min()).withLastLimboFreeSnapshotVersion(P.min()):i.resumeToken.approximateByteSize()>0&&(c=c.withResumeToken(i.resumeToken,r)),s=s.insert(a,c),function(e,t,n){return 0===e.resumeToken.approximateByteSize()||t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(u,c,i)&&o.push(n.Cs.updateTargetData(e,c))}));let a=Qn(),u=tr();if(t.documentUpdates.forEach((r=>{t.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(e,r))})),o.push(wo(e,i,t.documentUpdates).next((e=>{a=e.Wi,u=e.zi}))),!r.isEqual(P.min())){const t=n.Cs.getLastRemoteSnapshotVersion(e).next((t=>n.Cs.setTargetsMetadata(e,e.currentSequenceNumber,r)));o.push(t)}return re.waitFor(o).next((()=>i.apply(e))).next((()=>n.localDocuments.getLocalViewOfDocuments(e,a,u))).next((()=>a))})).then((e=>(n.qi=s,e)))}(n.localStore,t);t.targetChanges.forEach(((e,t)=>{const r=n.cc.get(t);r&&(v(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),e.addedDocuments.size>0?r.nc=!0:e.modifiedDocuments.size>0?v(r.nc):e.removedDocuments.size>0&&(v(r.nc),r.nc=!1))})),await lu(n,e,t)}catch(e){await ne(e)}}function Ja(e,t,n){const r=b(e);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const e=[];r.ic.forEach(((n,r)=>{const s=r.view.bu(t);s.snapshot&&e.push(s.snapshot)})),function(e,t){const n=b(e);n.onlineState=t;let r=!1;n.queries.forEach(((e,n)=>{for(const s of n.listeners)s.bu(t)&&(r=!0)})),r&&Oa(n)}(r.eventManager,t),e.length&&r.sc.Wo(e),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}async function eu(e,t,n){const r=b(e);r.sharedClientState.updateQueryState(t,"rejected",n);const s=r.cc.get(t),i=s&&s.key;if(i){let e=new St($.comparator);e=e.insert(i,Vt.newNoDocument(i,P.min()));const n=tr().add(i),s=new sr(P.min(),new Map,new Dt(F),e,n);await Za(r,s),r.uc=r.uc.remove(i),r.cc.delete(t),cu(r)}else await bo(r.localStore,t,!1).then((()=>iu(r,t,n))).catch(ne)}async function tu(e,t){const n=b(e),r=t.batch.batchId;try{const e=await function(e,t){const n=b(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(e=>{const r=t.batch.keys(),s=n.Gi.newChangeBuffer({trackRemovals:!0});return function(e,t,n,r){const s=n.batch,i=s.keys();let o=re.resolve();return i.forEach((e=>{o=o.next((()=>r.getEntry(t,e))).next((t=>{const i=n.docVersions.get(e);v(null!==i),t.version.compareTo(i)<0&&(s.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))}))})),o.next((()=>e.mutationQueue.removeMutationBatch(t,s)))}(n,e,t,s).next((()=>s.apply(e))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=tr();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t)))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(n.localStore,t);su(n,r,null),ru(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await lu(n,e)}catch(e){await ne(e)}}async function nu(e,t,n){const r=b(e);try{const e=await function(e,t){const n=b(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",(e=>{let r;return n.mutationQueue.lookupMutationBatch(e,t).next((t=>(v(null!==t),r=t.keys(),n.mutationQueue.removeMutationBatch(e,t)))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,r))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(r.localStore,t);su(r,t,n),ru(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await lu(r,e)}catch(n){await ne(n)}}function ru(e,t){(e.lc.get(t)||[]).forEach((e=>{e.resolve()})),e.lc.delete(t)}function su(e,t,n){const r=b(e);let s=r.hc[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.hc[r.currentUser.toKey()]=s}}function iu(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e.rc.get(t))e.ic.delete(r),n&&e.sc.wc(r,n);e.rc.delete(t),e.isPrimaryClient&&e.ac.ls(t).forEach((t=>{e.ac.containsKey(t)||ou(e,t)}))}function ou(e,t){e.oc.delete(t.path.canonicalString());const n=e.uc.get(t);null!==n&&(ta(e.remoteStore,n),e.uc=e.uc.remove(t),e.cc.delete(n),cu(e))}function au(e,t,n){for(const r of n)r instanceof Ga?(e.ac.addReference(r.key,t),uu(e,r)):r instanceof $a?(m("SyncEngine","Document no longer in limbo: "+r.key),e.ac.removeReference(r.key,t),e.ac.containsKey(r.key)||ou(e,r.key)):w()}function uu(e,t){const n=t.key,r=n.path.canonicalString();e.uc.get(n)||e.oc.has(r)||(m("SyncEngine","New document in limbo: "+n),e.oc.add(r),cu(e))}function cu(e){for(;e.oc.size>0&&e.uc.size<e.maxConcurrentLimboResolutions;){const t=e.oc.values().next().value;e.oc.delete(t);const n=new $(B.fromString(t)),r=e.fc.next();e.cc.set(r,new za(n)),e.uc=e.uc.insert(n,r),ea(e.remoteStore,new Es(Yt($t(n.path)),r,2,ge.at))}}async function lu(e,t,n){const r=b(e),s=[],i=[],o=[];r.ic.isEmpty()||(r.ic.forEach(((e,a)=>{o.push(r._c(a,t,n).then((e=>{if((e||n)&&r.isPrimaryClient&&r.sharedClientState.updateQueryState(a.targetId,(null==e?void 0:e.fromCache)?"not-current":"current"),e){s.push(e);const t=ho.Ci(a.targetId,e);i.push(t)}})))})),await Promise.all(o),r.sc.Wo(s),await async function(e,t){const n=b(e);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(e=>re.forEach(t,(t=>re.forEach(t.Si,(r=>n.persistence.referenceDelegate.addReference(e,t.targetId,r))).next((()=>re.forEach(t.Di,(r=>n.persistence.referenceDelegate.removeReference(e,t.targetId,r)))))))))}catch(e){if(!ue(e))throw e;m("LocalStore","Failed to update sequence numbers: "+e)}for(const r of t){const e=r.targetId;if(!r.fromCache){const t=n.qi.get(e),r=t.snapshotVersion,s=t.withLastLimboFreeSnapshotVersion(r);n.qi=n.qi.insert(e,s)}}}(r.localStore,i))}async function hu(e,t){const n=b(e);if(!n.currentUser.isEqual(t)){m("SyncEngine","User change. New user:",t.toKey());const e=await po(n.localStore,t);n.currentUser=t,function(e,t){e.lc.forEach((e=>{e.forEach((e=>{e.reject(new E(T.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),e.lc.clear()}(n),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await lu(n,e.ji)}}function du(e,t){const n=b(e),r=n.cc.get(t);if(r&&r.nc)return tr().add(r.key);{let e=tr();const r=n.rc.get(t);if(!r)return e;for(const t of r){const r=n.ic.get(t);e=e.unionWith(r.view.ju)}return e}}async function fu(e,t){const n=b(e),r=await To(n.localStore,t.query,!0),s=t.view.tc(r);return n.isPrimaryClient&&au(n,t.targetId,s.Xu),s}async function mu(e,t){const n=b(e);return So(n.localStore,t).then((e=>lu(n,e)))}async function gu(e,t,n,r){const s=b(e),i=await function(e,t){const n=b(e),r=b(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",(e=>r.Tn(e,t).next((t=>t?n.localDocuments.getDocuments(e,t):re.resolve(null)))))}(s.localStore,t);null!==i?("pending"===n?await fa(s.remoteStore):"acknowledged"===n||"rejected"===n?(su(s,t,r||null),ru(s,t),function(e,t){b(b(e).mutationQueue).An(t)}(s.localStore,t)):w(),await lu(s,i)):m("SyncEngine","Cannot apply mutation batch with id: "+t)}async function pu(e,t,n){const r=b(e),s=[],i=[];for(const o of t){let e;const t=r.rc.get(o);if(t&&0!==t.length){e=await Io(r.localStore,Yt(t[0]));for(const e of t){const t=r.ic.get(e),n=await fu(r,t);n.snapshot&&i.push(n.snapshot)}}else{const t=await Eo(r.localStore,o);e=await Io(r.localStore,t),await Ya(r,yu(t),o,!1,e.resumeToken)}s.push(e)}return r.sc.Wo(i),s}function yu(e){return Gt(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function wu(e){const t=b(e);return b(b(t.localStore).persistence).vi()}async function vu(e,t,n,r){const s=b(e);if(s.dc)return void m("SyncEngine","Ignoring unexpected query state notification.");const i=s.rc.get(t);if(i&&i.length>0)switch(n){case"current":case"not-current":{const e=await So(s.localStore,rn(i[0])),r=sr.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,xe.EMPTY_BYTE_STRING);await lu(s,e,r);break}case"rejected":await bo(s.localStore,t,!0),iu(s,t,r);break;default:w()}}async function Iu(e,t,n){const r=bu(e);if(r.dc){for(const e of t){if(r.rc.has(e)){m("SyncEngine","Adding an already active target "+e);continue}const t=await Eo(r.localStore,e),n=await Io(r.localStore,t);await Ya(r,yu(t),n.targetId,!1,n.resumeToken),ea(r.remoteStore,n)}for(const e of n)r.rc.has(e)&&await bo(r.localStore,e,!1).then((()=>{ta(r.remoteStore,e),iu(r,e)})).catch(ne)}}function bu(e){const t=b(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=Za.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=du.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=eu.bind(null,t),t.sc.Wo=Fa.bind(null,t.eventManager),t.sc.wc=La.bind(null,t.eventManager),t}function Tu(e){const t=b(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=tu.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=nu.bind(null,t),t}class Eu{constructor(){this.synchronizeTabs=!1}async initialize(e){this.yt=$o(e.databaseInfo.databaseId),this.sharedClientState=this.gc(e),this.persistence=this.yc(e),await this.persistence.start(),this.localStore=this.Ic(e),this.gcScheduler=this.Tc(e,this.localStore),this.indexBackfillerScheduler=this.Ec(e,this.localStore)}Tc(e,t){return null}Ec(e,t){return null}Ic(e){return go(this.persistence,new fo,e.initialUser,this.yt)}yc(e){return new to(ro.Bs,this.yt)}gc(e){return new Lo}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class Su extends Eu{constructor(e,t,n){super(),this.Ac=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Ac.initialize(this,e),await Tu(this.Ac.syncEngine),await fa(this.Ac.remoteStore),await this.persistence.li((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}Ic(e){return go(this.persistence,new fo,e.initialUser,this.yt)}Tc(e,t){const n=this.persistence.referenceDelegate.garbageCollector;return new Ri(n,e.asyncQueue,t)}Ec(e,t){const n=new me(t,this.persistence);return new fe(e.asyncQueue,n)}yc(e){const t=lo(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?yi.withCacheSize(this.cacheSizeBytes):yi.DEFAULT;return new ao(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,Ko(),Go(),this.yt,this.sharedClientState,!!this.forceOwnership)}gc(e){return new Lo}}class xu extends Su{constructor(e,t){super(e,t,!1),this.Ac=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);const t=this.Ac.syncEngine;this.sharedClientState instanceof Fo&&(this.sharedClientState.syncEngine={Fr:gu.bind(null,t),$r:vu.bind(null,t),Br:Iu.bind(null,t),vi:wu.bind(null,t),Mr:mu.bind(null,t)},await this.sharedClientState.start()),await this.persistence.li((async e=>{await async function(e,t){const n=b(e);if(bu(n),Tu(n),!0===t&&!0!==n.dc){const e=n.sharedClientState.getAllActiveQueryTargets(),t=await pu(n,e.toArray());n.dc=!0,await Ea(n.remoteStore,!0);for(const r of t)ea(n.remoteStore,r)}else if(!1===t&&!1!==n.dc){const e=[];let t=Promise.resolve();n.rc.forEach(((r,s)=>{n.sharedClientState.isLocalQueryTarget(s)?e.push(s):t=t.then((()=>(iu(n,s),bo(n.localStore,s,!0)))),ta(n.remoteStore,s)})),await t,await pu(n,e),function(e){const t=b(e);t.cc.forEach(((e,n)=>{ta(t.remoteStore,n)})),t.ac.fs(),t.cc=new Map,t.uc=new St($.comparator)}(n),n.dc=!1,await Ea(n.remoteStore,!1)}}(this.Ac.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())}))}gc(e){const t=Ko();if(!Fo.C(t))throw new E(T.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=lo(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new Fo(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class _u{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Ja(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=hu.bind(null,this.syncEngine),await Ea(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new Ra}createDatastore(e){const t=$o(e.databaseInfo.databaseId),n=(r=e.databaseInfo,new Bo(r));var r;return function(e,t,n,r){return new Ho(e,t,n,r)}(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,s=e=>Ja(this.syncEngine,e,0),i=qo.C()?new qo:new Oo,new Xo(t,n,r,s,i);var t,n,r,s,i}createSyncEngine(e,t){return function(e,t,n,r,s,i,o){const a=new Wa(e,t,n,r,s,i);return o&&(a.dc=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return async function(e){const t=b(e);m("RemoteStore","RemoteStore shutting down."),t._u.add(5),await Jo(t),t.mu.shutdown(),t.gu.set("Unknown")}(this.remoteStore)}}function Du(e,t,n){if(!n)throw new E(T.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Nu(e,t,n,r){if(!0===t&&!0===r)throw new E(T.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function Cu(e){if(!$.isDocumentKey(e))throw new E(T.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function ku(e){if($.isDocumentKey(e))throw new E(T.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function Au(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{const t=function(e){return e.constructor?e.constructor.name:null}(e);return t?`a custom ${t} object`:"an object"}}return"function"==typeof e?"a function":w()}function Ru(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new E(T.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=Au(e);throw new E(T.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function Vu(e,t){if(t<=0)throw new E(T.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}const Mu=new Map;class Fu{constructor(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new E(T.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new E(T.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.useFetchStreams=!!e.useFetchStreams,Nu("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling)}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class Lu{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Fu({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new E(T.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new E(T.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Fu(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new _;switch(e.type){case"gapi":const t=e.client;return new k(t,e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new E(T.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=Mu.get(e);t&&(m("ComponentProvider","Removing Datastore"),Mu.delete(e),t.terminate())}(this),Promise.resolve()}}function Ou(e,t,n,r={}){var s;const i=(e=Ru(e,Lu))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==t&&p("Host has been set in both settings() and useEmulator(), emulator host will be used"),e._setSettings(Object.assign(Object.assign({},i),{host:`${t}:${n}`,ssl:!1})),r.mockUserToken){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=c.MOCK_USER;else{t=Object(o.g)(r.mockUserToken,null===(s=e._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new E(T.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new c(i)}e._authCredentials=new D(new x(t,n))}}class qu{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Uu(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new qu(this.firestore,e,this._key)}}class Pu{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new Pu(this.firestore,e,this._query)}}class Uu extends Pu{constructor(e,t,n){super(e,t,$t(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new qu(this.firestore,null,new $(e))}withConverter(e){return new Uu(this.firestore,e,this._path)}}function Bu(e,t,...n){if(e=Object(o.p)(e),Du("collection","path",t),e instanceof Lu){const r=B.fromString(t,...n);return ku(r),new Uu(e,null,r)}{if(!(e instanceof qu||e instanceof Uu))throw new E(T.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(B.fromString(t,...n));return ku(r),new Uu(e.firestore,null,r)}}function Ku(e,t){if(e=Ru(e,Lu),Du("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new E(T.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Pu(e,null,function(e){return new Kt(B.emptyPath(),e)}(t))}function Gu(e,t,...n){if(e=Object(o.p)(e),1===arguments.length&&(t=M.R()),Du("doc","path",t),e instanceof Lu){const r=B.fromString(t,...n);return Cu(r),new qu(e,null,new $(r))}{if(!(e instanceof qu||e instanceof Uu))throw new E(T.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(B.fromString(t,...n));return Cu(r),new qu(e.firestore,e instanceof Uu?e.converter:null,new $(r))}}function $u(e,t){return e=Object(o.p)(e),t=Object(o.p)(t),(e instanceof qu||e instanceof Uu)&&(t instanceof qu||t instanceof Uu)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function ju(e,t){return e=Object(o.p)(e),t=Object(o.p)(t),e instanceof Pu&&t instanceof Pu&&e.firestore===t.firestore&&Jt(e._query,t._query)&&e.converter===t.converter}function Qu(e,t=10240){let n=0;return{async read(){if(n<e.byteLength){const r={value:e.slice(n,n+t),done:!1};return n+=t,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class zu{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Rc(this.observer.next,e)}error(e){this.observer.error?this.Rc(this.observer.error,e):g("Uncaught Error in snapshot listener:",e.toString())}bc(){this.muted=!0}Rc(e,t){this.muted||setTimeout((()=>{this.muted||e(t)}),0)}}class Wu{constructor(e,t){this.Pc=e,this.yt=t,this.metadata=new S,this.buffer=new Uint8Array,this.vc=new TextDecoder("utf-8"),this.Vc().then((e=>{e&&e.Ou()?this.metadata.resolve(e.ku.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.ku)}`))}),(e=>this.metadata.reject(e)))}close(){return this.Pc.cancel()}async getMetadata(){return this.metadata.promise}async mc(){return await this.getMetadata(),this.Vc()}async Vc(){const e=await this.Sc();if(null===e)return null;const t=this.vc.decode(e),n=Number(t);isNaN(n)&&this.Dc(`length string (${t}) is not valid number`);const r=await this.Cc(n);return new Pa(JSON.parse(r),e.length+n)}xc(){return this.buffer.findIndex((e=>e==="{".charCodeAt(0)))}async Sc(){for(;this.xc()<0&&!(await this.Nc()););if(0===this.buffer.length)return null;const e=this.xc();e<0&&this.Dc("Reached the end of bundle when a length string is expected.");const t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async Cc(e){for(;this.buffer.length<e;)await this.Nc()&&this.Dc("Reached the end of bundle when more is expected.");const t=this.vc.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}Dc(e){throw this.Pc.cancel(),new Error(`Invalid bundle format: ${e}`)}async Nc(){const e=await this.Pc.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class Hu{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new E(T.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const t=await async function(e,t){const n=b(e),r=Dr(n.yt)+"/documents",s={documents:t.map((e=>Er(n.yt,e)))},i=await n._o("BatchGetDocuments",r,s,t.length),o=new Map;i.forEach((e=>{const t=function(e,t){return"found"in t?function(e,t){v(!!t.found),t.found.name,t.found.updateTime;const n=Sr(e,t.found.name),r=Ir(t.found.updateTime),s=t.found.createTime?Ir(t.found.createTime):P.min(),i=new At({mapValue:{fields:t.found.fields}});return Vt.newFoundDocument(n,r,s,i)}(e,t):"missing"in t?function(e,t){v(!!t.missing),v(!!t.readTime);const n=Sr(e,t.missing),r=Ir(t.readTime);return Vt.newNoDocument(n,r)}(e,t):w()}(n.yt,e);o.set(t.key.toString(),t)}));const a=[];return t.forEach((e=>{const t=o.get(e.toString());v(!!t),a.push(t)})),a}(this.datastore,e);return t.forEach((e=>this.recordVersion(e))),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new On(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const e=this.readVersions;this.mutations.forEach((t=>{e.delete(t.key.toString())})),e.forEach(((e,t)=>{const n=$.fromPath(t);this.mutations.push(new qn(n,this.precondition(n)))})),await async function(e,t){const n=b(e),r=Dr(n.yt)+"/documents",s={writes:t.map((e=>Ar(n.yt,e)))};await n.ao("Commit",r,s)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw w();t=P.min()}const n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new E(T.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(P.min())?Sn.exists(!1):Sn.updateTime(t):Sn.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(P.min()))throw new E(T.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Sn.updateTime(t)}return Sn.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class Yu{constructor(e,t,n,r,s){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=s,this.kc=n.maxAttempts,this.xo=new jo(this.asyncQueue,"transaction_retry")}run(){this.kc-=1,this.Oc()}Oc(){this.xo.Ro((async()=>{const e=new Hu(this.datastore),t=this.Mc(e);t&&t.then((t=>{this.asyncQueue.enqueueAndForget((()=>e.commit().then((()=>{this.deferred.resolve(t)})).catch((e=>{this.Fc(e)}))))})).catch((e=>{this.Fc(e)}))}))}Mc(e){try{const t=this.updateFunction(e);return!be(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}Fc(e){this.kc>0&&this.$c(e)?(this.kc-=1,this.asyncQueue.enqueueAndForget((()=>(this.Oc(),Promise.resolve())))):this.deferred.reject(e)}$c(e){if("FirebaseError"===e.name){const t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!Kn(t)}return!1}}class Xu{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=c.UNAUTHENTICATED,this.clientId=M.R(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async e=>{m("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e})),this.appCheckCredentials.start(n,(e=>(m("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user))))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new E(T.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const e=new S;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){const n=Da(t,"Failed to shutdown persistence");e.reject(n)}})),e.promise}}async function Zu(e,t){e.asyncQueue.verifyOperationInProgress(),m("FirestoreClient","Initializing OfflineComponentProvider");const n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener((async e=>{r.isEqual(e)||(await po(t.localStore,e),r=e)})),t.persistence.setDatabaseDeletedListener((()=>e.terminate())),e.offlineComponents=t}async function Ju(e,t){e.asyncQueue.verifyOperationInProgress();const n=await ec(e);m("FirestoreClient","Initializing OnlineComponentProvider");const r=await e.getConfiguration();await t.initialize(n,r),e.setCredentialChangeListener((e=>Ta(t.remoteStore,e))),e.setAppCheckTokenChangeListener(((e,n)=>Ta(t.remoteStore,n))),e.onlineComponents=t}async function ec(e){return e.offlineComponents||(m("FirestoreClient","Using default OfflineComponentProvider"),await Zu(e,new Eu)),e.offlineComponents}async function tc(e){return e.onlineComponents||(m("FirestoreClient","Using default OnlineComponentProvider"),await Ju(e,new _u)),e.onlineComponents}function nc(e){return ec(e).then((e=>e.persistence))}function rc(e){return ec(e).then((e=>e.localStore))}function sc(e){return tc(e).then((e=>e.remoteStore))}function ic(e){return tc(e).then((e=>e.syncEngine))}function oc(e){return tc(e).then((e=>e.datastore))}async function ac(e){const t=await tc(e),n=t.eventManager;return n.onListen=Ha.bind(null,t.syncEngine),n.onUnlisten=Xa.bind(null,t.syncEngine),n}function uc(e,t,n={}){const r=new S;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,s){const i=new zu({next:i=>{t.enqueueAndForget((()=>Ma(e,o)));const a=i.docs.has(n);!a&&i.fromCache?s.reject(new E(T.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&r&&"server"===r.source?s.reject(new E(T.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):s.resolve(i)},error:e=>s.reject(e)}),o=new qa($t(n.path),i,{includeMetadataChanges:!0,Nu:!0});return Va(e,o)}(await ac(e),e.asyncQueue,t,n,r))),r.promise}function cc(e,t,n={}){const r=new S;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,s){const i=new zu({next:n=>{t.enqueueAndForget((()=>Ma(e,o))),n.fromCache&&"server"===r.source?s.reject(new E(T.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(n)},error:e=>s.reject(e)}),o=new qa(n,i,{includeMetadataChanges:!0,Nu:!0});return Va(e,o)}(await ac(e),e.asyncQueue,t,n,r))),r.promise}function lc(e,t,n,r){const s=function(e,t){let n;return n="string"==typeof e?(new TextEncoder).encode(e):e,function(e,t){return new Wu(e,t)}(function(e,t){if(e instanceof Uint8Array)return Qu(e,t);if(e instanceof ArrayBuffer)return Qu(new Uint8Array(e),t);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),t)}(n,$o(t));e.asyncQueue.enqueueAndForget((async()=>{!function(e,t,n){const r=b(e);(async function(e,t,n){try{const r=await t.getMetadata();if(await function(e,t){const n=b(e),r=Ir(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(e=>n.Ns.getBundleMetadata(e,t.id))).then((e=>!!e&&e.createTime.compareTo(r)>=0))}(e.localStore,r))return await t.close(),n._completeWith(function(e){return{taskState:"Success",documentsLoaded:e.totalDocuments,bytesLoaded:e.totalBytes,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}(r)),Promise.resolve(new Set);n._updateProgress(Ka(r));const s=new Ba(r,e.localStore,t.yt);let i=await t.mc();for(;i;){const e=await s.Fu(i);e&&n._updateProgress(e),i=await t.mc()}const o=await s.complete();return await lu(e,o.Lu,void 0),await function(e,t){const n=b(e);return n.persistence.runTransaction("Save bundle","readwrite",(e=>n.Ns.saveBundleMetadata(e,t)))}(e.localStore,r),n._completeWith(o.progress),Promise.resolve(o.Bu)}catch(e){return p("SyncEngine",`Loading bundle failed with ${e}`),n._failWith(e),Promise.resolve(new Set)}})(r,t,n).then((e=>{r.sharedClientState.notifyBundleLoaded(e)}))}(await ic(e),s,r)}))}class hc{constructor(){this.Bc=Promise.resolve(),this.Lc=[],this.qc=!1,this.Uc=[],this.Kc=null,this.Gc=!1,this.Qc=!1,this.jc=[],this.xo=new jo(this,"async_queue_retry"),this.Wc=()=>{const e=Go();e&&m("AsyncQueue","Visibility state changed to "+e.visibilityState),this.xo.Po()};const e=Go();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.Wc)}get isShuttingDown(){return this.qc}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.zc(),this.Hc(e)}enterRestrictedMode(e){if(!this.qc){this.qc=!0,this.Qc=e||!1;const t=Go();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Wc)}}enqueue(e){if(this.zc(),this.qc)return new Promise((()=>{}));const t=new S;return this.Hc((()=>this.qc&&this.Qc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise))).then((()=>t.promise))}enqueueRetryable(e){this.enqueueAndForget((()=>(this.Lc.push(e),this.Jc())))}async Jc(){if(0!==this.Lc.length){try{await this.Lc[0](),this.Lc.shift(),this.xo.reset()}catch(e){if(!ue(e))throw e;m("AsyncQueue","Operation failed with retryable error: "+e)}this.Lc.length>0&&this.xo.Ro((()=>this.Jc()))}}Hc(e){const t=this.Bc.then((()=>(this.Gc=!0,e().catch((e=>{this.Kc=e,this.Gc=!1;throw g("INTERNAL UNHANDLED ERROR: ",function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e)),e})).then((e=>(this.Gc=!1,e))))));return this.Bc=t,t}enqueueAfterDelay(e,t,n){this.zc(),this.jc.indexOf(e)>-1&&(t=0);const r=_a.createAndSchedule(this,e,t,n,(e=>this.Yc(e)));return this.Uc.push(r),r}zc(){this.Kc&&w()}verifyOperationInProgress(){}async Xc(){let e;do{e=this.Bc,await e}while(e!==this.Bc)}Zc(e){for(const t of this.Uc)if(t.timerId===e)return!0;return!1}ta(e){return this.Xc().then((()=>{this.Uc.sort(((e,t)=>e.targetTimeMs-t.targetTimeMs));for(const t of this.Uc)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.Xc()}))}ea(e){this.jc.push(e)}Yc(e){const t=this.Uc.indexOf(e);this.Uc.splice(t,1)}}function dc(e){return function(e,t){if("object"!=typeof e||null===e)return!1;const n=e;for(const r of["next","error","complete"])if(r in n&&"function"==typeof n[r])return!0;return!1}(e)}class fc{constructor(){this._progressObserver={},this._taskCompletionResolver=new S,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}const mc=-1;class gc extends Lu{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new hc,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||yc(this),this._firestoreClient.terminate()}}function pc(e){return e._firestoreClient||yc(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function yc(e){var t;const n=e._freezeSettings(),r=function(e,t,n,r){return new pe(e,t,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,r.useFetchStreams)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,n);e._firestoreClient=new Xu(e._authCredentials,e._appCheckCredentials,e._queue,r)}function wc(e,t){Dc(e=Ru(e,gc));const n=pc(e),r=e._freezeSettings(),s=new _u;return Ic(n,s,new Su(s,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))}function vc(e){Dc(e=Ru(e,gc));const t=pc(e),n=e._freezeSettings(),r=new _u;return Ic(t,r,new xu(r,n.cacheSizeBytes))}function Ic(e,t,n){const r=new S;return e.asyncQueue.enqueue((async()=>{try{await Zu(e,n),await Ju(e,t),r.resolve()}catch(e){const n=e;if(!function(e){return"FirebaseError"===e.name?e.code===T.FAILED_PRECONDITION||e.code===T.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||(22===e.code||20===e.code||11===e.code)}(n))throw n;p("Error enabling offline persistence. Falling back to persistence disabled: "+n),r.reject(n)}})).then((()=>r.promise))}function bc(e){if(e._initialized&&!e._terminated)throw new E(T.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new S;return e._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(e){if(!ie.C())return Promise.resolve();const t=e+"main";await ie.delete(t)}(lo(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}})),t.promise}function Tc(e){return function(e){const t=new S;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t){const n=b(e);oa(n.remoteStore)||m("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(e){const t=b(e);return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e)))}(n.localStore);if(-1===e)return void t.resolve();const r=n.lc.get(e)||[];r.push(t),n.lc.set(e,r)}catch(e){const n=Da(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await ic(e),t))),t.promise}(pc(e=Ru(e,gc)))}function Ec(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await nc(e),n=await sc(e);return t.setNetworkEnabled(!0),function(e){const t=b(e);return t._u.delete(0),Zo(t)}(n)}))}(pc(e=Ru(e,gc)))}function Sc(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await nc(e),n=await sc(e);return t.setNetworkEnabled(!1),async function(e){const t=b(e);t._u.add(0),await Jo(t),t.gu.set("Offline")}(n)}))}(pc(e=Ru(e,gc)))}function xc(e,t){const n=pc(e=Ru(e,gc)),r=new fc;return lc(n,e._databaseId,t,r),r}function _c(e,t){return function(e,t){return e.asyncQueue.enqueue((async()=>function(e,t){const n=b(e);return n.persistence.runTransaction("Get named query","readonly",(e=>n.Ns.getNamedQuery(e,t)))}(await rc(e),t)))}(pc(e=Ru(e,gc)),t).then((t=>t?new Pu(e,null,t.query):null))}function Dc(e){if(e._initialized||e._terminated)throw new E(T.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class Nc{constructor(e){this._byteString=e}static fromBase64String(e){try{return new Nc(xe.fromBase64String(e))}catch(e){throw new E(T.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new Nc(xe.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class Cc{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new E(T.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new G(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class kc{constructor(e){this._methodName=e}}class Ac{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new E(T.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new E(T.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return F(this._lat,e._lat)||F(this._long,e._long)}}const Rc=/^__.*__$/;class Vc{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new Vn(e,this.data,this.fieldMask,t,this.fieldTransforms):new Rn(e,this.data,t,this.fieldTransforms)}}class Mc{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new Vn(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function Fc(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw w()}}class Lc{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.yt=n,this.ignoreUndefinedProperties=r,void 0===s&&this.na(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get sa(){return this.settings.sa}ia(e){return new Lc(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.yt,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}ra(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.ia({path:n,oa:!1});return r.ua(e),r}ca(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.ia({path:n,oa:!1});return r.na(),r}aa(e){return this.ia({path:void 0,oa:!0})}ha(e){return nl(e,this.settings.methodName,this.settings.la||!1,this.path,this.settings.fa)}contains(e){return void 0!==this.fieldMask.find((t=>e.isPrefixOf(t)))||void 0!==this.fieldTransforms.find((t=>e.isPrefixOf(t.field)))}na(){if(this.path)for(let e=0;e<this.path.length;e++)this.ua(this.path.get(e))}ua(e){if(0===e.length)throw this.ha("Document fields must not be empty");if(Fc(this.sa)&&Rc.test(e))throw this.ha('Document fields cannot begin and end with "__"')}}class Oc{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.yt=n||$o(e)}da(e,t,n,r=!1){return new Lc({sa:e,methodName:t,fa:n,path:G.emptyPath(),oa:!1,la:r},this.databaseId,this.yt,this.ignoreUndefinedProperties)}}function qc(e){const t=e._freezeSettings(),n=$o(e._databaseId);return new Oc(e._databaseId,!!t.ignoreUndefinedProperties,n)}function Pc(e,t,n,r,s,i={}){const o=e.da(i.merge||i.mergeFields?2:0,t,n,s);Zc("Data must be an object, but it was:",o,r);const a=Yc(r,o);let u,c;if(i.merge)u=new kt(o.fieldMask),c=o.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=Jc(t,r,n);if(!o.contains(s))throw new E(T.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);rl(e,s)||e.push(s)}u=new kt(e),c=o.fieldTransforms.filter((e=>u.covers(e.field)))}else u=null,c=o.fieldTransforms;return new Vc(new At(a),u,c)}class Uc extends kc{_toFieldTransform(e){if(2!==e.sa)throw 1===e.sa?e.ha(`${this._methodName}() can only appear at the top level of your update data`):e.ha(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof Uc}}function Bc(e,t,n){return new Lc({sa:3,fa:t.settings.fa,methodName:e._methodName,oa:n},t.databaseId,t.yt,t.ignoreUndefinedProperties)}class Kc extends kc{_toFieldTransform(e){return new Tn(e.path,new mn)}isEqual(e){return e instanceof Kc}}class Gc extends kc{constructor(e,t){super(e),this._a=t}_toFieldTransform(e){const t=Bc(this,e,!0),n=this._a.map((e=>Hc(e,t))),r=new gn(n);return new Tn(e.path,r)}isEqual(e){return this===e}}class $c extends kc{constructor(e,t){super(e),this._a=t}_toFieldTransform(e){const t=Bc(this,e,!0),n=this._a.map((e=>Hc(e,t))),r=new yn(n);return new Tn(e.path,r)}isEqual(e){return this===e}}class jc extends kc{constructor(e,t){super(e),this.wa=t}_toFieldTransform(e){const t=new vn(e.yt,cn(e.yt,this.wa));return new Tn(e.path,t)}isEqual(e){return this===e}}function Qc(e,t,n,r){const s=e.da(1,t,n);Zc("Data must be an object, but it was:",s,r);const i=[],a=At.empty();ve(r,((e,r)=>{const u=tl(t,e,n);r=Object(o.p)(r);const c=s.ca(u);if(r instanceof Uc)i.push(u);else{const e=Hc(r,c);null!=e&&(i.push(u),a.set(u,e))}}));const u=new kt(i);return new Mc(a,u,s.fieldTransforms)}function zc(e,t,n,r,s,i){const a=e.da(1,t,n),u=[Jc(t,r,n)],c=[s];if(i.length%2!=0)throw new E(T.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let o=0;o<i.length;o+=2)u.push(Jc(t,i[o])),c.push(i[o+1]);const l=[],h=At.empty();for(let f=u.length-1;f>=0;--f)if(!rl(l,u[f])){const e=u[f];let t=c[f];t=Object(o.p)(t);const n=a.ca(e);if(t instanceof Uc)l.push(e);else{const r=Hc(t,n);null!=r&&(l.push(e),h.set(e,r))}}const d=new kt(l);return new Mc(h,d,a.fieldTransforms)}function Wc(e,t,n,r=!1){return Hc(n,e.da(r?4:3,t))}function Hc(e,t){if(Xc(e=Object(o.p)(e)))return Zc("Unsupported field value:",t,e),Yc(e,t);if(e instanceof kc)return function(e,t){if(!Fc(t.sa))throw t.ha(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.ha(`${e._methodName}() is not currently supported inside arrays`);const n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.oa&&4!==t.sa)throw t.ha("Nested arrays are not supported");return function(e,t){const n=[];let r=0;for(const s of e){let e=Hc(s,t.aa(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=Object(o.p)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return cn(t.yt,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){const n=q.fromDate(e);return{timestampValue:yr(t.yt,n)}}if(e instanceof q){const n=new q(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:yr(t.yt,n)}}if(e instanceof Ac)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof Nc)return{bytesValue:wr(t.yt,e._byteString)};if(e instanceof qu){const n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.ha(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:br(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.ha(`Unsupported field value: ${Au(e)}`)}(e,t)}function Yc(e,t){const n={};return Ie(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):ve(e,((e,r)=>{const s=Hc(r,t.ra(e));null!=s&&(n[e]=s)})),{mapValue:{fields:n}}}function Xc(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof q||e instanceof Ac||e instanceof Nc||e instanceof qu||e instanceof kc)}function Zc(e,t,n){if(!Xc(n)||!function(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){const r=Au(n);throw"an object"===r?t.ha(e+" a custom object"):t.ha(e+" "+r)}}function Jc(e,t,n){if((t=Object(o.p)(t))instanceof Cc)return t._internalPath;if("string"==typeof t)return tl(e,t);throw nl("Field path arguments must be of type string or ",e,!1,void 0,n)}const el=new RegExp("[~\\*/\\[\\]]");function tl(e,t,n){if(t.search(el)>=0)throw nl(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new Cc(...t.split("."))._internalPath}catch(r){throw nl(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function nl(e,t,n,r,s){const i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${t}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let u="";return(i||o)&&(u+=" (found",i&&(u+=` in field ${r}`),o&&(u+=` in document ${s}`),u+=")"),new E(T.INVALID_ARGUMENT,a+e+u)}function rl(e,t){return e.some((e=>e.isEqual(t)))}class sl{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new qu(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new il(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(ol("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class il extends sl{data(){return super.data()}}function ol(e,t){return"string"==typeof t?tl(e,t):t instanceof Cc?t._internalPath:t._delegate._internalPath}function al(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new E(T.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class ul{}class cl extends ul{}function ll(e,t,...n){let r=[];t instanceof ul&&r.push(t),r=r.concat(n),function(e){const t=e.filter((e=>e instanceof fl)).length,n=e.filter((e=>e instanceof hl)).length;if(t>1||t>0&&n>0)throw new E(T.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const s of r)e=s._apply(e);return e}class hl extends cl{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new hl(e,t,n)}_apply(e){const t=this._parse(e);return Nl(e._query,t),new Pu(e.firestore,e.converter,Xt(e._query,t))}_parse(e){const t=qc(e.firestore);return function(e,t,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new E(T.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){Dl(o,i);const t=[];for(const n of o)t.push(_l(r,e,n));a={arrayValue:{values:t}}}else a=_l(r,e,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||Dl(o,i),a=Wc(n,"where",o,"in"===i||"not-in"===i);return st.create(s,i,a)}(e._query,0,t,e.firestore._databaseId,this._field,this._op,this._value)}}function dl(e,t,n){const r=t,s=ol("where",e);return hl._create(s,r,n)}class fl extends ul{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new fl(e,t)}_parse(e){const t=this._queryConstraints.map((t=>t._parse(e))).filter((e=>e.getFilters().length>0));return 1===t.length?t[0]:it.create(t,this._getOperator())}_apply(e){const t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;const r=t.getFlattenedFilters();for(const s of r)Nl(n,s),n=Xt(n,s)}(e._query,t),new Pu(e.firestore,e.converter,Xt(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class ml extends cl{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new ml(e,t)}_apply(e){const t=function(e,t,n){if(null!==e.startAt)throw new E(T.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new E(T.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const r=new Tt(t,n);return function(e,t){if(null===Qt(e)){const n=zt(e);null!==n&&Cl(e,n,t.field)}}(e,r),r}(e._query,this._field,this._direction);return new Pu(e.firestore,e.converter,function(e,t){const n=e.explicitOrderBy.concat([t]);return new Kt(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}function gl(e,t="asc"){const n=t,r=ol("orderBy",e);return ml._create(r,n)}class pl extends cl{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new pl(e,t,n)}_apply(e){return new Pu(e.firestore,e.converter,Zt(e._query,this._limit,this._limitType))}}function yl(e){return Vu("limit",e),pl._create("limit",e,"F")}function wl(e){return Vu("limitToLast",e),pl._create("limitToLast",e,"L")}class vl extends cl{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new vl(e,t,n)}_apply(e){const t=xl(e,this.type,this._docOrFields,this._inclusive);return new Pu(e.firestore,e.converter,function(e,t){return new Kt(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,t,e.endAt)}(e._query,t))}}function Il(...e){return vl._create("startAt",e,!0)}function bl(...e){return vl._create("startAfter",e,!1)}class Tl extends cl{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new Tl(e,t,n)}_apply(e){const t=xl(e,this.type,this._docOrFields,this._inclusive);return new Pu(e.firestore,e.converter,function(e,t){return new Kt(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,t)}(e._query,t))}}function El(...e){return Tl._create("endBefore",e,!1)}function Sl(...e){return Tl._create("endAt",e,!0)}function xl(e,t,n,r){if(n[0]=Object(o.p)(n[0]),n[0]instanceof sl)return function(e,t,n,r,s){if(!r)throw new E(T.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const o of Ht(e))if(o.field.isKeyField())i.push(Ke(t,r.key));else{const e=r.data.field(o.field);if(ke(e))throw new E(T.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+o.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=o.field.canonicalString();throw new E(T.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}i.push(e)}return new et(i,s)}(e._query,e.firestore._databaseId,t,n[0]._document,r);{const s=qc(e.firestore);return function(e,t,n,r,s,i){const o=e.explicitOrderBy;if(s.length>o.length)throw new E(T.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let u=0;u<s.length;u++){const i=s[u];if(o[u].field.isKeyField()){if("string"!=typeof i)throw new E(T.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof i}`);if(!Wt(e)&&-1!==i.indexOf("/"))throw new E(T.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${i}' contains a slash.`);const n=e.path.child(B.fromString(i));if(!$.isDocumentKey(n))throw new E(T.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new $(n);a.push(Ke(t,s))}else{const e=Wc(n,r,i);a.push(e)}}return new et(a,i)}(e._query,e.firestore._databaseId,s,t,n,r)}}function _l(e,t,n){if("string"==typeof(n=Object(o.p)(n))){if(""===n)throw new E(T.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Wt(t)&&-1!==n.indexOf("/"))throw new E(T.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=t.path.child(B.fromString(n));if(!$.isDocumentKey(r))throw new E(T.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Ke(e,new $(r))}if(n instanceof qu)return Ke(e,n._key);throw new E(T.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Au(n)}.`)}function Dl(e,t){if(!Array.isArray(e)||0===e.length)throw new E(T.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`);if(e.length>10)throw new E(T.INVALID_ARGUMENT,`Invalid Query. '${t.toString()}' filters support a maximum of 10 elements in the value array.`)}function Nl(e,t){if(t.isInequality()){const n=zt(e),r=t.field;if(null!==n&&!n.isEqual(r))throw new E(T.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${r.toString()}'`);const s=Qt(e);null!==s&&Cl(e,r,s)}const n=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new E(T.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new E(T.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}function Cl(e,t,n){if(!n.isEqual(t))throw new E(T.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class kl{convertValue(e,t="none"){switch(Fe(e)){case 0:return null;case 1:return e.booleanValue;case 2:return Ne(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(Ce(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw w()}}convertObject(e,t){const n={};return ve(e.fields,((e,r)=>{n[e]=this.convertValue(r,t)})),n}convertGeoPoint(e){return new Ac(Ne(e.latitude),Ne(e.longitude))}convertArray(e,t){return(e.values||[]).map((e=>this.convertValue(e,t)))}convertServerTimestamp(e,t){switch(t){case"previous":const n=Ae(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(Re(e));default:return null}}convertTimestamp(e){const t=De(e);return new q(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=B.fromString(e);v($r(n));const r=new ye(n.get(1),n.get(3)),s=new $(n.popFirst(5));return r.isEqual(t)||g(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function Al(e,t,n){let r;return r=e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t,r}class Rl extends kl{constructor(e){super(),this.firestore=e}convertBytes(e){return new Nc(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new qu(this.firestore,null,t)}}class Vl{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Ml extends sl{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new Fl(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(ol("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class Fl extends Ml{data(e={}){return super.data(e)}}class Ll{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new Vl(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const e=[];return this.forEach((t=>e.push(t))),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach((n=>{e.call(t,new Fl(this._firestore,this._userDataWriter,n.key,n,new Vl(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new E(T.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map((n=>{const r=new Fl(e._firestore,e._userDataWriter,n.doc.key,n.doc,new Vl(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}}))}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter((e=>t||3!==e.type)).map((t=>{const r=new Fl(e._firestore,e._userDataWriter,t.doc.key,t.doc,new Vl(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);let s=-1,i=-1;return 0!==t.type&&(s=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(n=n.add(t.doc),i=n.indexOf(t.doc.key)),{type:Ol(t.type),doc:r,oldIndex:s,newIndex:i}}))}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function Ol(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return w()}}function ql(e,t){return e instanceof Ml&&t instanceof Ml?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof Ll&&t instanceof Ll&&e._firestore===t._firestore&&ju(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}function Pl(e){e=Ru(e,qu);const t=Ru(e.firestore,gc);return uc(pc(t),e._key).then((n=>Jl(t,e,n)))}class Ul extends kl{constructor(e){super(),this.firestore=e}convertBytes(e){return new Nc(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new qu(this.firestore,null,t)}}function Bl(e){e=Ru(e,qu);const t=Ru(e.firestore,gc),n=pc(t),r=new Ul(t);return function(e,t){const n=new S;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await function(e,t){const n=b(e);return n.persistence.runTransaction("read document","readonly",(e=>n.localDocuments.getDocument(e,t)))}(e,t);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new E(T.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){const r=Da(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await rc(e),t,n))),n.promise}(n,e._key).then((n=>new Ml(t,r,e._key,n,new Vl(null!==n&&n.hasLocalMutations,!0),e.converter)))}function Kl(e){e=Ru(e,qu);const t=Ru(e.firestore,gc);return uc(pc(t),e._key,{source:"server"}).then((n=>Jl(t,e,n)))}function Gl(e){e=Ru(e,Pu);const t=Ru(e.firestore,gc),n=pc(t),r=new Ul(t);return al(e._query),cc(n,e._query).then((n=>new Ll(t,r,e,n)))}function $l(e){e=Ru(e,Pu);const t=Ru(e.firestore,gc),n=pc(t),r=new Ul(t);return function(e,t){const n=new S;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await To(e,t,!0),s=new ja(t,r.Hi),i=s.Wu(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(e){const r=Da(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await rc(e),t,n))),n.promise}(n,e._query).then((n=>new Ll(t,r,e,n)))}function jl(e){e=Ru(e,Pu);const t=Ru(e.firestore,gc),n=pc(t),r=new Ul(t);return cc(n,e._query,{source:"server"}).then((n=>new Ll(t,r,e,n)))}function Ql(e,t,n){e=Ru(e,qu);const r=Ru(e.firestore,gc),s=Al(e.converter,t,n);return Zl(r,[Pc(qc(r),"setDoc",e._key,s,null!==e.converter,n).toMutation(e._key,Sn.none())])}function zl(e,t,n,...r){e=Ru(e,qu);const s=Ru(e.firestore,gc),i=qc(s);let a;return a="string"==typeof(t=Object(o.p)(t))||t instanceof Cc?zc(i,"updateDoc",e._key,t,n,r):Qc(i,"updateDoc",e._key,t),Zl(s,[a.toMutation(e._key,Sn.exists(!0))])}function Wl(e){return Zl(Ru(e.firestore,gc),[new On(e._key,Sn.none())])}function Hl(e,t){const n=Ru(e.firestore,gc),r=Gu(e),s=Al(e.converter,t);return Zl(n,[Pc(qc(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,Sn.exists(!1))]).then((()=>r))}function Yl(e,...t){var n,r,s;e=Object(o.p)(e);let i={includeMetadataChanges:!1},a=0;"object"!=typeof t[a]||dc(t[a])||(i=t[a],a++);const u={includeMetadataChanges:i.includeMetadataChanges};if(dc(t[a])){const e=t[a];t[a]=null===(n=e.next)||void 0===n?void 0:n.bind(e),t[a+1]=null===(r=e.error)||void 0===r?void 0:r.bind(e),t[a+2]=null===(s=e.complete)||void 0===s?void 0:s.bind(e)}let c,l,h;if(e instanceof qu)l=Ru(e.firestore,gc),h=$t(e._key.path),c={next:n=>{t[a]&&t[a](Jl(l,e,n))},error:t[a+1],complete:t[a+2]};else{const n=Ru(e,Pu);l=Ru(n.firestore,gc),h=n._query;const r=new Ul(l);c={next:e=>{t[a]&&t[a](new Ll(l,r,n,e))},error:t[a+1],complete:t[a+2]},al(e._query)}return function(e,t,n,r){const s=new zu(r),i=new qa(t,s,n);return e.asyncQueue.enqueueAndForget((async()=>Va(await ac(e),i))),()=>{s.bc(),e.asyncQueue.enqueueAndForget((async()=>Ma(await ac(e),i)))}}(pc(l),h,u,c)}function Xl(e,t){return function(e,t){const n=new zu(t);return e.asyncQueue.enqueueAndForget((async()=>function(e,t){b(e).Ru.add(t),t.next()}(await ac(e),n))),()=>{n.bc(),e.asyncQueue.enqueueAndForget((async()=>function(e,t){b(e).Ru.delete(t)}(await ac(e),n)))}}(pc(e=Ru(e,gc)),dc(t)?t:{next:t})}function Zl(e,t){return function(e,t){const n=new S;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){const r=Tu(e);try{const e=await function(e,t){const n=b(e),r=q.now(),s=t.reduce(((e,t)=>e.add(t.key)),tr());let i,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(e=>{let a=Qn(),u=tr();return n.Gi.getEntries(e,s).next((e=>{a=e,a.forEach(((e,t)=>{t.isValidDocument()||(u=u.add(e))}))})).next((()=>n.localDocuments.getOverlayedDocuments(e,a))).next((s=>{i=s;const o=[];for(const e of t){const t=kn(e,i.get(e.key).overlayedDocument);null!=t&&o.push(new Vn(e.key,t,Rt(t.value.mapValue),Sn.exists(!0)))}return n.mutationQueue.addMutationBatch(e,r,o,t)})).next((t=>{o=t;const r=t.applyToLocalDocumentSet(i,u);return n.documentOverlayCache.saveOverlays(e,t.batchId,r)}))})).then((()=>({batchId:o.batchId,changes:Hn(i)})))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.hc[e.currentUser.toKey()];r||(r=new St(F)),r=r.insert(t,n),e.hc[e.currentUser.toKey()]=r}(r,e.batchId,n),await lu(r,e.changes),await fa(r.remoteStore)}catch(e){const t=Da(e,"Failed to persist write");n.reject(t)}}(await ic(e),t,n))),n.promise}(pc(e),t)}function Jl(e,t,n){const r=n.docs.get(t._key),s=new Ul(e);return new Ml(e,s,t._key,r,new Vl(n.hasPendingWrites,n.fromCache),t.converter)}const eh={maxAttempts:5};class th{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=qc(e)}set(e,t,n){this._verifyNotCommitted();const r=nh(e,this._firestore),s=Al(r.converter,t,n),i=Pc(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,Sn.none())),this}update(e,t,n,...r){this._verifyNotCommitted();const s=nh(e,this._firestore);let i;return i="string"==typeof(t=Object(o.p)(t))||t instanceof Cc?zc(this._dataReader,"WriteBatch.update",s._key,t,n,r):Qc(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,Sn.exists(!0))),this}delete(e){this._verifyNotCommitted();const t=nh(e,this._firestore);return this._mutations=this._mutations.concat(new On(t._key,Sn.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new E(T.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function nh(e,t){if((e=Object(o.p)(e)).firestore!==t)throw new E(T.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class rh extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=qc(e)}get(e){const t=nh(e,this._firestore),n=new Rl(this._firestore);return this._transaction.lookup([t._key]).then((e=>{if(!e||1!==e.length)return w();const r=e[0];if(r.isFoundDocument())return new sl(this._firestore,n,r.key,r,t.converter);if(r.isNoDocument())return new sl(this._firestore,n,t._key,null,t.converter);throw w()}))}set(e,t,n){const r=nh(e,this._firestore),s=Al(r.converter,t,n),i=Pc(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(e,t,n,...r){const s=nh(e,this._firestore);let i;return i="string"==typeof(t=Object(o.p)(t))||t instanceof Cc?zc(this._dataReader,"Transaction.update",s._key,t,n,r):Qc(this._dataReader,"Transaction.update",s._key,t),this._transaction.update(s._key,i),this}delete(e){const t=nh(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=nh(e,this._firestore),n=new Ul(this._firestore);return super.get(e).then((e=>new Ml(this._firestore,n,t._key,e._document,new Vl(!1,!1),t.converter)))}}function sh(e,t,n){e=Ru(e,gc);const r=Object.assign(Object.assign({},eh),n);return function(e){if(e.maxAttempts<1)throw new E(T.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(e,t,n){const r=new S;return e.asyncQueue.enqueueAndForget((async()=>{const s=await oc(e);new Yu(e.asyncQueue,s,n,t,r).run()})),r.promise}(pc(e),(n=>t(new rh(e,n))),r)}function ih(){return new Uc("deleteField")}function oh(){return new Kc("serverTimestamp")}function ah(...e){return new Gc("arrayUnion",e)}function uh(...e){return new $c("arrayRemove",e)}function ch(e){return new jc("increment",e)}!function(e,t=!0){!function(e){l=e}(r.SDK_VERSION),Object(r._registerComponent)(new s.a("firestore",((e,{instanceIdentifier:n,options:r})=>{const s=e.getProvider("app").getImmediate(),i=new gc(new N(e.getProvider("auth-internal")),new R(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new E(T.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new ye(e.options.projectId,t)}(s,n),s);return r=Object.assign({useFetchStreams:t},r),i._setSettings(r),i}),"PUBLIC").setMultipleInstances(!0)),Object(r.registerVersion)(u,"3.8.3",e),Object(r.registerVersion)(u,"3.8.3","esm2017")}()}).call(this,n("8oxB"))}}]);